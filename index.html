<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FF6B35">
    <title>SISTEMA PAE DIGITAL - INVENTARIO SIMPLE</title>
    
    <!-- Favicon PAE Digital -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.svg">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        /* Variables CSS para el esquema de colores de la Alcaldía de Envigado */
        :root {
            --primary-color: #FF6B35; /* Naranja principal */
            --secondary-color: #4CAF50; /* Verde principal */
            --accent-color: #FF8C42; /* Naranja secundario */
            --success-color: #45B649; /* Verde éxito */
            --warning-color: #FFA726; /* Naranja advertencia */
            --info-color: #66BB6A; /* Verde información */
            --light-bg: #F8F9FA;
            --dark-bg: #2E7D32;
            --text-primary: #2E2E2E;
            --text-secondary: #666666;
            --border-color: #E0E0E0;
            --shadow-light: 0 2px 10px rgba(255, 107, 53, 0.1);
            --shadow-medium: 0 4px 20px rgba(76, 175, 80, 0.15);
            --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
            --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
            --gradient-secondary: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            --gradient-success: linear-gradient(135deg, #45B649 0%, #4CAF50 100%);
            --gradient-warm: linear-gradient(135deg, #FF6B35 0%, #FFA726 100%);
            --gradient-cool: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
        }

        /* Reset y estilos base mejorados */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fff8f0 0%, #f0f8f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header mejorado con gradiente naranja-verde y sombras */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            text-align: center;
            padding: 40px 20px 50px 20px;
            box-shadow: var(--shadow-heavy);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        /* Estilos para el header principal */
        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0;
            margin: 0 auto;
            padding: 0 20px;
            max-width: 1000px;
            position: relative;
            z-index: 2;
        }

        /* Estilos para la sección del título */
        .title-section {
            text-align: center;
            flex: 1;
            margin: 0 40px;
        }

        .title-section h1 {
            margin-bottom: 10px;
            font-size: 2.8rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .header-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Logos mejorados con efectos profesionales */
        .logo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .logo-item:hover {
            transform: translateY(-5px);
        }

        .logo-item img {
            height: 90px;
            width: auto;
            object-fit: contain;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .logo-item:hover img {
            box-shadow: var(--shadow-heavy);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .logo-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        /* Contenedor principal con diseño moderno */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        /* Navegación mejorada */
        .nav-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-button {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .nav-button:hover::before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .nav-button.active {
            background: var(--gradient-warm);
            box-shadow: var(--shadow-medium);
        }

        /* Secciones de contenido con diseño profesional */
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .section h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--secondary-color);
            position: relative;
        }

        .section h2::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--primary-color);
        }

        /* Formularios mejorados */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            transform: translateY(-1px);
        }

        .form-control:hover {
            border-color: var(--secondary-color);
        }

        /* Botones mejorados */
        .btn {
            background: var(--gradient-secondary); /* Gradiente verde */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary {
            background: var(--gradient-warm); /* Gradiente naranja */
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF6B35, #FF8C42); /* Gradiente naranja intenso */
        }

        /* Tablas mejoradas */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: var(--gradient-cool); /* Gradiente verde para encabezados */
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        tr:hover td {
            background-color: var(--light-bg);
        }

        /* Estados y prioridades mejorados */
        .estado-urgente {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); /* Naranja intenso */
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estado-pronto {
            background: linear-gradient(135deg, var(--warning-color), var(--accent-color)); /* Naranja cálido */
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estado-atencion {
            background: linear-gradient(135deg, var(--info-color), var(--secondary-color)); /* Verde azulado */
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estado-sin-vencimiento {
            background: linear-gradient(135deg, var(--success-color), var(--secondary-color)); /* Verde éxito */
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Alertas y mensajes mejorados */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert-warning {
            background: rgba(255, 167, 38, 0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .alert-danger {
            background: rgba(255, 107, 53, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .alert-info {
            background: rgba(102, 187, 106, 0.1);
            border-color: var(--info-color);
            color: var(--info-color);
        }

        /* Estilos para la sección de restablecer inventario */
        .info-adicional {
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .info-adicional h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .info-adicional ul {
            margin: 0;
            padding-left: 20px;
        }

        .info-adicional li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .info-adicional li:last-child {
            margin-bottom: 0;
        }

        /* Estilos específicos para el botón de restablecer */
        .boton-menu.restablecer {
            background: var(--gradient-warm);
            border: 2px solid var(--primary-color);
        }

        .boton-menu.restablecer:hover {
            background: var(--gradient-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        /* Estilos para el campo de clave */
        #clave-restablecer {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            text-align: center;
            font-weight: bold;
        }

        #clave-restablecer:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .header-main {
                flex-direction: row; /* Mantener disposición horizontal */
                gap: 15px; /* Reducir gap para móvil */
                margin-bottom: 25px;
                max-width: 600px;
                padding: 0 15px;
            }

            .title-section {
                margin: 0 20px; /* Reducir márgenes */
                order: 0; /* Mantener orden original */
            }

            .title-section h1 {
                font-size: 2rem; /* Tamaño intermedio */
            }

            .logo-item img {
                height: 70px; /* Tamaño intermedio */
                padding: 10px;
            }

            .nav-menu {
                gap: 15px;
            }

            .nav-button {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .section h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .header-main {
                flex-direction: row; /* Mantener disposición horizontal */
                gap: 10px; /* Gap más pequeño para móviles muy pequeños */
                margin-bottom: 20px;
                padding: 0 10px;
                max-width: 400px;
            }

            .title-section {
                margin: 0 15px; /* Márgenes más pequeños */
                order: 0; /* Mantener orden original */
            }

            .title-section h1 {
                font-size: 1.6rem; /* Tamaño más pequeño pero legible */
            }

            .logo-item img {
                height: 60px; /* Tamaño más pequeño */
                padding: 8px;
            }

            .nav-menu {
                gap: 10px;
            }

            .nav-button {
                padding: 10px 16px;
                font-size: 0.8rem;
            }

            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .section h2 {
                font-size: 1.3rem;
            }
        }

        /* Animaciones y transiciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Efectos de hover para elementos interactivos */
        .form-control:hover,
        .btn:hover,
        .nav-button:hover {
            transform: translateY(-2px);
        }

        /* Estilos para elementos específicos del sistema */
        .stock-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stock-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
        }

        .stock-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        /* Estilos para el reporte */
        .reporte-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .reporte-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--secondary-color);
        }

        .reporte-title {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .reporte-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Estilos para filtros */
        .filtros-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filtro-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filtro-item label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Estilos para botones de acción */
        .acciones-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-exportar {
            background: var(--gradient-success);
        }

        .btn-limpiar {
            background: var(--gradient-secondary);
        }

        .btn-imprimir {
            background: var(--gradient-warm);
        }

        /* Estilos para estadísticas */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--gradient-warm);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow-medium);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Estilos para el historial */
        .historial-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .historial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .historial-title {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Estilos para movimientos */
        .movimiento-item {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }

        .movimiento-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-light);
        }

        .movimiento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .movimiento-tipo {
            background: var(--gradient-secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .movimiento-fecha {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .movimiento-detalles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .detalle-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detalle-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detalle-valor {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Estilos para lotes */
        .lote-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .lote-resultado {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent-color);
        }

        .lote-sede {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .lote-sede h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        /* Estilos para stock */
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stock-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stock-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
        }

        .stock-producto {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .stock-lotes {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stock-lote {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--info-color);
        }

        .stock-lote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stock-lote-numero {
            font-weight: 600;
            color: var(--primary-color);
        }

        .stock-lote-cantidad {
            background: var(--gradient-success);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stock-lote-sede {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stock-lote-vencimiento {
            margin-top: 8px;
            font-size: 0.8rem;
        }

        /* Estilos para el reporte mensual */
        .reporte-mensual-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .mes-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .mes-input {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .mes-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Estilos para el botón de prueba */
        .btn-prueba {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-prueba:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Estilos para SweetAlert2 personalizados */
        .swal2-popup {
            border-radius: 20px !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .swal2-title {
            color: var(--primary-color) !important;
            font-weight: 700 !important;
        }

        .swal2-confirm {
            background: var(--gradient-success) !important;
            border-radius: 25px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .swal2-cancel {
            background: var(--gradient-secondary) !important;
            border-radius: 25px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        /* Estilos para scrollbars personalizados */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-secondary);
        }

        /* Estilos para focus visible */
        .form-control:focus-visible,
        .btn:focus-visible,
        .nav-button:focus-visible {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Estilos para elementos deshabilitados */
        .form-control:disabled,
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Estilos para tooltips */
        [title] {
            position: relative;
            cursor: help;
        }

        /* Estilos para elementos de carga */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--light-bg);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos para notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient-success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--gradient-secondary);
        }

        .notification.warning {
            background: var(--gradient-secondary);
        }

        .notification.info {
            background: var(--gradient-primary);
        }

        /* RESTAURAR CLASES CSS ORIGINALES NECESARIAS */
        
        /* MENÚ PRINCIPAL SIMPLE */
        .menu-principal {
            padding: 30px 20px;
            text-align: center;
        }

        .menu-botones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .boton-menu {
            background: var(--gradient-warm); /* Gradiente naranja cálido */
            color: white;
            border: none;
            padding: 25px 20px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .boton-menu:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .boton-menu.entrada {
            background: var(--gradient-success);
        }

        .boton-menu.salida {
            background: var(--gradient-secondary);
        }

        .boton-menu.devolucion {
            background: var(--gradient-warm);
        }

        .boton-menu.ver-stock {
            background: var(--gradient-cool);
        }

        .boton-menu.ver-historial {
            background: var(--gradient-warm);
        }

        .boton-menu.reporte {
            background: var(--gradient-secondary);
        }

        .icono-boton {
            font-size: 2em;
        }

        /* SECCIONES OCULTAS */
        .seccion {
            display: none;
            padding: 20px;
        }

        .seccion.activa {
            display: block;
        }

        /* FORMULARIOS SIMPLIFICADOS */
        .formulario-simple {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            max-width: 600px;
            margin: 0 auto;
            box-shadow: var(--shadow-light);
        }

        .formulario-simple h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8em;
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 15px;
        }

        .campo-formulario {
            margin-bottom: 20px;
        }

        .campo-formulario label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1em;
        }

        .campo-formulario input,
        .campo-formulario select,
        .campo-formulario textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .campo-formulario input:focus,
        .campo-formulario select:focus,
        .campo-formulario textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            transform: scale(1.5);
        }

        .checkbox-container label {
            margin-bottom: 0;
            font-weight: 500;
        }

        /* BOTONES DE ACCIÓN */
        .botones-accion {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .boton-accion {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .boton-accion.principal {
            background: var(--gradient-success);
            color: white;
        }

        .boton-accion.secundario {
            background: var(--gradient-cool);
            color: white;
        }

        .boton-accion.peligro {
            background: var(--gradient-warm);
            color: white;
        }

        .boton-accion:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* BOTÓN VOLVER */
        .boton-volver {
            background: var(--gradient-cool);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .boton-volver:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* TABLA DE STOCK SIMPLIFICADA */
        .tabla-stock {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .tabla-stock th,
        .tabla-stock td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .tabla-stock th {
            background: var(--gradient-cool);
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .tabla-stock tr:hover {
            background: var(--light-bg);
        }

        /* FILTROS SIMPLES */
        .filtros-simples {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .filtros-simples select {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            margin: 0 10px;
            min-width: 150px;
        }

        .campo-busqueda {
            position: relative;
            display: inline-block;
            margin: 0 10px;
        }

        .campo-busqueda input {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            min-width: 200px;
            background: white;
        }

        .campo-busqueda input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .boton-limpiar-filtro {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .boton-limpiar-filtro:hover {
            background: var(--accent-color);
            transform: translateY(-50%) scale(1.1);
        }

        .campo-busqueda input {
            padding-right: 35px; /* Espacio para el botón */
        }

        .info-filtros {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            border-left: 4px solid var(--success-color);
        }

        .detalles-movimiento {
            max-width: 300px;
            line-height: 1.4;
            font-size: 0.9em;
        }

        .detalles-movimiento br {
            margin-bottom: 2px;
        }

        /* Estilos para resaltar información importante en salidas */
        .tabla-stock tr:hover .detalles-movimiento {
            background: rgba(76, 175, 80, 0.05);
            border-radius: 4px;
            padding: 4px;
        }

        .descripcion-funcion {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 20px;
            text-align: center;
        }

        .resultado-header {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }

        .resultado-header h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        #info-busqueda-lotes {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .lote-sede-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
        }

        .lote-sede-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .lote-sede-sede {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 1.1em;
        }

        .lote-sede-cantidad {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .lote-sede-detalles {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }

        .lote-sede-detalle {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lote-sede-detalle .icono {
            font-size: 1.2em;
        }

        /* Estilos para la sección de stock */
        .stock-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }

        .stock-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }

        .stock-producto {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stock-cantidad {
            background: var(--secondary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .stock-sede {
            color: var(--secondary-color);
            font-weight: 600;
            font-size: 1.1em;
        }

        .stock-lotes {
            margin-top: 15px;
        }

        .stock-lotes-titulo {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lote-item {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .lote-item:last-child {
            margin-bottom: 0;
        }

        .lote-numero {
            font-weight: bold;
            color: var(--primary-color);
        }

        .lote-cantidad {
            text-align: center;
            font-weight: 600;
        }

        .lote-vencimiento {
            text-align: center;
        }

        .lote-prioridad {
            text-align: center;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .prioridad-urgente {
            background: #f8d7da;
            color: #721c24;
        }

        .prioridad-pronto {
            background: #fff3cd;
            color: #856404;
        }

        .prioridad-atencion {
            background: #d1ecf1;
            color: #0c5460;
        }

        .prioridad-sin-vencimiento {
            background: #e2e3e5;
            color: #383d41;
        }

        .stock-sin-lotes {
            background: var(--light-bg);
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* MENSAJES DE ESTADO */
        .mensaje-estado {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }

        .mensaje-exito {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .mensaje-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .mensaje-info {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        /* SISTEMA DE AUTOCOMPLETADO */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .sugerencias-lista {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--secondary-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow-medium);
            display: none;
        }

        .sugerencia-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .sugerencia-item:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        .sugerencia-item:last-child {
            border-bottom: none;
        }

        .sugerencia-item.seleccionada {
            background: var(--secondary-color);
            color: white;
        }

        .sugerencia-categoria {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* INDICADOR DE CONEXIÓN */
        .indicador-conexion {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow-medium);
        }

        .conectado {
            background: var(--success-color);
            color: white;
        }

        .desconectado {
            background: var(--primary-color);
            color: white;
        }

        /* ESTILOS PARA ALERTAS DE VENCIMIENTO */
        .alerta-vencimiento-popup {
            font-family: 'Segoe UI', sans-serif;
        }

        .alerta-vencimiento-popup .swal2-title {
            color: var(--primary-color);
            font-weight: 700;
        }

        .alerta-vencimiento-popup .swal2-html-container {
            text-align: left;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .alerta-vencimiento-popup .swal2-html-container strong {
            color: var(--primary-color);
        }

        .alerta-vencimiento-popup .swal2-html-container .urgente {
            color: var(--primary-color);
            font-weight: 700;
        }

        .alerta-vencimiento-popup .swal2-html-container .pronto {
            color: var(--warning-color);
            font-weight: 700;
        }

        .alerta-vencimiento-popup .swal2-html-container .atencion {
            color: var(--success-color);
            font-weight: 700;
        }

        /* ESTILOS PARA REPORTE DIARIO */
        .reporte-header {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
        }

        .reporte-header h3 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.5em;
        }

        .reporte-header p {
            color: var(--text-secondary);
            margin: 0;
            text-align: center;
            font-size: 1.1em;
        }

        .reporte-footer {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid var(--border-color);
        }

        .estado-reporte {
            margin-bottom: 20px;
        }

        .estado-reporte label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .checkbox-estado {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-estado input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .checkbox-estado label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .observaciones label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .observaciones textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }

        .tabla-reporte {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .tabla-reporte th,
        .tabla-reporte td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .tabla-reporte th {
            background: var(--secondary-color);
            color: white;
        }

        .tabla-reporte tr:hover {
            background: var(--light-bg);
        }

        .tabla-reporte tr:last-child td {
            border-bottom: none;
        }

        /* ESTILOS PARA SELECTOR DE INSTITUCIÓN */
        #institucion-reporte {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        #institucion-reporte:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        #institucion-reporte option {
            padding: 8px;
            font-size: 14px;
        }

        /* Estilos para botón de exportar a Excel */
        .boton-accion.secundario[onclick*="exportarReporteExcel"] {
            background: var(--gradient-success);
            border-color: var(--success-color);
        }

        .boton-accion.secundario[onclick*="exportarReporteExcel"]:hover {
            background: linear-gradient(135deg, #45B649 0%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        /* ESTILOS PARA REPORTE AGRUPADO POR SEDES */
        .sede-grupo {
            margin-bottom: 30px;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }

        .sede-titulo {
            background: var(--gradient-warm);
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .sede-resumen {
            background: var(--light-bg);
            margin: 0;
            padding: 10px 20px;
            color: var(--text-secondary);
            font-size: 0.95em;
            border-bottom: 1px solid var(--border-color);
        }

        .estado-recepcion {
            min-width: 200px;
        }

        .estado-opciones {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .estado-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .estado-radio input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .cantidad-recibida {
            margin-top: 10px;
            padding: 8px;
            background: var(--light-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .cantidad-recibida label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .cantidad-recibida input[type="number"] {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* ESTILOS PARA ESTADOS DE RECEPCIÓN */
        .estado-llego {
            background: rgba(76, 175, 80, 0.1) !important;
            border-left: 4px solid var(--success-color);
        }

        .estado-no-llego {
            background: rgba(255, 107, 53, 0.1) !important;
            border-left: 4px solid var(--primary-color);
        }

        .estado-parcial {
            background: rgba(255, 167, 38, 0.1) !important;
            border-left: 4px solid var(--warning-color);
        }

        .cantidad-cell {
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
        }

        @media print {
            .boton-volver, .botones-accion, .estado-reporte, .observaciones {
                display: none !important;
            }
            
            .reporte-header, .reporte-footer {
                border: 1px solid #000;
            }
            
            .tabla-reporte {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            .tabla-reporte th {
                background: #ccc !important;
                color: #000 !important;
            }
            
            .sede-titulo {
                background: #ccc !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .estado-llego {
                background: rgba(76, 175, 80, 0.1) !important;
                border-left: 4px solid var(--success-color) !important;
            }
            
            .estado-no-llego {
                background: rgba(255, 107, 53, 0.1) !important;
                border-left: 4px solid var(--primary-color) !important;
            }
            
            .estado-parcial {
                background: rgba(255, 167, 38, 0.1) !important;
                border-left: 4px solid var(--warning-color) !important;
            }
            
            body {
                font-size: 12px;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .menu-botones {
                grid-template-columns: 1fr;
            }
            
            .botones-accion {
                flex-direction: column;
            }
            
            .boton-accion {
                width: 100%;
            }
            
            .filtros-simples select {
                margin: 5px;
                width: calc(50% - 10px);
            }
        }

        .alert-info {
            background: rgba(102, 187, 106, 0.1);
            border-color: var(--info-color);
            color: var(--info-color);
        }

        /* Estilos para la sección de restablecer inventario */
        .info-adicional {
            background: rgba(255, 107, 53, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .info-adicional h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .info-adicional ul {
            margin: 0;
            padding-left: 20px;
        }

        .info-adicional li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .info-adicional li:last-child {
            margin-bottom: 0;
        }

        /* Estilos específicos para el botón de restablecer */
        .boton-menu.restablecer {
            background: var(--gradient-warm);
            border: 2px solid var(--primary-color);
        }

        .boton-menu.restablecer:hover {
            background: var(--gradient-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        /* Estilos para el campo de clave */
        #clave-restablecer {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            text-align: center;
            font-weight: bold;
        }

        #clave-restablecer:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <div class="header-main">
                <div class="logo-item">
                    <img src="img/logo cis .jpg" alt="Logo CIS" title="Centro de Innovación Social">
                    <div class="logo-label">CIS</div>
                </div>
                <div class="title-section">
                    <h1> SISTEMA PAE DIGITAL</h1>
                    <p class="header-subtitle">Control de Inventario Simple</p>
                </div>
                <div class="logo-item">
                    <img src="img/alcaldia .png" alt="Logo Alcaldía" title="Alcaldía Municipal">
                    <div class="logo-label">ALCALDÍA</div>
                </div>
            </div>
        </header>
        
        <!-- MENÚ PRINCIPAL -->
        <div id="menu-principal" class="menu-principal">
            <div class="menu-botones">
                <button class="boton-menu entrada" onclick="mostrarSeccion('entrada')">
                    <span class="icono-boton">📥</span>
                    <span>ENTRADA DE PRODUCTOS</span>
                </button>
                
                <button class="boton-menu salida" onclick="mostrarSeccion('salida')">
                    <span class="icono-boton">📤</span>
                    <span>SALIDA DE PRODUCTOS</span>
                </button>
                
                <button class="boton-menu devolucion" onclick="mostrarSeccion('devolucion')">
                    <span class="icono-boton">↩️</span>
                    <span>DEVOLUCIÓN</span>
                </button>
                
                <button class="boton-menu ver-stock" onclick="mostrarSeccion('stock')">
                    <span class="icono-boton">📊</span>
                    <span>VER STOCK</span>
                </button>
                
                <button class="boton-menu ver-historial" onclick="mostrarSeccion('historial')">
                    <span class="icono-boton">📋</span>
                    <span>VER HISTORIAL</span>
                </button>
                
                <button class="boton-menu reporte" onclick="mostrarSeccion('reporte')">
                    <span class="icono-boton">📄</span>
                    <span>REPORTE MENSUAL</span>
                </button>
                
                <button class="boton-menu buscar-lotes" onclick="mostrarSeccion('buscar-lotes')">
                    <span class="icono-boton">🔍</span>
                    <span>BUSCAR LOTES</span>
                </button>
                
                <button class="boton-menu restablecer" onclick="mostrarSeccion('restablecer')">
                    <span class="icono-boton">🔄</span>
                    <span>RESTABLECER INVENTARIO</span>
                </button>
            </div>
        </div>
        
        <!-- SECCIÓN ENTRADA -->
        <div id="seccion-entrada" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>📥 ENTRADA DE PRODUCTOS</h2>
                
                <div class="campo-formulario">
                    <label for="producto-entrada">¿Qué producto estás recibiendo?</label>
                    <div class="autocomplete-container">
                        <input type="text" id="producto-entrada" placeholder="Escribe el nombre del producto...">
                        <div id="sugerencias-entrada" class="sugerencias-lista"></div>
                    </div>
                </div>
                
                <div class="campo-formulario">
                    <label for="cantidad-entrada">¿Cuántas unidades?</label>
                    <input type="number" id="cantidad-entrada" placeholder="Ejemplo: 10" min="1">
                </div>
                
                <div class="campo-formulario">
                    <label for="sede-entrada">¿En qué sede?</label>
                    <select id="sede-entrada">
                        <option value="">Selecciona una sede</option>
                        <option value="BODEGA CENTRAL">BODEGA CENTRAL</option>
                        <option value="IE Alejandro Vélez Barrientos">IE Alejandro Vélez Barrientos</option>
                        <option value="IE San Vicente Sede Alto las Flores">IE San Vicente Sede Alto las Flores</option>
                        <option value="IE Comercial de Envigado">IE Comercial de Envigado</option>
                        <option value="IE Comercial de Envigado Sede Pio XII">IE Comercial de Envigado Sede Pio XII</option>
                        <option value="IE Comercial de Envigado Sede San Rafael">IE Comercial de Envigado Sede San Rafael</option>
                        <option value="IE Darío de Bedout">IE Darío de Bedout</option>
                        <option value="IE El Salado">IE El Salado</option>
                        <option value="IE El Salado Sede La Morena">IE El Salado Sede La Morena</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR)">IE José Manuel Restrepo Vélez (JOMAR)</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                        <option value="IE José Miguel de la Calle">IE José Miguel de la Calle</option>
                        <option value="IE La Paz">IE La Paz</option>
                        <option value="IE La Paz Sede El Trianón">IE La Paz Sede El Trianón</option>
                        <option value="IE John F. Keneddy">IE John F. Keneddy</option>
                        <option value="IE Leticia Arango de Avendaño">IE Leticia Arango de Avendaño</option>
                        <option value="IE Las Palmas">IE Las Palmas</option>
                        <option value="IE Martín Eduardo Rios Llano (Pantanillo)">IE Martín Eduardo Rios Llano (Pantanillo)</option>
                        <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                        <option value="IE Manuel Uribe Ángel (MUA)">IE Manuel Uribe Ángel (MUA)</option>
                        <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                        <option value="IE Normal Superior de Envigado">IE Normal Superior de Envigado</option>
                        <option value="IE Marie Poussepin">IE Marie Poussepin</option>
                        <option value="Centro vida alto de los sueños">Centro vida alto de los sueños</option>
                        <option value="Comedor comunitario la Mina">Comedor comunitario la Mina</option>
                        <option value="Comedor Comunitario Uribe Angel">Comedor Comunitario Uribe Angel</option>
                        <option value="Comedor Comunitario Santa Gertrudis">Comedor Comunitario Santa Gertrudis</option>
                    </select>
                </div>
                
                <div class="campo-formulario">
                    <label for="descripcion-entrada">Descripción (opcional)</label>
                    <textarea id="descripcion-entrada" placeholder="Ejemplo: Arroz blanco de 1kg, marca X..."></textarea>
                </div>
                
                <div class="campo-formulario">
                    <label for="fecha-vencimiento-entrada">Fecha de vencimiento</label>
                    <input type="date" id="fecha-vencimiento-entrada">
                    <div class="checkbox-container">
                        <input type="checkbox" id="fecha-no-aplica-entrada">
                        <label for="fecha-no-aplica-entrada">No aplica (ej: verduras frescas)</label>
                    </div>
                </div>
                
                <div class="campo-formulario">
                    <label for="lote-entrada">Número de lote</label>
                    <input type="text" id="lote-entrada" placeholder="Ejemplo: LOTE-2024-001">
                    <div class="checkbox-container">
                        <input type="checkbox" id="lote-no-aplica-entrada">
                        <label for="lote-no-aplica-entrada">No aplica (ej: productos frescos)</label>
                    </div>
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="registrarEntrada()">✅ REGISTRAR ENTRADA</button>
                    <button class="boton-accion secundario" onclick="limpiarFormularioEntrada()">🧹 LIMPIAR</button>
                </div>
            </div>
        </div>
        
        <!-- SECCIÓN SALIDA -->
        <div id="seccion-salida" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>📤 SALIDA DE PRODUCTOS</h2>
                
                <div class="campo-formulario">
                    <label for="producto-salida">¿Qué producto estás sacando?</label>
                    <select id="producto-salida">
                        <option value="">Selecciona un producto del stock</option>
                    </select>
                    <button type="button" class="boton-accion secundario" onclick="verLotesDisponibles()" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; font-weight: 600;">
                        🔍 VER LOTES DISPONIBLES
                    </button>
                </div>
                
                <div class="campo-formulario">
                    <label for="cantidad-salida">¿Cuántas unidades?</label>
                    <input type="number" id="cantidad-salida" placeholder="Ejemplo: 5" min="1">
                </div>
                
                <div class="campo-formulario">
                    <label for="sede-salida">¿De qué sede?</label>
                    <select id="sede-salida" onchange="mostrarOcultarDestino()" onclick="mostrarOcultarDestino()">
                        <option value="">Selecciona una sede</option>
                        <option value="BODEGA CENTRAL">BODEGA CENTRAL</option>
                        <option value="IE Alejandro Vélez Barrientos">IE Alejandro Vélez Barrientos</option>
                        <option value="IE San Vicente Sede Alto las Flores">IE San Vicente Sede Alto las Flores</option>
                        <option value="IE Comercial de Envigado">IE Comercial de Envigado</option>
                        <option value="IE Comercial de Envigado Sede Pio XII">IE Comercial de Envigado Sede Pio XII</option>
                        <option value="IE Comercial de Envigado Sede San Rafael">IE Comercial de Envigado Sede San Rafael</option>
                        <option value="IE Darío de Bedout">IE Darío de Bedout</option>
                        <option value="IE El Salado">IE El Salado</option>
                        <option value="IE El Salado Sede La Morena">IE El Salado Sede La Morena</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR)">IE José Manuel Restrepo Vélez (JOMAR)</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                        <option value="IE José Miguel de la Calle">IE José Miguel de la Calle</option>
                        <option value="IE La Paz">IE La Paz</option>
                        <option value="IE La Paz Sede El Trianón">IE La Paz Sede El Trianón</option>
                        <option value="IE John F. Keneddy">IE John F. Keneddy</option>
                        <option value="IE Leticia Arango de Avendaño">IE Leticia Arango de Avendaño</option>
                        <option value="IE Las Palmas">IE Las Palmas</option>
                        <option value="IE Martín Eduardo Rios Llano (Pantanillo)">IE Martín Eduardo Rios Llano (Pantanillo)</option>
                        <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                        <option value="IE Manuel Uribe Ángel (MUA)">IE Manuel Uribe Ángel (MUA)</option>
                        <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                        <option value="IE Normal Superior de Envigado">IE Normal Superior de Envigado</option>
                        <option value="IE Marie Poussepin">IE Marie Poussepin</option>
                        <option value="Centro vida alto de los sueños">Centro vida alto de los sueños</option>
                        <option value="Comedor comunitario la Mina">Comedor comunitario la Mina</option>
                        <option value="Comedor Comunitario Uribe Angel">Comedor Comunitario Uribe Angel</option>
                        <option value="Comedor Comunitario Santa Gertrudis">Comedor Comunitario Santa Gertrudis</option>
                    </select>
                </div>
                
                <div class="campo-formulario" id="campo-destino" style="display: none;">
                    <label for="sede-destino">¿Para qué sede va?</label>
                    <select id="sede-destino">
                        <option value="">Selecciona la sede destino</option>
                        <option value="IE Alejandro Vélez Barrientos">IE Alejandro Vélez Barrientos</option>
                        <option value="IE San Vicente Sede Alto las Flores">IE San Vicente Sede Alto las Flores</option>
                        <option value="IE Comercial de Envigado">IE Comercial de Envigado</option>
                        <option value="IE Comercial de Envigado Sede Pio XII">IE Comercial de Envigado Sede Pio XII</option>
                        <option value="IE Comercial de Envigado Sede San Rafael">IE Comercial de Envigado Sede San Rafael</option>
                        <option value="IE Darío de Bedout">IE Darío de Bedout</option>
                        <option value="IE El Salado">IE El Salado</option>
                        <option value="IE El Salado Sede La Morena">IE El Salado Sede La Morena</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR)">IE José Manuel Restrepo Vélez (JOMAR)</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                        <option value="IE José Miguel de la Calle">IE José Miguel de la Calle</option>
                        <option value="IE La Paz">IE La Paz</option>
                        <option value="IE La Paz Sede El Trianón">IE La Paz Sede El Trianón</option>
                        <option value="IE John F. Keneddy">IE John F. Keneddy</option>
                        <option value="IE Leticia Arango de Avendaño">IE Leticia Arango de Avendaño</option>
                        <option value="IE Las Palmas">IE Las Palmas</option>
                        <option value="IE Martín Eduardo Rios Llano (Pantanillo)">IE Martín Eduardo Rios Llano (Pantanillo)</option>
                        <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                        <option value="IE Manuel Uribe Ángel (MUA)">IE Manuel Uribe Ángel (MUA)</option>
                        <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                        <option value="IE Normal Superior de Envigado">IE Normal Superior de Envigado</option>
                        <option value="IE Marie Poussepin">IE Marie Poussepin</option>
                        <option value="Centro vida alto de los sueños">Centro vida alto de los sueños</option>
                        <option value="Comedor comunitario la Mina">Comedor comunitario la Mina</option>
                        <option value="Comedor Comunitario Uribe Angel">Comedor Comunitario Uribe Angel</option>
                        <option value="Comedor Comunitario Santa Gertrudis">Comedor Comunitario Santa Gertrudis</option>
                    </select>
                </div>
                
                <div class="campo-formulario">
                    <label for="descripcion-salida">¿Para qué se usa? (opcional)</label>
                    <textarea id="descripcion-salida" placeholder="Ejemplo: Para almuerzo de hoy..."></textarea>
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="registrarSalida()">✅ REGISTRAR SALIDA</button>
                    <button class="boton-accion secundario" onclick="limpiarFormularioSalida()">🧹 LIMPIAR</button>
                    <button class="boton-accion secundario" onclick="probarSelectorDestino()" style="background: #ff9800;">🔧 PROBAR SELECTOR</button>
                </div>
            </div>
        </div>
        
        <!-- SECCIÓN DEVOLUCIÓN -->
        <div id="seccion-devolucion" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>↩️ DEVOLUCIÓN DE PRODUCTOS</h2>
                
                <div class="campo-formulario">
                    <label for="producto-devolucion">¿Qué producto estás devolviendo?</label>
                    <div class="autocomplete-container">
                        <input type="text" id="producto-devolucion" placeholder="Escribe el nombre del producto...">
                        <div id="sugerencias-devolucion" class="sugerencias-lista"></div>
                    </div>
                </div>
                
                <div class="campo-formulario">
                    <label for="cantidad-devolucion">¿Cuántas unidades?</label>
                    <input type="number" id="cantidad-devolucion" placeholder="Ejemplo: 2" min="1">
                </div>
                
                <div class="campo-formulario">
                    <label for="sede-devolucion">¿En qué sede?</label>
                    <select id="sede-devolucion">
                        <option value="">Selecciona una sede</option>
                        <option value="BODEGA CENTRAL">BODEGA CENTRAL</option>
                        <option value="IE Alejandro Vélez Barrientos">IE Alejandro Vélez Barrientos</option>
                        <option value="IE San Vicente Sede Alto las Flores">IE San Vicente Sede Alto las Flores</option>
                        <option value="IE Comercial de Envigado">IE Comercial de Envigado</option>
                        <option value="IE Comercial de Envigado Sede Pio XII">IE Comercial de Envigado Sede Pio XII</option>
                        <option value="IE Comercial de Envigado Sede San Rafael">IE Comercial de Envigado Sede San Rafael</option>
                        <option value="IE Darío de Bedout">IE Darío de Bedout</option>
                        <option value="IE El Salado">IE El Salado</option>
                        <option value="IE El Salado Sede La Morena">IE El Salado Sede La Morena</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR)">IE José Manuel Restrepo Vélez (JOMAR)</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                        <option value="IE José Miguel de la Calle">IE José Miguel de la Calle</option>
                        <option value="IE La Paz">IE La Paz</option>
                        <option value="IE La Paz Sede El Trianón">IE La Paz Sede El Trianón</option>
                        <option value="IE John F. Keneddy">IE John F. Keneddy</option>
                        <option value="IE Leticia Arango de Avendaño">IE Leticia Arango de Avendaño</option>
                        <option value="IE Las Palmas">IE Las Palmas</option>
                        <option value="IE Martín Eduardo Rios Llano (Pantanillo)">IE Martín Eduardo Rios Llano (Pantanillo)</option>
                        <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                        <option value="IE Manuel Uribe Ángel (MUA)">IE Manuel Uribe Ángel (MUA)</option>
                        <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                        <option value="IE Normal Superior de Envigado">IE Normal Superior de Envigado</option>
                        <option value="IE Marie Poussepin">IE Marie Poussepin</option>
                        <option value="Centro vida alto de los sueños">Centro vida alto de los sueños</option>
                        <option value="Comedor comunitario la Mina">Comedor comunitario la Mina</option>
                        <option value="Comedor Comunitario Uribe Angel">Comedor Comunitario Uribe Angel</option>
                        <option value="Comedor Comunitario Santa Gertrudis">Comedor Comunitario Santa Gertrudis</option>
                    </select>
                </div>
                
                <div class="campo-formulario">
                    <label for="motivo-devolucion">¿Por qué se devuelve?</label>
                    <textarea id="motivo-devolucion" placeholder="Ejemplo: Producto en mal estado, exceso de stock..."></textarea>
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="registrarDevolucion()">✅ REGISTRAR DEVOLUCIÓN</button>
                    <button class="boton-accion secundario" onclick="limpiarFormularioDevolucion()">🧹 LIMPIAR</button>
                </div>
            </div>
        </div>
        
        <!-- SECCIÓN STOCK -->
        <div id="seccion-stock" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>📊 INVENTARIO ACTUAL</h2>
                <p class="descripcion-funcion">Visualiza el stock actual de todos los productos con información detallada de lotes</p>
                
                <div class="filtros-simples">
                    <h3>🔍 FILTROS</h3>
                    
                    <div class="campo-busqueda">
                        <input type="text" id="filtro-producto-stock" placeholder="🔍 Buscar por producto..." oninput="filtrarStock()">
                        <button type="button" onclick="limpiarFiltroStock()" class="boton-limpiar-filtro" title="Limpiar filtro">🗑️</button>
                        <div id="sugerencias-producto-stock" class="sugerencias-lista" style="display: none;"></div>
                    </div>
                    
                    <select id="filtro-sede-stock" onchange="filtrarStock()">
                        <option value="">Todas las sedes</option>
                        <option value="BODEGA CENTRAL">BODEGA CENTRAL</option>
                        <option value="IE Alejandro Vélez Barrientos">IE Alejandro Vélez Barrientos</option>
                        <option value="IE San Vicente Sede Alto las Flores">IE San Vicente Sede Alto las Flores</option>
                        <option value="IE Comercial de Envigado">IE Comercial de Envigado</option>
                        <option value="IE Comercial de Envigado Sede Pio XII">IE Comercial de Envigado Sede Pio XII</option>
                        <option value="IE Comercial de Envigado Sede San Rafael">IE Comercial de Envigado Sede San Rafael</option>
                        <option value="IE Darío de Bedout">IE Darío de Bedout</option>
                        <option value="IE El Salado">IE El Salado</option>
                        <option value="IE El Salado Sede La Morena">IE El Salado Sede La Morena</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR)">IE José Manuel Restrepo Vélez (JOMAR)</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                        <option value="IE José Miguel de la Calle">IE José Miguel de la Calle</option>
                        <option value="IE La Paz">IE La Paz</option>
                        <option value="IE La Paz Sede El Trianón">IE La Paz Sede El Trianón</option>
                        <option value="IE John F. Keneddy">IE John F. Keneddy</option>
                        <option value="IE Leticia Arango de Avendaño">IE Leticia Arango de Avendaño</option>
                        <option value="IE Las Palmas">IE Las Palmas</option>
                        <option value="IE Martín Eduardo Rios Llano (Pantanillo)">IE Martín Eduardo Rios Llano (Pantanillo)</option>
                        <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                        <option value="IE Manuel Uribe Ángel (MUA)">IE Manuel Uribe Ángel (MUA)</option>
                        <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                        <option value="IE Normal Superior de Envigado">IE Normal Superior de Envigado</option>
                        <option value="IE Marie Poussepin">IE Marie Poussepin</option>
                        <option value="Centro vida alto de los sueños">Centro vida alto de los sueños</option>
                        <option value="Comedor comunitario la Mina">Comedor comunitario la Mina</option>
                        <option value="Comedor Comunitario Uribe Angel">Comedor Comunitario Uribe Angel</option>
                        <option value="Comedor Comunitario Santa Gertrudis">Comedor Comunitario Santa Gertrudis</option>
                    </select>
                    
                    <select id="filtro-prioridad-stock" onchange="filtrarStock()">
                        <option value="">Todas las prioridades</option>
                        <option value="urgente">🔴 Urgente (≤ 7 días)</option>
                        <option value="pronto">🟡 Pronto (8-30 días)</option>
                        <option value="atencion">🟢 Atención (> 30 días)</option>
                        <option value="sin-vencimiento">⚪ Sin vencimiento</option>
                    </select>
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="cargarStock()">🔄 ACTUALIZAR STOCK</button>
                    <button class="boton-accion secundario" onclick="exportarStockExcel()">📊 EXPORTAR A EXCEL</button>
                    <button class="boton-accion secundario" onclick="mostrarResumenStock()">📈 VER RESUMEN</button>
                </div>
                
                <div id="info-stock" class="info-filtros" style="display: none;">
                    <!-- Aquí se mostrará información del stock -->
                </div>
                
                <div id="tabla-stock-container">
                    <!-- Aquí se mostrará la tabla de stock -->
                </div>
            </div>
        </div>
        
        <!-- SECCIÓN HISTORIAL -->
        <div id="seccion-historial" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="filtros-simples">
                <h3>🔍 FILTROS</h3>
                <select id="filtro-tipo-historial">
                    <option value="">Todos los movimientos</option>
                    <option value="entrada">Solo entradas</option>
                    <option value="salida">Solo salidas</option>
                    <option value="devolucion">Solo devoluciones</option>
                </select>
                
                <select id="filtro-sede-historial">
                    <option value="">Todas las sedes</option>
                    <option value="BODEGA CENTRAL">BODEGA CENTRAL</option>
                    <option value="IE Alejandro Vélez Barrientos">IE Alejandro Vélez Barrientos</option>
                    <option value="IE San Vicente Sede Alto las Flores">IE San Vicente Sede Alto las Flores</option>
                    <option value="IE Comercial de Envigado">IE Comercial de Envigado</option>
                    <option value="IE Comercial de Envigado Sede Pio XII">IE Comercial de Envigado Sede Pio XII</option>
                    <option value="IE Comercial de Envigado Sede San Rafael">IE Comercial de Envigado Sede San Rafael</option>
                    <option value="IE Darío de Bedout">IE Darío de Bedout</option>
                    <option value="IE El Salado">IE El Salado</option>
                    <option value="IE El Salado Sede La Morena">IE El Salado Sede La Morena</option>
                    <option value="IE José Manuel Restrepo Vélez (JOMAR)">IE José Manuel Restrepo Vélez (JOMAR)</option>
                    <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                    <option value="IE José Miguel de la Calle">IE José Miguel de la Calle</option>
                    <option value="IE La Paz">IE La Paz</option>
                    <option value="IE La Paz Sede El Trianón">IE La Paz Sede El Trianón</option>
                    <option value="IE John F. Keneddy">IE John F. Keneddy</option>
                    <option value="IE Leticia Arango de Avendaño">IE Leticia Arango de Avendaño</option>
                    <option value="IE Las Palmas">IE Las Palmas</option>
                    <option value="IE Martín Eduardo Rios Llano (Pantanillo)">IE Martín Eduardo Rios Llano (Pantanillo)</option>
                    <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                    <option value="IE Manuel Uribe Ángel (MUA)">IE Manuel Uribe Ángel (MUA)</option>
                    <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                    <option value="IE Normal Superior de Envigado">IE Normal Superior de Envigado</option>
                    <option value="IE Marie Poussepin">IE Marie Poussepin</option>
                    <option value="Centro vida alto de los sueños">Centro vida alto de los sueños</option>
                    <option value="Comedor comunitario la Mina">Comedor comunitario la Mina</option>
                    <option value="Comedor Comunitario Uribe Angel">Comedor Comunitario Uribe Angel</option>
                    <option value="Comedor Comunitario Santa Gertrudis">Comedor Comunitario Santa Gertrudis</option>
                </select>
                
                <select id="filtro-fecha-historial">
                    <option value="">Todas las fechas</option>
                    <option value="hoy">Hoy</option>
                    <option value="ayer">Ayer</option>
                    <option value="semana">Esta semana</option>
                    <option value="mes">Este mes</option>
                </select>
                
                <div class="campo-busqueda">
                    <input type="text" id="filtro-producto-historial" placeholder="🔍 Buscar por producto..." oninput="filtrarPorProducto()">
                    <button type="button" onclick="limpiarFiltroProducto()" class="boton-limpiar-filtro" title="Limpiar filtro">🗑️</button>
                    <div id="sugerencias-producto-historial" class="sugerencias-lista" style="display: none;"></div>
                </div>
            </div>
            
            <div id="tabla-historial-container">
                <!-- Aquí se mostrará la tabla de historial -->
            </div>
        </div>
        
        <!-- SECCIÓN REPORTE DIARIO -->
        <div id="seccion-reporte" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>📄 REPORTE MENSUAL COMPLETO</h2>
                
                <div class="campo-formulario">
                    <label for="mes-reporte">Mes del reporte</label>
                    <input type="month" id="mes-reporte" value="">
                </div>
                
                <div class="campo-formulario">
                    <label for="institucion-reporte">Institución para el reporte</label>
                    <select id="institucion-reporte">
                        <option value="">Selecciona una institución</option>
                        <option value="BODEGA CENTRAL">🏢 BODEGA CENTRAL</option>
                        <option value="IE San Vicente Sede Alto las Flores">🏫 IE San Vicente Sede Alto las Flores</option>
                        <option value="IE Comercial de Envigado Sede Pio XII">🏫 IE Comercial de Envigado Sede Pio XII</option>
                        <option value="IE Comercial de Envigado Sede San Rafael">🏫 IE Comercial de Envigado Sede San Rafael</option>
                        <option value="IE El Salado Sede La Morena">🏫 IE El Salado Sede La Morena</option>
                        <option value="IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González">🏫 IE José Manuel Restrepo Vélez (JOMAR) Sede Fernando González</option>
                        <option value="IE La Paz Sede El Trianón">🏫 IE La Paz Sede El Trianón</option>
                        <option value="IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)">🏫 IE Martín Eduardo Rios Llano Sede La Cruz del Porvenir (Perico)</option>
                        <option value="IE Manuel Uribe Ángel Sede Marceliano Vélez">🏫 IE Manuel Uribe Ángel Sede Marceliano Vélez</option>
                    </select>
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="generarReporteMensual()">📊 GENERAR REPORTE MENSUAL</button>
                    <button class="boton-accion secundario" onclick="mostrarResumenReporte()">📈 VER RESUMEN</button>
                    <button class="boton-accion secundario" onclick="limpiarEstadoReporte()">🔄 LIMPIAR ESTADO</button>
                    <button class="boton-accion secundario" onclick="imprimirReporte()">🖨️ IMPRIMIR</button>
                    <button class="boton-accion secundario" onclick="exportarReporteExcel()">📊 EXPORTAR A EXCEL</button>
                    <button class="boton-accion secundario" onclick="crearDatosPruebaReporte()" style="background: #ff9800;">🧪 CREAR DATOS PRUEBA</button>
                    <button class="boton-accion secundario" onclick="probarReporteMensual()" style="background: #2196F3;">🔧 PROBAR REPORTE</button>
                </div>
                
                <div id="reporte-contenido" style="display: none;">
                    <div class="reporte-header">
                        <h3>REPORTE MENSUAL COMPLETO</h3>
                        <p id="fecha-reporte-texto"></p>
                    </div>
                    
                    <div id="tabla-reporte">
                        <!-- Aquí se mostrará la tabla del reporte -->
                    </div>
                    
                    <div class="reporte-footer">
                        <div class="estado-reporte">
                            <label>Estado del reporte:</label>
                            <div class="checkbox-estado">
                                <input type="checkbox" id="estado-ok">
                                <label for="estado-ok">✅ OK - Todo completo tal como dice</label>
                            </div>
                            <div class="checkbox-estado">
                                <input type="checkbox" id="estado-reporte">
                                <label for="estado-reporte">📋 REPORTE - Hay falencias/discrepancias</label>
                            </div>
                        </div>
                        
                        <div class="observaciones">
                            <label for="observaciones-reporte">Observaciones:</label>
                            <textarea id="observaciones-reporte" placeholder="Detalle cualquier discrepancia o observación..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECCIÓN BUSCAR LOTES -->
        <div id="seccion-buscar-lotes" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>🔍 BUSCAR LOTES POR SEDES</h2>
                <p class="descripcion-funcion">Busca un lote específico y ve en qué sedes hay productos de ese lote</p>
                
                <div class="campo-formulario">
                    <label for="lote-buscar">Número de lote a buscar</label>
                    <div class="campo-busqueda">
                        <input type="text" id="lote-buscar" placeholder="Ejemplo: 2323, LOTE-2024-001..." oninput="buscarLoteEnSedes()">
                        <button type="button" onclick="limpiarBusquedaLote()" class="boton-limpiar-filtro" title="Limpiar búsqueda">🗑️</button>
                        <div id="sugerencias-lote-buscar" class="sugerencias-lista" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="campo-formulario">
                    <label for="producto-lote-buscar">Producto específico (opcional)</label>
                    <input type="text" id="producto-lote-buscar" placeholder="Filtrar por producto específico..." oninput="buscarLoteEnSedes()">
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="buscarLoteEnSedes()">🔍 BUSCAR LOTE</button>
                    <button class="boton-accion secundario" onclick="mostrarTodosLosLotes()">📋 VER TODOS LOS LOTES</button>
                    <button class="boton-accion secundario" onclick="exportarLotesExcel()">📊 EXPORTAR A EXCEL</button>
                </div>
                
                <div id="resultado-busqueda-lotes" style="display: none;">
                    <div class="resultado-header">
                        <h3>📦 RESULTADOS DE BÚSQUEDA</h3>
                        <div id="info-busqueda-lotes"></div>
                    </div>
                    
                    <div id="tabla-lotes-sedes">
                        <!-- Aquí se mostrará la tabla de resultados -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECCIÓN RESTABLECER INVENTARIO -->
        <div id="seccion-restablecer" class="seccion">
            <button class="boton-volver" onclick="volverMenu()">← VOLVER AL MENÚ</button>
            
            <div class="formulario-simple">
                <h2>🔄 RESTABLECER INVENTARIO</h2>
                <p class="descripcion-funcion">⚠️ <strong>ATENCIÓN:</strong> Esta acción borrará TODOS los datos del sistema y reiniciará desde cero</p>
                
                <div class="alert alert-warning">
                    <h4>⚠️ ADVERTENCIA IMPORTANTE</h4>
                    <p>Al restablecer el inventario se eliminará:</p>
                    <ul>
                        <li>📦 Todo el inventario actual</li>
                        <li>📋 Todo el historial de movimientos</li>
                        <li>📊 Todos los contadores y estadísticas</li>
                        <li>📅 Todas las fechas de vencimiento</li>
                        <li>🏷️ Todos los lotes registrados</li>
                    </ul>
                    <p><strong>Esta acción es IRREVERSIBLE y no se puede deshacer.</strong></p>
                </div>
                
                <div class="campo-formulario">
                    <label for="clave-restablecer">Clave de Administrador</label>
                    <input type="password" id="clave-restablecer" placeholder="Ingresa la clave de administrador" maxlength="10">
                    <small>Se requiere la clave de administrador para confirmar esta acción</small>
                </div>
                
                <div class="botones-accion">
                    <button class="boton-accion principal" onclick="restablecerInventario()">🔄 RESTABLECER INVENTARIO</button>
                    <button class="boton-accion secundario" onclick="limpiarFormularioRestablecer()">🧹 LIMPIAR</button>
                </div>
                
                <div class="info-adicional">
                    <h4>📋 Cuándo usar esta función:</h4>
                    <ul>
                        <li>🔄 Al finalizar el año fiscal</li>
                        <li>🆕 Al iniciar un nuevo período</li>
                        <li>🧹 Para limpiar datos de prueba</li>
                        <li>📊 Para reiniciar estadísticas</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- INDICADOR DE CONEXIÓN -->
    <div id="indicador-conexion" class="indicador-conexion">
        🔄 Conectando...
    </div>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-sync.js"></script>
    
    <script>
        // VARIABLES GLOBALES
        let inventario = {};
        let historial = [];
        let contadores = { entradas: 0, salidas: 0, devoluciones: 0 };
        let fechasVencimiento = {};
        let lotes = {};
        let sedeActual = 'BODEGA CENTRAL';
        
        // LISTA DE PRODUCTOS SUGERIDOS
        const productosSugeridos = {
            'Verduras y Hortalizas': [
                'Ahuyama 1000 grs', 'Cabeza de ajo 1000 grs', 'Albahaca 1000 grs', 'Apio 1000 grs',
                'Arracacha 1000 grs', 'Cebolla de huevo blanca 1000 grs', 'Cebolla de huevo morada 1000 grs',
                'Cebolla de rama 1000 grs', 'Cilantro 1000 grs', 'Espinaca 1000 grs', 'Guasca 1000 grs',
                'Habichuela 1000 grs', 'Lechuga batavia 1000 grs', 'Papa capira 1000 grs', 'Papa criolla 1000 grs',
                'Papa nevada 1000 grs', 'Pepino cohombro 1000 grs', 'Pimenton rojo 1000 grs', 'Remolacha 1000 grs',
                'Repollo blanco 1000 grs', 'Tomate 1000 grs', 'Yuca 1000 grs', 'Zanahoria 1000 grs',
                'Zuccini Amarillo 1000 grs'
            ],
            'Frutas': [
                'Banano criollo 1000 grs', 'Fresa 1000 grs', 'Granadilla 1000 grs', 'Guineo 1000 grs',
                'Limon tahiti 1000 grs', 'Mandarina oneco 1000 grs', 'Mango tomy 1000 grs',
                'Manzana roja tipo gala 1000 grs', 'Papaya 1000 grs', 'Pera 1000 grs', 'Piña manzana 1000 grs',
                'Piña oro miel 1000 grs', 'Platano maduro 1000 grs', 'Platano pinton 1000 grs',
                'Platano verde 1000 grs', 'Uvas red globe 1000 grs'
            ],
            'Legumbres': [
                'Fríjol 1000 Gramos Cargamanto blanco', 'Frijol bola roja 1000 grs', 'Lentejas 500 Gramos',
                'Fríjol 500 Gramos Cargamanto blanco', 'Frijol bola roja 500 grs', 'Frijol cargamanto rosado 1000 grs',
                'Frijol cargamanto rosado 500 grs', 'Frijol lima 1000 grs', 'Frijol lima 500 grs',
                'Frijol radical 1000 grs', 'Frijol radical 500 grs', 'Frijol radical catalino 1000 grs',
                'Frijol radical catalino 500 grs'
            ],
            'Cereales y Granos': [
                'Arroz premium 1000 Gramos', 'Arroz premium 500 Gramos', 'Avena UHT 200 ml',
                'Avena instantanea saborizada 180 a 200 grs', 'Avena en hojuelas 200 a 250 grs',
                'Avena instantanea natural 200 a 250 grs', 'Harina de maiz blanco precocida 1000 grs',
                'Harina de maiz blanco precocida 500 grs', 'Harina de trigo 500 grs',
                'Hojuelas de maiz sin azucar 1000 grs', 'Hojuelas de maiz sin azucar 500 grs',
                'Maiz tierno congelado 1000 grs', 'Maiz tierno congelado 200 grs', 'Maiz tierno congelado 500 grs'
            ],
            'Lácteos': [
                'Arequipe sachet individual 20 grs', 'Crema de leche 870 a 900 grs', 'Crema de leche 175 a 200 grs',
                'Kumis 1000 grs', 'Kumis 200 grs', 'Leche en polvo 380 a 400 grs', 'Leche en polvo 900 a 1000 grs',
                'Leche entera liquida UHT 200 ml', 'Leche entera liquida UHT 900 a 1000 ml', 'Leche saborizada 200 ml',
                'Mantequilla sin sal 125 grs', 'Mantequilla sin sal 250 grs', 'Mantequilla sin sal 500 grs',
                'Queso blanco 1000 grs', 'Queso blanco 500 grs', 'Queso blanco 250 grs',
                'Queso mozzarella tajado 2000 grs', 'Queso mozzarella tajado 1000 grs', 'Queso mozzarella tajado 500 grs',
                'Queso mozzarella tajado 250 grs', 'Yogurt de fresa 190 a 200 ml', 'Yogurt de fresa 850 a 900 ml',
                'Yogurt de melocotón 190 a 200 ml', 'Yogurt de melocotón 850 a 900 ml', 'Yogurt de mora 190 a 200 ml',
                'Yogurt de mora 850 a 900 ml', 'Yogurt Grieg (fresa-limón-piña) 125 grs', 'Yogurt Griego Vainilla 125 grs'
            ],
            'Aceites y Condimentos': [
                'Aceite 1000 ml', 'Aceite 250 ml', 'Aceite 500 ml', 'Aceite 3000 ml', 'Achiote 100 grs',
                'Achiote 50 grs', 'Achiote 60 grs', 'Achiote 70 grs', 'Ajo en polvo 20 a 30 grs', 'Ajo en polvo 50 grs',
                'Ajonjoli 100 grs', 'Ajonjoli 20 grs', 'Ajonjoli 50 grs', 'Azucar 1000 grs', 'Azucar 500 grs',
                'Bicarbonato 20 grs', 'Canela en polvo 20 grs', 'Canela en polvo 50 grs', 'Canela en polvo 100 grs',
                'Clavos de olor 100 grs', 'Clavos de olor 20 grs', 'Clavos de olor 50 grs', 'Cocoa en polvo 200 grs',
                'Cocoa en polvo 230 grs', 'Color 20 grs', 'Color 50 grs', 'Color 100 grs', 'Curcuma en polvo 20 a 25 grs',
                'Curcuma en polvo 50 a 55 grs', 'Curry en polvo 100 grs', 'Curry en polvo 20 grs', 'Curry en polvo 50 grs',
                'Esencia de vainilla 165 a 170 ml', 'Finas hierbas 100 grs', 'Finas hierbas 50 grs',
                'Finas hierbas 15 a 20 grs', 'Laurel 100 grs', 'Laurel 50 grs', 'Laurel 10 a 20 grs',
                'Nuez moscada en polvo 15 a 20 grs', 'Nuez moscada en polvo 50 grs', 'Nuez moscada en polvo 100 grs',
                'Pimienta molida 100 grs', 'Pimienta molida 50 grs', 'Pimienta molida 20 grs', 'Sal 1000 grs', 'Sal 500 grs',
                'Vinagre de frutas 500 ml'
            ],
            'Proteínas': [
                'CARNE DE CERDO 1000 GRS', 'CARNE DE CERDO EN GULASH 1000 GRS', 'CARNE DE RES 1000 GRS',
                'CARNE MOLIDA MIXTA HAMBURGUESA 50 GRS (VALOR KILO)', 'CARNE MOLIDA MIXTA HAMBURGUESA 60 GRS (VALOR KILO)',
                'CARNE MOLIDA MIXTA HAMBURGUESA 70 GRS (VALOR KILO)', 'CARNE MOLIDA MIXTA HAMBURGUESA 80 GRS (VALOR KILO)',
                'CARNE MOLIDA MIXTA 1000 GRS', 'CONTRAMUSLO MARINADO 1000 GRS', 'CONTRAMUSLO SIN MARINAR 1000 GRS',
                'FILETE DE POLLO MARINADO 1000 GRS', 'FILETE DE POLLO SIN MARINAR 1000 GRS',
                'FILETE DE POLLO MARINADO EN GULASH 1000 GRS', 'FILETE DE POLLO SIN MARINAR EN GULASH 1000 GRS',
                'TOCINETA 225 GRS', 'TOCINETA 450 GRS', 'Huevo 1 unidad 55Gr', 'Atun en aceite 150 a 160 grs',
                'Atun en agua 160 a 175 grs', 'Sardina en salsa de tomate 155 grs'
            ],
            'Productos de Panadería': [
                'Arepa de chocolo 320 a 350 grs', 'Arepa de yuca 300 a 320 grs', 'Arepa redonda asada 35 grs',
                'Arepa rellena de queso 400 grs', 'Arepa tela 580 grs', 'Pan hamburguesa 20 gr', 'Pan hamburguesa 40 gr',
                'Pan tajado 440 gr', 'Torta de naranja 30 gr', 'Torta de naranja 50 gr', 'Torta de naranja 70 gr',
                'Almojábana 30 gr', 'Almojábana 60 gr', 'Pandequeso 30 gr', 'Pandequeso 60 gr',
                'Dedito horneado con queso molido (quesudito) 27 gr', 'Brownie 65 gr', 'Brownie 48 gr',
                'Palo de queso Hojaldrado 30 gr', 'Palo de queso Hojaldrado 50 gr', 'Palo de queso Hojaldrado 70 gr',
                'Pan croissant con relleno de chocolate 30 gr', 'Pan croissant con relleno de chocolate 50 gr',
                'Pan croissant con relleno de chocolate 70 gr', 'Torta de vainilla 30 gr', 'Torta de vainilla 50 gr',
                'Torta de vainilla 70 gr', 'Mufinns 30 gr', 'Mufinns 50 gr', 'Mufinns 70 gr',
                'Brownie Relleno de arequipe 10% relleno 65 gr', 'Brownie Relleno de arequipe 10% relleno 48 gr',
                'Waffles de yuca 45 grs', 'Waffles natural 30 grs', 'Waffles natural 50 a 54 grs'
            ],
            'Galletas y Snacks': [
                'Galleta rellena de yogurt griego y acai 23 gr', 'Galleta chips de chocolate 35 gr',
                'Galleta chips de chocolate 40 gr', 'Galletas crackers saladas 25 a 34 grs',
                'Galletas crackers saladas 300 a 400 grs', 'Galleta multicereal con relleno de crema tipo sandwich 23 gr',
                'Galleta salada * 4 tacos 300 gr', 'Galleta salada * 6 tacos 450 gr', 'Mani con cobertura de chocolate 50 grs',
                'Mani dulce 30 grs', 'Mani dulce 60 grs', 'Mani salado 30 grs', 'Mani salado 60 grs',
                'Mantequilla de mani 250 a 300 grs', 'Mezcla frutos secos 30 grs', 'Mezcla frutos secos 60 grs'
            ],
            'Pastas y Cereales': [
                'Pasta (tornillos) 250 grs', 'Pasta alimenticia (espagueti) 250 grs', 'Pasta alimenticia (espagueti) 500 grs',
                'Pasta cabello de angel 250 grs', 'Pasta tipo penne 500 grs', 'Tortilla de harina de trigo extra grande 1 paquete',
                'Tortilla de harina de trigo grande 1 paquete', 'Tortilla de harina de trigo mediana 1 paquete'
            ],
            'Dulces y Mermeladas': [
                'Bocadillo 20 grs', 'Mermelada de mora 200 a 250 grs', 'Mermelada de mora 500 grs',
                'Mermelada de piña 200 a 250 grs', 'Mermelada de piña 500 grs', 'Mermelada sachet individual 15 grs',
                'Miel 200 grs', 'Panela 830 a 1000 grs', 'Chocolate de mesa sin azucar 250 grs'
            ],
            'Pulpas Congeladas': [
                'Pulpa de fresa congelada 1000 grs', 'Pulpa de guanabana congelada 1000 grs', 'Pulpa de guayaba congelada 1000 grs',
                'Pulpa de lulo congelada 1000 grs', 'Pulpa de mandarina congelada 1000 grs', 'Pulpa de mango congelada 1000 grs',
                'Pulpa de maracuya congelada 1000 grs', 'Pulpa de mora congelada 1000 grs', 'Pulpa de piña congelada 1000 grs',
                'Pulpa de tomate de árbol congelada 1000 grs', 'Pulpa de uva congelada 1000 grs'
            ],
            'Bebidas': [
                'Agua 200 ml', 'Refresco de fruta 200 ml'
            ],
            'Productos Preparados': [
                'Pastel de pollo 130 grs', 'Pastel de pollo 30 a 37,5 grs', 'Papa rellena 30 grs'
            ],
            'Suplementos': [
                'Formulas de suplementos para adultos de uso general (mujeres gestantes y lactantes) 400 grs',
                'Polvo instantáneo fortificado con sabor a chocolate 200 grs'
            ],
            'Empaques y Utensilios': [
                'Bolsa de empaque 1 unidad', 'Costal tipo saco de gasa de vuelta 39x45 cm',
                'Costal tipo saco de gasa de vuelta 45x60 cm'
            ],
            'Otros': [
                'Fecula de maiz natural 500 grs', 'Fecula de maiz natural 1000 grs', 'Fecula de maiz saborizada 180 grs',
                'Cafe instantaneo 85 grs'
            ]
        };
        
        // FUNCIONES DE AUTOCOMPLETADO
        function inicializarAutocompletado(inputId, sugerenciasId) {
            const input = document.getElementById(inputId);
            const sugerenciasDiv = document.getElementById(sugerenciasId);
            let sugerenciasActuales = [];
            let indiceSeleccionado = -1;
            
            input.addEventListener('input', function() {
                const valor = this.value.toLowerCase().trim();
                
                if (valor.length < 2) {
                    sugerenciasDiv.style.display = 'none';
                    return;
                }
                
                // Buscar productos que coincidan
                sugerenciasActuales = [];
                Object.keys(productosSugeridos).forEach(categoria => {
                    productosSugeridos[categoria].forEach(producto => {
                        if (producto.toLowerCase().includes(valor)) {
                            sugerenciasActuales.push({
                                nombre: producto,
                                categoria: categoria
                            });
                        }
                    });
                });
                
                // Mostrar sugerencias
                mostrarSugerencias(sugerenciasActuales, sugerenciasDiv);
                indiceSeleccionado = -1;
            });
            
            input.addEventListener('keydown', function(e) {
                if (sugerenciasDiv.style.display === 'block') {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        indiceSeleccionado = Math.min(indiceSeleccionado + 1, sugerenciasActuales.length - 1);
                        actualizarSeleccion(sugerenciasDiv, indiceSeleccionado);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        indiceSeleccionado = Math.max(indiceSeleccionado - 1, -1);
                        actualizarSeleccion(sugerenciasDiv, indiceSeleccionado);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (indiceSeleccionado >= 0 && sugerenciasActuales[indiceSeleccionado]) {
                            this.value = sugerenciasActuales[indiceSeleccionado].nombre;
                            sugerenciasDiv.style.display = 'none';
                        }
                    } else if (e.key === 'Escape') {
                        sugerenciasDiv.style.display = 'none';
                    }
                }
            });
            
            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !sugerenciasDiv.contains(e.target)) {
                    sugerenciasDiv.style.display = 'none';
                }
            });
        }
        
        function mostrarSugerencias(sugerencias, contenedor) {
            if (sugerencias.length === 0) {
                contenedor.style.display = 'none';
                return;
            }
            
            let html = '';
            sugerencias.slice(0, 8).forEach(sugerencia => {
                html += `
                    <div class="sugerencia-item" onclick="seleccionarSugerencia('${sugerencia.nombre}', '${contenedor.id}')">
                        <div>${sugerencia.nombre}</div>
                        <div class="sugerencia-categoria">${sugerencia.categoria}</div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
            contenedor.style.display = 'block';
        }
        
        function actualizarSeleccion(contenedor, indice) {
            const items = contenedor.querySelectorAll('.sugerencia-item');
            items.forEach((item, i) => {
                if (i === indice) {
                    item.classList.add('seleccionada');
                } else {
                    item.classList.remove('seleccionada');
                }
            });
        }
        
        function seleccionarSugerencia(producto, contenedorId) {
            const inputId = contenedorId.replace('sugerencias-', 'producto-');
            document.getElementById(inputId).value = producto;
            document.getElementById(contenedorId).style.display = 'none';
        }
        
        // FUNCIONES DE NAVEGACIÓN
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.getElementById('menu-principal').style.display = 'none';
            
            // Mostrar la sección seleccionada
            document.getElementById('seccion-' + seccion).classList.add('activa');
            
            // Cargar datos específicos según la sección
            if (seccion === 'stock') {
                cargarStock();
            } else if (seccion === 'historial') {
                cargarHistorial();
            } else if (seccion === 'salida') {
                cargarProductosParaSalida();
                // Verificar estado del selector de destino cuando se abre la sección de salida
                setTimeout(() => {
                    const sedeSalida = document.getElementById('sede-salida');
                    if (sedeSalida.value === 'BODEGA CENTRAL') {
                        console.log('Sección salida abierta - BODEGA CENTRAL seleccionada, ejecutando mostrarOcultarDestino...');
                        mostrarOcultarDestino();
                    }
                }, 100);
            }
        }
        
        function volverMenu() {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.getElementById('menu-principal').style.display = 'block';
        }
        
        // FUNCIONES DE REPORTE MENSUAL
        function generarReporteMensual() {
            try {
                console.log('🔍 Función generarReporteMensual ejecutada');
                
                const mesSeleccionado = document.getElementById('mes-reporte').value;
                console.log('📅 Mes seleccionado:', mesSeleccionado);
                
                if (!mesSeleccionado) {
                    mostrarMensaje('❌ Por favor selecciona un mes', 'error');
                    return;
                }
                
                // Verificar si hay datos en el historial
                console.log('📊 Historial disponible:', historial.length, 'movimientos');
                if (historial.length === 0) {
                    mostrarMensaje('❌ No hay datos de movimientos en el sistema. Primero debes registrar algunas entradas o salidas.', 'error');
                    return;
                }
            
            // Obtener el primer y último día del mes seleccionado
            const [year, month] = mesSeleccionado.split('-');
            const primerDia = `${year}-${month}-01`;
            const ultimoDia = new Date(parseInt(year), parseInt(month), 0).toISOString().split('T')[0];
            
            console.log('📅 Rango de fechas:', primerDia, 'a', ultimoDia);
            
            // Filtrar movimientos del mes seleccionado
            let movimientosFiltrados = historial.filter(movimiento => {
                const fechaMovimiento = movimiento.fecha;
                const cumpleFiltro = fechaMovimiento >= primerDia && fechaMovimiento <= ultimoDia;
                if (cumpleFiltro) {
                    console.log('✅ Movimiento incluido:', movimiento.producto, 'fecha:', fechaMovimiento);
                }
                return cumpleFiltro;
            });
            
            console.log('📊 Movimientos filtrados:', movimientosFiltrados.length);
            
            if (movimientosFiltrados.length === 0) {
                // Mostrar información sobre qué meses tienen datos
                const mesesDisponibles = [...new Set(historial.map(mov => mov.fecha.substring(0, 7)))].sort();
                const mesesRecientes = mesesDisponibles.slice(-3); // Últimos 3 meses
                
                let mensaje = `❌ No hay movimientos en el mes seleccionado (${mesSeleccionado}).`;
                
                if (mesesDisponibles.length > 0) {
                    mensaje += `\n\n📅 Meses disponibles con datos: ${mesesRecientes.join(', ')}`;
                    mensaje += `\n💡 Sugerencia: Selecciona uno de estos meses para generar el reporte.`;
                }
                
                mostrarMensaje(mensaje, 'info');
                return;
            }
            
            // Generar tabla del reporte mensual
            generarTablaReporteMensual(movimientosFiltrados, mesSeleccionado);
            
            // Mostrar el contenido del reporte
            document.getElementById('reporte-contenido').style.display = 'block';
            
            // Mostrar mensaje de éxito
            mostrarMensaje(`✅ Reporte mensual generado exitosamente - ${movimientosFiltrados.length} movimientos encontrados en ${mesSeleccionado}`, 'exito');
            } catch (error) {
                console.error('❌ Error en generarReporteMensual:', error);
                mostrarMensaje(`❌ Error al generar reporte: ${error.message}`, 'error');
            }
        }
        
        function generarTablaReporteMensual(movimientos, mes) {
            try {
                console.log('🔧 Función generarTablaReporteMensual ejecutada');
                console.log('📊 Movimientos recibidos:', movimientos);
                console.log('📅 Mes recibido:', mes);
                
                const tablaContainer = document.getElementById('tabla-reporte');
                const fechaTexto = document.getElementById('fecha-reporte-texto');
                const tituloReporte = document.querySelector('.reporte-header h3');
                
                console.log('📋 Elementos encontrados:', {
                    tablaContainer: tablaContainer,
                    fechaTexto: fechaTexto,
                    tituloReporte: tituloReporte
                });
                
                // Formatear mes
                const [year, month] = mes.split('-');
                const fechaObj = new Date(parseInt(year), parseInt(month) - 1, 1);
                const mesFormateado = fechaObj.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long'
                });
                fechaTexto.textContent = `Reporte del mes: ${mesFormateado}`;
                
                // Actualizar título del reporte
                tituloReporte.textContent = 'REPORTE MENSUAL COMPLETO';
            
            // Agrupar movimientos por tipo
            let movimientosAgrupados = {};
            
            movimientos.forEach(movimiento => {
                const tipoMovimiento = movimiento.tipo === 'entrada' ? '📥 Entradas' : 
                                      movimiento.tipo === 'salida' ? '📤 Salidas' : '↩️ Devoluciones';
                if (!movimientosAgrupados[tipoMovimiento]) {
                    movimientosAgrupados[tipoMovimiento] = [];
                }
                movimientosAgrupados[tipoMovimiento].push(movimiento);
            });
            
            // Crear tabla HTML agrupada
            let tablaHTML = '';
            
            Object.keys(movimientosAgrupados).forEach(grupo => {
                // Calcular totales por grupo
                const totalProductos = movimientosAgrupados[grupo].length;
                const totalCantidad = movimientosAgrupados[grupo].reduce((sum, mov) => sum + mov.cantidad, 0);
                
                // Encabezado de grupo con totales
                tablaHTML += `
                    <div class="sede-grupo">
                        <h4 class="sede-titulo">${grupo}</h4>
                        <p class="sede-resumen">Total productos: ${totalProductos} | Total cantidad: ${totalCantidad}</p>
                        
                        <table class="tabla-reporte">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Sede</th>
                                    <th>Fecha</th>
                                    <th>Lote</th>
                                    <th>Fecha de Vencimiento</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Productos de este grupo
                movimientosAgrupados[grupo].forEach((movimiento, index) => {
                    // Obtener fecha de vencimiento del lote
                    let fechaVencimiento = '-';
                    if (movimiento.lote) {
                        const claveInventario = Object.keys(inventario).find(clave => {
                            const item = inventario[clave];
                            return item.producto === movimiento.producto && item.sede === movimiento.sede;
                        });
                        
                        if (claveInventario && lotes[claveInventario]) {
                            const loteEncontrado = lotes[claveInventario].find(lote => lote.lote === movimiento.lote);
                            if (loteEncontrado && loteEncontrado.fecha) {
                                fechaVencimiento = loteEncontrado.fecha;
                            }
                        }
                    }
                    
                    // Determinar sede para mostrar
                    let sedeMostrar = movimiento.sede;
                    if (movimiento.sedeDestino) {
                        sedeMostrar = `${movimiento.sede} → ${movimiento.sedeDestino}`;
                    }
                    
                    tablaHTML += `
                        <tr>
                            <td><strong>${movimiento.producto}</strong></td>
                            <td class="cantidad-cell">${movimiento.cantidad}</td>
                            <td>${sedeMostrar}</td>
                            <td>${movimiento.fecha}</td>
                            <td>${movimiento.lote || '-'}</td>
                            <td>${fechaVencimiento}</td>
                        </tr>
                    `;
                });
                
                tablaHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            console.log('📋 HTML generado:', tablaHTML);
            tablaContainer.innerHTML = tablaHTML;
            console.log('✅ Tabla generada exitosamente');
            } catch (error) {
                console.error('❌ Error en generarTablaReporteMensual:', error);
                mostrarMensaje(`❌ Error al generar tabla: ${error.message}`, 'error');
            }
        }
        
        function imprimirReporte() {
            const reporteContenido = document.getElementById('reporte-contenido');
            
            if (reporteContenido.style.display === 'none') {
                mostrarMensaje('❌ Primero debes generar un reporte', 'error');
                return;
            }
            
            window.print();
        }
        
        // FUNCIONES AUXILIARES PARA EL REPORTE
        function actualizarEstadoRecepcion(rowId, estado) {
            const cantidadRecibidaDiv = document.getElementById(`cantidad-recibida-${rowId}`);
            
            // Ocultar campo de cantidad recibida por defecto
            cantidadRecibidaDiv.style.display = 'none';
            
            // Mostrar campo de cantidad recibida solo si es parcial
            if (estado === 'parcial') {
                cantidadRecibidaDiv.style.display = 'block';
            }
            
            // Actualizar clase de la fila para indicar estado
            const row = document.getElementById(rowId);
            row.className = `estado-${estado}`;
            
            // Guardar estado en localStorage para persistencia
            const reporteData = JSON.parse(localStorage.getItem('reporteEstado') || '{}');
            reporteData[rowId] = { estado: estado };
            localStorage.setItem('reporteEstado', JSON.stringify(reporteData));
        }
        
        function actualizarCantidadRecibida(rowId, cantidad) {
            // Guardar cantidad recibida en localStorage
            const reporteData = JSON.parse(localStorage.getItem('reporteEstado') || '{}');
            if (!reporteData[rowId]) {
                reporteData[rowId] = {};
            }
            reporteData[rowId].cantidadRecibida = parseInt(cantidad);
            localStorage.setItem('reporteEstado', JSON.stringify(reporteData));
        }
        
        function obtenerResumenReporte() {
            const reporteData = JSON.parse(localStorage.getItem('reporteEstado') || '{}');
            let resumen = {
                totalProductos: 0,
                llegaronCompletos: 0,
                noLlegaron: 0,
                llegaronParciales: 0,
                totalCantidadEnviada: 0,
                totalCantidadRecibida: 0
            };
            
            // Contar estados
            Object.values(reporteData).forEach(item => {
                resumen.totalProductos++;
                if (item.estado === 'llego') {
                    resumen.llegaronCompletos++;
                } else if (item.estado === 'no-llego') {
                    resumen.noLlegaron++;
                } else if (item.estado === 'parcial') {
                    resumen.llegaronParciales++;
                }
            });
            
            return resumen;
        }
        
        function mostrarResumenReporte() {
            const reporteContenido = document.getElementById('reporte-contenido');
            
            if (reporteContenido.style.display === 'none') {
                mostrarMensaje('❌ Primero debes generar un reporte', 'error');
                return;
            }
            
            const resumen = obtenerResumenReporte();
            const totalProductos = resumen.totalProductos;
            
            if (totalProductos === 0) {
                mostrarMensaje('ℹ️ No hay productos marcados en el reporte aún', 'info');
                return;
            }
            
            const porcentajeLlegaron = totalProductos > 0 ? Math.round((resumen.llegaronCompletos / totalProductos) * 100) : 0;
            const porcentajeNoLlegaron = totalProductos > 0 ? Math.round((resumen.noLlegaron / totalProductos) * 100) : 0;
            const porcentajeParciales = totalProductos > 0 ? Math.round((resumen.llegaronParciales / totalProductos) * 100) : 0;
            
            const mensajeResumen = `
                <div style="text-align: left; font-size: 1.1em;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">📊 RESUMEN DEL REPORTE</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Total de productos:</strong> ${totalProductos}
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <span style="color: #28a745;">✅ Llegaron completos:</span> ${resumen.llegaronCompletos} (${porcentajeLlegaron}%)
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <span style="color: #dc3545;">❌ No llegaron:</span> ${resumen.noLlegaron} (${porcentajeNoLlegaron}%)
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <span style="color: #ffc107;">⚠️ Llegaron parciales:</span> ${resumen.llegaronParciales} (${porcentajeParciales}%)
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <strong>Estado general:</strong> 
                        ${porcentajeLlegaron >= 80 ? '🟢 EXCELENTE' : 
                          porcentajeLlegaron >= 60 ? '🟡 BUENO' : 
                          porcentajeLlegaron >= 40 ? '🟠 REGULAR' : '🔴 REQUIERE ATENCIÓN'}
                    </div>
                </div>
            `;
            
            Swal.fire({
                title: '📈 RESUMEN DEL REPORTE',
                html: mensajeResumen,
                icon: 'info',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#3498db',
                width: '500px'
            });
        }
        
        function limpiarEstadoReporte() {
            Swal.fire({
                title: '🔄 LIMPIAR ESTADO DEL REPORTE',
                text: '¿Estás seguro de que quieres limpiar todos los estados de recepción marcados?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, limpiar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Limpiar localStorage
                    localStorage.removeItem('reporteEstado');
                    
                    // Limpiar clases de estado de las filas
                    const filas = document.querySelectorAll('.tabla-reporte tbody tr');
                    filas.forEach(fila => {
                        fila.className = '';
                    });
                    
                    // Desmarcar todos los radio buttons
                    const radioButtons = document.querySelectorAll('.estado-opciones input[type="radio"]');
                    radioButtons.forEach(radio => {
                        radio.checked = false;
                    });
                    
                    // Ocultar campos de cantidad recibida
                    const camposCantidad = document.querySelectorAll('.cantidad-recibida');
                    camposCantidad.forEach(campo => {
                        campo.style.display = 'none';
                    });
                    
                    mostrarMensaje('✅ Estado del reporte limpiado correctamente', 'success');
                }
            });
        }
        
        // FUNCIÓN PARA EXPORTAR REPORTE MENSUAL A EXCEL
        function exportarReporteExcel() {
            const reporteContenido = document.getElementById('reporte-contenido');
            
            if (reporteContenido.style.display === 'none') {
                mostrarMensaje('❌ Primero debes generar un reporte', 'error');
                return;
            }
            
            const mesSeleccionado = document.getElementById('mes-reporte').value;
            
            if (!mesSeleccionado) {
                mostrarMensaje('❌ Faltan datos para generar el reporte', 'error');
                return;
            }
            
            // Obtener el primer y último día del mes seleccionado
            const [year, month] = mesSeleccionado.split('-');
            const primerDia = `${year}-${month}-01`;
            const ultimoDia = new Date(parseInt(year), parseInt(month), 0).toISOString().split('T')[0];
            
            // Obtener todos los movimientos del mes
            let movimientosFiltrados = historial.filter(movimiento => {
                const fechaMovimiento = movimiento.fecha;
                return fechaMovimiento >= primerDia && fechaMovimiento <= ultimoDia;
            });
            
            if (movimientosFiltrados.length === 0) {
                mostrarMensaje('❌ No hay datos para exportar', 'error');
                return;
            }
            
            // Función auxiliar para limpiar texto de frases específicas
            function limpiarTextoReporte(texto) {
                if (!texto) return texto;
                return texto
                    .replace(/compra local/gi, '')
                    .replace(/envio para comedor/gi, '')
                    .replace(/envio semanal/gi, '')
                    .replace(/compra mayorista/gi, '')
                    .trim();
            }
            
            // Crear datos para Excel - SOLO 4 COLUMNAS LIMPIAS
            const datosExcel = [];
            
            // Agregar encabezados de columnas
            datosExcel.push(['Producto', 'Cantidad', 'Fecha', 'Sede o Movimiento']);
            
            // Agregar todos los movimientos del mes
            movimientosFiltrados.forEach(movimiento => {
                // Determinar sede para mostrar
                let sedeMostrar = movimiento.sede;
                if (movimiento.sedeDestino) {
                    sedeMostrar = `${movimiento.sede} → ${movimiento.sedeDestino}`;
                }
                
                datosExcel.push([
                    limpiarTextoReporte(movimiento.producto),
                    movimiento.cantidad,
                    movimiento.fecha,
                    limpiarTextoReporte(sedeMostrar)
                ]);
            });
            
            // Crear el archivo Excel con formato
            const ws = XLSX.utils.aoa_to_sheet(datosExcel);
            const wb = XLSX.utils.book_new();
            
            // Aplicar formato a los encabezados (negritas)
            if (!ws['!cols']) ws['!cols'] = [];
            ws['!cols'][0] = { width: 25 }; // Producto
            ws['!cols'][1] = { width: 12 }; // Cantidad
            ws['!cols'][2] = { width: 15 }; // Fecha
            ws['!cols'][3] = { width: 35 }; // Sede o Movimiento
            
            // Aplicar negritas a la primera fila (encabezados)
            for (let col = 0; col < 4; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellRef]) continue;
                if (!ws[cellRef].s) ws[cellRef].s = {};
                ws[cellRef].s.font = { bold: true };
            }
            
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
            
            // Generar nombre del archivo
            const nombreArchivo = `Reporte_Mensual_${mesSeleccionado.replace(/-/g, '_')}.xlsx`;
            
            // Descargar el archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarMensaje('✅ Reporte exportado a Excel correctamente', 'success');
        }
        
        // FUNCIONES DE FORMULARIOS
        function limpiarFormularioEntrada() {
            document.getElementById('producto-entrada').value = '';
            document.getElementById('cantidad-entrada').value = '';
            document.getElementById('sede-entrada').value = '';
            document.getElementById('descripcion-entrada').value = '';
            document.getElementById('fecha-vencimiento-entrada').value = '';
            document.getElementById('lote-entrada').value = '';
            document.getElementById('fecha-no-aplica-entrada').checked = false;
            document.getElementById('lote-no-aplica-entrada').checked = false;
        }
        
        function limpiarFormularioSalida() {
            document.getElementById('producto-salida').value = '';
            document.getElementById('cantidad-salida').value = '';
            document.getElementById('sede-salida').value = '';
            document.getElementById('sede-destino').value = '';
            document.getElementById('descripcion-salida').value = '';
            document.getElementById('campo-destino').style.display = 'none';
            
            console.log('Formulario de salida limpiado');
        }
        
        function probarSelectorDestino() {
            console.log('=== PRUEBA DEL SELECTOR DE DESTINO ===');
            const sedeSalida = document.getElementById('sede-salida');
            const campoDestino = document.getElementById('campo-destino');
            
            console.log('Valor actual del selector:', sedeSalida.value);
            console.log('Estado actual del campo destino:', campoDestino.style.display);
            
            // Simular selección de BODEGA CENTRAL
            sedeSalida.value = 'BODEGA CENTRAL';
            console.log('Seleccionando BODEGA CENTRAL...');
            mostrarOcultarDestino();
            
            setTimeout(() => {
                console.log('Estado después de seleccionar BODEGA CENTRAL:', campoDestino.style.display);
                
                // Simular selección de otra sede
                sedeSalida.value = 'IE Alejandro Vélez Barrientos';
                console.log('Seleccionando otra sede...');
                mostrarOcultarDestino();
                
                setTimeout(() => {
                    console.log('Estado después de seleccionar otra sede:', campoDestino.style.display);
                    
                    // Volver a BODEGA CENTRAL
                    sedeSalida.value = 'BODEGA CENTRAL';
                    console.log('Volviendo a BODEGA CENTRAL...');
                    mostrarOcultarDestino();
                    
                    setTimeout(() => {
                        console.log('Estado final:', campoDestino.style.display);
                        console.log('=== FIN DE LA PRUEBA ===');
                    }, 500);
                }, 500);
            }, 500);
        }
        
        function mostrarOcultarDestino() {
            const sedeOrigen = document.getElementById('sede-salida').value;
            const campoDestino = document.getElementById('campo-destino');
            
            console.log('mostrarOcultarDestino ejecutado - Sede origen:', sedeOrigen);
            
            if (sedeOrigen === 'BODEGA CENTRAL') {
                campoDestino.style.display = 'block';
                console.log('Campo destino mostrado');
            } else {
                campoDestino.style.display = 'none';
                document.getElementById('sede-destino').value = '';
                console.log('Campo destino ocultado');
            }
        }
        
        function limpiarFormularioDevolucion() {
            document.getElementById('producto-devolucion').value = '';
            document.getElementById('cantidad-devolucion').value = '';
            document.getElementById('sede-devolucion').value = '';
            document.getElementById('motivo-devolucion').value = '';
        }

        function limpiarFormularioRestablecer() {
            document.getElementById('clave-restablecer').value = '';
        }

        // FUNCIÓN PARA RESTABLECER INVENTARIO
        function restablecerInventario() {
            const clave = document.getElementById('clave-restablecer').value.trim();
            
            // Verificar que se haya ingresado una clave
            if (!clave) {
                mostrarMensaje('❌ Por favor ingresa la clave de administrador', 'error');
                return;
            }
            
            // Verificar la clave (PAE2025)
            if (clave !== 'PAE2025') {
                mostrarMensaje('❌ Clave incorrecta. Acceso denegado', 'error');
                document.getElementById('clave-restablecer').value = '';
                return;
            }
            
            // Confirmar la acción con SweetAlert2
            Swal.fire({
                title: '⚠️ CONFIRMAR RESTABLECIMIENTO',
                html: `
                    <div style="text-align: left;">
                        <p><strong>¿Estás completamente seguro de que quieres restablecer el inventario?</strong></p>
                        <p>Esta acción eliminará:</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>📦 Todo el inventario actual</li>
                            <li>📋 Todo el historial de movimientos</li>
                            <li>📊 Todos los contadores y estadísticas</li>
                            <li>📅 Todas las fechas de vencimiento</li>
                            <li>🏷️ Todos los lotes registrados</li>
                        </ul>
                        <p style="color: #d32f2f; font-weight: bold;">⚠️ Esta acción es IRREVERSIBLE y no se puede deshacer.</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d32f2f',
                cancelButtonColor: '#666',
                confirmButtonText: '🔄 SÍ, RESTABLECER TODO',
                cancelButtonText: '❌ CANCELAR',
                reverseButtons: true,
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    // Ejecutar el restablecimiento
                    ejecutarRestablecimiento();
                }
            });
        }

        function ejecutarRestablecimiento() {
            try {
                // Mostrar indicador de progreso
                Swal.fire({
                    title: '🔄 Restableciendo inventario...',
                    html: 'Por favor espera mientras se eliminan todos los datos...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Limpiar todas las variables globales
                inventario = {};
                historial = [];
                contadores = { entradas: 0, salidas: 0, devoluciones: 0 };
                fechasVencimiento = {};
                lotes = {};
                sedeActual = 'BODEGA CENTRAL';

                // Limpiar localStorage
                localStorage.removeItem('inventario');
                localStorage.removeItem('historial');
                localStorage.removeItem('contadores');
                localStorage.removeItem('fechasVencimiento');
                localStorage.removeItem('lotes');
                localStorage.removeItem('sedeActual');
                localStorage.removeItem('reporteEstado');

                // Limpiar Firebase (si está disponible)
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    limpiarFirebase();
                }

                // Mostrar confirmación de éxito
                setTimeout(() => {
                    Swal.fire({
                        title: '✅ Inventario Restablecido',
                        html: `
                            <div style="text-align: left;">
                                <p><strong>El inventario ha sido restablecido exitosamente.</strong></p>
                                <p>Se han eliminado todos los datos:</p>
                                <ul style="text-align: left; margin: 10px 0;">
                                    <li>📦 Inventario: Limpiado</li>
                                    <li>📋 Historial: Limpiado</li>
                                    <li>📊 Contadores: Reiniciados</li>
                                    <li>📅 Fechas de vencimiento: Eliminadas</li>
                                    <li>🏷️ Lotes: Eliminados</li>
                                </ul>
                                <p style="color: #4caf50; font-weight: bold;">🎉 El sistema está listo para un nuevo inicio.</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: '✅ ENTENDIDO',
                        confirmButtonColor: '#4caf50'
                    }).then(() => {
                        // Limpiar formulario y volver al menú
                        limpiarFormularioRestablecer();
                        volverMenu();
                        
                        // Actualizar contadores en la interfaz si existen
                        actualizarContadoresInterfaz();
                    });
                }, 1000);

            } catch (error) {
                console.error('Error al restablecer inventario:', error);
                Swal.fire({
                    title: '❌ Error',
                    text: 'Ocurrió un error al restablecer el inventario. Por favor, intenta nuevamente.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        async function limpiarFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // Limpiar colección de inventario
                    const inventarioRef = db.collection('inventario');
                    const inventarioSnapshot = await inventarioRef.get();
                    const batch = db.batch();
                    
                    inventarioSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // Limpiar colección de historial
                    const historialRef = db.collection('historial');
                    const historialSnapshot = await historialRef.get();
                    
                    historialSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // Ejecutar el batch
                    await batch.commit();
                    console.log('✅ Firebase limpiado exitosamente');
                }
            } catch (error) {
                console.error('Error limpiando Firebase:', error);
                // No mostrar error al usuario, solo log
            }
        }

        function actualizarContadoresInterfaz() {
            // Actualizar contadores en la interfaz si existen elementos
            const contadorEntradas = document.getElementById('contador-entradas');
            const contadorSalidas = document.getElementById('contador-salidas');
            const contadorDevoluciones = document.getElementById('contador-devoluciones');
            
            if (contadorEntradas) contadorEntradas.textContent = '0';
            if (contadorSalidas) contadorSalidas.textContent = '0';
            if (contadorDevoluciones) contadorDevoluciones.textContent = '0';
        }
        
        // FUNCIONES DE REGISTRO
        function registrarEntrada() {
            const producto = document.getElementById('producto-entrada').value.trim();
            const cantidad = parseInt(document.getElementById('cantidad-entrada').value);
            const sede = document.getElementById('sede-entrada').value;
            const descripcion = document.getElementById('descripcion-entrada').value.trim();
            const fechaVencimiento = document.getElementById('fecha-vencimiento-entrada').value;
            const lote = document.getElementById('lote-entrada').value.trim();
            const fechaNoAplica = document.getElementById('fecha-no-aplica-entrada').checked;
            const loteNoAplica = document.getElementById('lote-no-aplica-entrada').checked;
            
            // Validaciones simples
            if (!producto) {
                mostrarMensaje('Por favor, escribe el nombre del producto', 'error');
                return;
            }
            
            if (!cantidad || cantidad <= 0) {
                mostrarMensaje('Por favor, escribe una cantidad válida', 'error');
                return;
            }
            
            if (!sede) {
                mostrarMensaje('Por favor, selecciona una sede', 'error');
                return;
            }
            
            // Crear movimiento
            const movimiento = {
                id: Date.now(),
                producto: producto,
                cantidad: cantidad,
                tipo: 'entrada',
                sede: sede,
                descripcion: descripcion || 'Entrada de productos',
                fecha: new Date().toLocaleDateString('es-ES'),
                timestamp: new Date()
            };
            
            // Actualizar inventario
            const clave = `${producto}_${sede}`;
            if (!inventario[clave]) {
                inventario[clave] = {
                    producto: producto,
                    cantidad: 0,
                    sede: sede
                };
            }
            inventario[clave].cantidad += cantidad;
            
            // Manejar fecha de vencimiento y lote
            if (!fechaNoAplica && fechaVencimiento) {
                if (!fechasVencimiento[clave]) {
                    fechasVencimiento[clave] = [];
                }
                fechasVencimiento[clave].push({
                    fecha: fechaVencimiento,
                    cantidad: cantidad,
                    lote: lote || 'Sin lote',
                    fechaEntrada: new Date().toISOString()
                });
            }
            
            if (!loteNoAplica && lote) {
                if (!lotes[clave]) {
                    lotes[clave] = [];
                }
                lotes[clave].push({
                    lote: lote,
                    cantidad: cantidad,
                    fechaVencimiento: fechaVencimiento || 'Sin fecha',
                    fechaEntrada: new Date().toISOString()
                });
            }
            
            // Actualizar contadores
            contadores.entradas++;
            
            // Guardar datos
            guardarDatos();
            
            // Mostrar confirmación
            mostrarMensaje(`✅ Entrada registrada: ${cantidad} ${producto} en ${sede}`, 'exito');
            
            // Limpiar formulario
            limpiarFormularioEntrada();
        }
        
        function registrarSalida() {
            const producto = document.getElementById('producto-salida').value;
            const cantidad = parseInt(document.getElementById('cantidad-salida').value);
            const sede = document.getElementById('sede-salida').value;
            const sedeDestino = document.getElementById('sede-destino').value;
            const descripcion = document.getElementById('descripcion-salida').value;
            
            // Validaciones básicas
            if (!producto || !cantidad || !sede) {
                mostrarMensaje('❌ Por favor completa todos los campos obligatorios', 'error');
                return;
            }
            
            // Validación específica para salidas de bodega
            if (sede === 'BODEGA CENTRAL' && !sedeDestino) {
                mostrarMensaje('❌ Por favor selecciona la sede destino', 'error');
                return;
            }
            
            if (cantidad <= 0) {
                mostrarMensaje('❌ La cantidad debe ser mayor a 0', 'error');
                return;
            }
            
            // Verificar stock disponible
            // El producto ya viene como clave completa (producto_sede) del dropdown
            const clave = producto;
            console.log('🔍 Debug - Iniciando registrarSalida');
            console.log('🔍 Debug - Clave generada:', clave);
            console.log('🔍 Debug - Inventario completo:', inventario);
            console.log('🔍 Debug - Inventario para esta clave:', inventario[clave]);
            
            if (!inventario[clave]) {
                console.log('🔍 Debug - Producto no encontrado en inventario');
                mostrarMensaje('❌ Producto no encontrado en el inventario', 'error');
                return;
            }
            
            // Verificar si hay información de vencimiento
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            console.log('🔍 Debug - Fechas de vencimiento completas:', fechasVencimiento);
            console.log('🔍 Debug - Lotes completos:', lotes);
            console.log('🔍 Debug - Fechas para esta clave:', fechas);
            console.log('🔍 Debug - Lotes para esta clave:', lotesProducto);
            console.log('🔍 Debug - Longitud fechas:', fechas.length);
            console.log('🔍 Debug - Longitud lotes:', lotesProducto.length);
            console.log('🔍 Debug - Condición para mostrar selector:', fechas.length > 0 || lotesProducto.length > 0);
            
            if (fechas.length > 0 || lotesProducto.length > 0) {
                console.log('🔍 Debug - Entrando a mostrarSelectorLotes');
                // Hay información de vencimiento, verificar stock en lotes
                const stockTotalLotes = calcularStockTotalLotes(fechas, lotesProducto);
                console.log('🔍 Debug - Stock total en lotes:', stockTotalLotes);
                if (stockTotalLotes < cantidad) {
                    console.log('🔍 Debug - Stock insuficiente en lotes');
                    mostrarMensaje(`❌ No hay suficiente stock disponible. Solo hay ${stockTotalLotes} unidades en todos los lotes.`, 'error');
                    return;
                }
                // Mostrar selector de lotes
                console.log('🔍 Debug - Llamando a mostrarSelectorLotes');
                mostrarSelectorLotes(clave, cantidad, sede, descripcion);
            } else {
                console.log('🔍 Debug - No hay información de lotes, usando confirmación simple');
                // No hay información de lotes, verificar stock general
                if (inventario[clave].cantidad < cantidad) {
                    console.log('🔍 Debug - Stock insuficiente en inventario general');
                    mostrarMensaje('❌ No hay suficiente stock disponible', 'error');
                    return;
                }
                // No hay información de vencimiento, confirmación simple
                console.log('🔍 Debug - Mostrando confirmación simple');
                Swal.fire({
                    title: '✅ Confirmar Salida',
                    text: `¿Confirmas la salida de ${cantidad} unidades de ${inventario[clave].producto}?`,
                    icon: 'question',
                    confirmButtonText: '✅ CONFIRMAR',
                    cancelButtonText: '❌ CANCELAR',
                    showCancelButton: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        procesarSalida(clave, cantidad, sede, descripcion);
                    }
                });
            }
        }
        
        function procesarSalidaConLote(clave, cantidad, sede, descripcion, loteSeleccionado) {
            const sedeDestino = document.getElementById('sede-destino').value;
            
            // Crear movimiento con información del lote
            const movimiento = {
                id: Date.now(),
                producto: inventario[clave].producto,
                cantidad: cantidad,
                tipo: 'salida',
                sede: sede,
                descripcion: descripcion || 'Salida de productos',
                fecha: new Date().toLocaleDateString('es-ES'),
                timestamp: new Date(),
                lote: loteSeleccionado.lote,
                fechaVencimiento: loteSeleccionado.fecha,
                diasRestantes: loteSeleccionado.diasRestantes,
                sedeDestino: sedeDestino || null
            };
            
            // Agregar movimiento al historial
            historial.push(movimiento);
            
            // Actualizar inventario origen
            inventario[clave].cantidad -= cantidad;
            
            // Actualizar la cantidad del lote específico
            actualizarCantidadLote(clave, loteSeleccionado, cantidad);
            
            // Si la cantidad llega a 0, eliminar del inventario
            if (inventario[clave].cantidad <= 0) {
                delete inventario[clave];
            }
            
            // Si es salida de bodega, sumar stock a la sede destino
            if (sede === 'BODEGA CENTRAL' && sedeDestino) {
                const claveDestino = `${inventario[clave]?.producto || clave.split('_')[0]}_${sedeDestino}`;
                
                if (!inventario[claveDestino]) {
                    inventario[claveDestino] = {
                        producto: inventario[clave]?.producto || clave.split('_')[0],
                        cantidad: 0,
                        sede: sedeDestino
                    };
                }
                
                inventario[claveDestino].cantidad += cantidad;
                
                // Crear movimiento de entrada para la sede destino
                const movimientoEntrada = {
                    id: Date.now() + 1,
                    producto: inventario[clave]?.producto || clave.split('_')[0],
                    cantidad: cantidad,
                    tipo: 'entrada',
                    sede: sedeDestino,
                    descripcion: `Entrada desde ${sede} - Lote: ${loteSeleccionado.lote}`,
                    fecha: new Date().toLocaleDateString('es-ES'),
                    timestamp: new Date()
                };
                
                historial.push(movimientoEntrada);
                contadores.entradas++;
            }
            
            // Actualizar contadores
            contadores.salidas++;
            
            // Guardar datos
            guardarDatos();
            
            // Mostrar confirmación con información del lote
            const icono = loteSeleccionado.prioridad === 'alta' ? '🔴' : loteSeleccionado.prioridad === 'media' ? '🟡' : '🟢';
            let mensaje = `${icono} Salida registrada: ${cantidad} unidades del lote ${loteSeleccionado.lote} (vence en ${loteSeleccionado.diasRestantes} días)`;
            if (sede === 'BODEGA CENTRAL' && sedeDestino) {
                mensaje += ` → ${sedeDestino}`;
            }
            mostrarMensaje(mensaje, 'exito');
            
            // Limpiar formulario
            limpiarFormularioSalida();
        }
        
        function calcularStockTotalLotes(fechas, lotesProducto) {
            let stockTotal = 0;
            const lotesProcesados = new Set(); // Para evitar duplicados
            
            // Sumar stock de fechas de vencimiento
            fechas.forEach(item => {
                const loteKey = `${item.lote}_${item.fecha}`;
                if (!lotesProcesados.has(loteKey)) {
                    stockTotal += item.cantidad || 0;
                    lotesProcesados.add(loteKey);
                }
            });
            
            // Sumar stock de lotes (solo si no están ya procesados)
            lotesProducto.forEach(item => {
                const loteKey = `${item.lote}_${item.fechaVencimiento}`;
                if (!lotesProcesados.has(loteKey)) {
                    stockTotal += item.cantidad || 0;
                    lotesProcesados.add(loteKey);
                }
            });
            
            return stockTotal;
        }
        
        function actualizarCantidadLote(clave, loteSeleccionado, cantidadSacada) {
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            // Buscar y actualizar en fechas de vencimiento
            const fechaIndex = fechas.findIndex(item => item.lote === loteSeleccionado.lote && item.fecha === loteSeleccionado.fecha);
            if (fechaIndex !== -1) {
                fechas[fechaIndex].cantidad -= cantidadSacada;
                if (fechas[fechaIndex].cantidad <= 0) {
                    fechas.splice(fechaIndex, 1);
                }
                fechasVencimiento[clave] = fechas;
            }
            
            // Buscar y actualizar en lotes
            const loteIndex = lotesProducto.findIndex(item => item.lote === loteSeleccionado.lote && item.fechaVencimiento === loteSeleccionado.fecha);
            if (loteIndex !== -1) {
                lotesProducto[loteIndex].cantidad -= cantidadSacada;
                if (lotesProducto[loteIndex].cantidad <= 0) {
                    lotesProducto.splice(loteIndex, 1);
                }
                lotes[clave] = lotesProducto;
            }
        }
        
        function procesarSalida(clave, cantidad, sede, descripcion) {
            const sedeDestino = document.getElementById('sede-destino').value;
            
            // Crear movimiento
            const movimiento = {
                id: Date.now(),
                producto: inventario[clave].producto,
                cantidad: cantidad,
                tipo: 'salida',
                sede: sede,
                descripcion: descripcion || 'Salida de productos',
                fecha: new Date().toLocaleDateString('es-ES'),
                timestamp: new Date(),
                sedeDestino: sedeDestino || null
            };
            
            // Agregar movimiento al historial
            historial.push(movimiento);
            
            // Actualizar inventario origen
            inventario[clave].cantidad -= cantidad;
            
            // Si la cantidad llega a 0, eliminar del inventario
            if (inventario[clave].cantidad <= 0) {
                delete inventario[clave];
            }
            
            // Si es salida de bodega, sumar stock a la sede destino
            if (sede === 'BODEGA CENTRAL' && sedeDestino) {
                const claveDestino = `${inventario[clave]?.producto || clave.split('_')[0]}_${sedeDestino}`;
                
                if (!inventario[claveDestino]) {
                    inventario[claveDestino] = {
                        producto: inventario[clave]?.producto || clave.split('_')[0],
                        cantidad: 0,
                        sede: sedeDestino
                    };
                }
                
                inventario[claveDestino].cantidad += cantidad;
                
                // Crear movimiento de entrada para la sede destino
                const movimientoEntrada = {
                    id: Date.now() + 1,
                    producto: inventario[clave]?.producto || clave.split('_')[0],
                    cantidad: cantidad,
                    tipo: 'entrada',
                    sede: sedeDestino,
                    descripcion: `Entrada desde ${sede}`,
                    fecha: new Date().toLocaleDateString('es-ES'),
                    timestamp: new Date()
                };
                
                historial.push(movimientoEntrada);
                contadores.entradas++;
            }
            
            // Actualizar contadores
            contadores.salidas++;
            
            // Guardar datos
            guardarDatos();
            
            // Mostrar confirmación
            let mensaje = `✅ Salida registrada: ${cantidad} ${inventario[clave]?.producto || clave.split('_')[0]} de ${sede}`;
            if (sede === 'BODEGA CENTRAL' && sedeDestino) {
                mensaje += ` → ${sedeDestino}`;
            }
            mostrarMensaje(mensaje, 'exito');
            
            // Limpiar formulario
            limpiarFormularioSalida();
        }
        
        function registrarDevolucion() {
            const producto = document.getElementById('producto-devolucion').value.trim();
            const cantidad = parseInt(document.getElementById('cantidad-devolucion').value);
            const sede = document.getElementById('sede-devolucion').value;
            const motivo = document.getElementById('motivo-devolucion').value.trim();
            
            // Validaciones
            if (!producto) {
                mostrarMensaje('Por favor, escribe el nombre del producto', 'error');
                return;
            }
            
            if (!cantidad || cantidad <= 0) {
                mostrarMensaje('Por favor, escribe una cantidad válida', 'error');
                return;
            }
            
            if (!sede) {
                mostrarMensaje('Por favor, selecciona una sede', 'error');
                return;
            }
            
            // Crear movimiento
            const movimiento = {
                id: Date.now(),
                producto: producto,
                cantidad: cantidad,
                tipo: 'devolucion',
                sede: sede,
                descripcion: motivo || 'Devolución de productos',
                fecha: new Date().toLocaleDateString('es-ES'),
                timestamp: new Date()
            };
            
            // Actualizar inventario (devolución aumenta el stock)
            const clave = `${producto}_${sede}`;
            if (!inventario[clave]) {
                inventario[clave] = {
                    producto: producto,
                    cantidad: 0,
                    sede: sede
                };
            }
            inventario[clave].cantidad += cantidad;
            
            // Actualizar contadores
            contadores.devoluciones++;
            
            // Guardar datos
            guardarDatos();
            
            // Mostrar confirmación
            mostrarMensaje(`✅ Devolución registrada: ${cantidad} ${producto} en ${sede}`, 'exito');
            
            // Limpiar formulario
            limpiarFormularioDevolucion();
        }
        
        // FUNCIONES DE CARGA DE DATOS
        function cargarStock() {
            const filtroSede = document.getElementById('filtro-sede-stock').value;
            const filtroTipo = document.getElementById('filtro-tipo-stock').value;
            
            let movimientosFiltrados = historial;
            
            // Aplicar filtros
            if (filtroSede) {
                movimientosFiltrados = movimientosFiltrados.filter(mov => mov.sede === filtroSede);
            }
            
            if (filtroTipo) {
                movimientosFiltrados = movimientosFiltrados.filter(mov => mov.tipo === filtroTipo);
            }
            
            // Mostrar tabla
            const container = document.getElementById('tabla-stock-container');
            if (movimientosFiltrados.length === 0) {
                container.innerHTML = '<div class="mensaje-info">No hay movimientos para mostrar</div>';
                return;
            }
            
            let tabla = `
                <table class="tabla-stock">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Sede</th>
                            <th>Descripción</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Ordenar por fecha más reciente primero
            movimientosFiltrados.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            movimientosFiltrados.slice(0, 50).forEach(mov => {
                let colorFila = '';
                let iconoTipo = '';
                
                // Asignar colores y iconos según el tipo
                switch(mov.tipo) {
                    case 'entrada':
                        colorFila = 'background-color: #d4edda;';
                        iconoTipo = '📥';
                        break;
                    case 'salida':
                        colorFila = 'background-color: #f8d7da;';
                        iconoTipo = '📤';
                        break;
                    case 'devolucion':
                        colorFila = 'background-color: #d1ecf1;';
                        iconoTipo = '↩️';
                        break;
                }
                
                tabla += `
                    <tr style="${colorFila}">
                        <td>${mov.fecha}</td>
                        <td><strong>${iconoTipo} ${mov.tipo.toUpperCase()}</strong></td>
                        <td>${mov.producto}</td>
                        <td>${mov.cantidad}</td>
                        <td>${mov.sede}</td>
                        <td>${mov.descripcion}</td>
                    </tr>
                `;
            });
            
            tabla += '</tbody></table>';
            
            // Agregar contador de movimientos
            const contador = `<div class="mensaje-info">Mostrando ${movimientosFiltrados.length} movimientos</div>`;
            container.innerHTML = contador + tabla;
        }
        
        function obtenerInfoVencimiento(clave) {
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            if (fechas.length === 0 && lotesProducto.length === 0) {
                return 'Sin fecha';
            }
            
            const hoy = new Date();
            let alertas = [];
            
            // Verificar fechas de vencimiento
            fechas.forEach(item => {
                const fechaVenc = new Date(item.fecha);
                const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                
                if (diasRestantes <= 30) {
                    alertas.push({
                        diasRestantes: diasRestantes,
                        fecha: item.fecha,
                        lote: item.lote,
                        prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                    });
                }
            });
            
            // Verificar lotes
            lotesProducto.forEach(item => {
                if (item.fechaVencimiento && item.fechaVencimiento !== 'Sin fecha') {
                    const fechaVenc = new Date(item.fechaVencimiento);
                    const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes <= 30) {
                        alertas.push({
                            diasRestantes: diasRestantes,
                            fecha: item.fechaVencimiento,
                            lote: item.lote,
                            prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                        });
                    }
                }
            });
            
            if (alertas.length === 0) {
                return 'Sin alertas';
            }
            
            // Ordenar por prioridad
            alertas.sort((a, b) => {
                const prioridades = { alta: 3, media: 2, baja: 1 };
                return prioridades[b.prioridad] - prioridades[a.prioridad];
            });
            
            const masUrgente = alertas[0];
            const icono = masUrgente.prioridad === 'alta' ? '🔴' : masUrgente.prioridad === 'media' ? '🟡' : '🟢';
            
            return `${icono} ${masUrgente.diasRestantes} días (${masUrgente.fecha})`;
        }
        
        function generarAlertaVencimiento(clave, cantidadSolicitada) {
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            if (fechas.length === 0 && lotesProducto.length === 0) {
                return null; // No hay información de vencimiento
            }
            
            const hoy = new Date();
            const alertas = [];
            
            // Verificar fechas de vencimiento
            fechas.forEach(item => {
                const fechaVenc = new Date(item.fecha);
                const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                
                if (diasRestantes <= 30) { // Alerta si vence en 30 días o menos
                    alertas.push({
                        tipo: 'fecha',
                        diasRestantes: diasRestantes,
                        fecha: item.fecha,
                        lote: item.lote,
                        cantidad: item.cantidad,
                        prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                    });
                }
            });
            
            // Verificar lotes (si tienen fecha de vencimiento)
            lotesProducto.forEach(item => {
                if (item.fechaVencimiento && item.fechaVencimiento !== 'Sin fecha') {
                    const fechaVenc = new Date(item.fechaVencimiento);
                    const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes <= 30) {
                        alertas.push({
                            tipo: 'lote',
                            diasRestantes: diasRestantes,
                            fecha: item.fechaVencimiento,
                            lote: item.lote,
                            cantidad: item.cantidad,
                            prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                        });
                    }
                }
            });
            
            // Ordenar por prioridad y fecha
            alertas.sort((a, b) => {
                if (a.prioridad !== b.prioridad) {
                    const prioridades = { alta: 3, media: 2, baja: 1 };
                    return prioridades[b.prioridad] - prioridades[a.prioridad];
                }
                return a.diasRestantes - b.diasRestantes;
            });
            
            // Determinar qué lotes se van a sacar
            const lotesASacar = determinarLotesASacar(alertas, cantidadSolicitada);
            
            return alertas.length > 0 ? {
                producto: inventario[clave].producto,
                cantidadSolicitada: cantidadSolicitada,
                alertas: alertas,
                lotesASacar: lotesASacar
            } : null;
        }
        
        function determinarLotesASacar(alertas, cantidadSolicitada) {
            const lotesASacar = [];
            let cantidadRestante = cantidadSolicitada;
            
            // Recorrer las alertas ordenadas por prioridad
            for (const alerta of alertas) {
                if (cantidadRestante <= 0) break;
                
                const cantidadDisponible = alerta.cantidad;
                const cantidadASacar = Math.min(cantidadDisponible, cantidadRestante);
                
                lotesASacar.push({
                    lote: alerta.lote,
                    fecha: alerta.fecha,
                    diasRestantes: alerta.diasRestantes,
                    cantidad: cantidadASacar,
                    prioridad: alerta.prioridad
                });
                
                cantidadRestante -= cantidadASacar;
            }
            
            return lotesASacar;
        }
        
        function mostrarAlertaVencimiento(alerta, callback) {
            let mensaje = `⚠️ **ALERTA DE VENCIMIENTO** ⚠️\n\n`;
            mensaje += `**Producto:** ${alerta.producto}\n`;
            mensaje += `**Cantidad a sacar:** ${alerta.cantidadSolicitada}\n\n`;
            
            // Mostrar qué lotes se van a sacar
            mensaje += `**📦 LOTES QUE SE VAN A SACAR:**\n\n`;
            alerta.lotesASacar.forEach((lote, index) => {
                const icono = lote.prioridad === 'alta' ? '🔴' : lote.prioridad === 'media' ? '🟡' : '🟢';
                const prioridad = lote.prioridad === 'alta' ? 'URGENTE' : lote.prioridad === 'media' ? 'PRONTO' : 'ATENCIÓN';
                
                mensaje += `${icono} **Lote ${index + 1}:** ${lote.lote}\n`;
                mensaje += `   📅 Fecha de vencimiento: ${lote.fecha}\n`;
                mensaje += `   ⏰ Vence en: ${lote.diasRestantes} días (${prioridad})\n`;
                mensaje += `   📦 Cantidad a sacar: ${lote.cantidad}\n\n`;
            });
            
            // Mostrar información adicional de todos los lotes disponibles
            mensaje += `**📋 TODOS LOS LOTES DISPONIBLES:**\n\n`;
            alerta.alertas.forEach((item, index) => {
                const icono = item.prioridad === 'alta' ? '🔴' : item.prioridad === 'media' ? '🟡' : '🟢';
                const prioridad = item.prioridad === 'alta' ? 'URGENTE' : item.prioridad === 'media' ? 'PRONTO' : 'ATENCIÓN';
                
                mensaje += `${icono} **${prioridad}** - Vence en ${item.diasRestantes} días\n`;
                mensaje += `   📅 Fecha: ${item.fecha}\n`;
                mensaje += `   🏷️ Lote: ${item.lote}\n`;
                mensaje += `   📦 Cantidad disponible: ${item.cantidad}\n\n`;
            });
            
            mensaje += `**💡 RECOMENDACIÓN:**\n`;
            mensaje += `Se sacarán primero los lotes que vencen más pronto para evitar desperdicios.`;
            
            // Usar SweetAlert2 para mostrar la alerta
            Swal.fire({
                title: '⚠️ ALERTA DE VENCIMIENTO',
                html: mensaje.replace(/\n/g, '<br>'),
                icon: 'warning',
                confirmButtonText: '✅ CONTINUAR CON SALIDA',
                cancelButtonText: '❌ CANCELAR',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                width: '700px',
                customClass: {
                    popup: 'alerta-vencimiento-popup'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    callback();
                }
            });
        }
        
        function mostrarSelectorLotes(clave, cantidad, sede, descripcion) {
            console.log('🔍 Debug - Función mostrarSelectorLotes llamada');
            console.log('🔍 Debug - Parámetros:', { clave, cantidad, sede, descripcion });
            
            const item = inventario[clave];
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            console.log('🔍 Debug - Item del inventario:', item);
            console.log('🔍 Debug - Fechas en mostrarSelectorLotes:', fechas);
            console.log('🔍 Debug - Lotes en mostrarSelectorLotes:', lotesProducto);
            
            const hoy = new Date();
            const todosLosLotes = [];
            const lotesProcesados = new Set(); // Para evitar duplicados
            
            // Agregar fechas de vencimiento
            fechas.forEach(item => {
                const fechaVenc = new Date(item.fecha);
                const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                
                const loteKey = `${item.lote}_${item.fecha}`;
                if (!lotesProcesados.has(loteKey)) {
                    todosLosLotes.push({
                        lote: item.lote,
                        fecha: item.fecha,
                        cantidad: item.cantidad,
                        diasRestantes: diasRestantes,
                        prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja',
                        tipo: 'fecha'
                    });
                    lotesProcesados.add(loteKey);
                }
            });
            
            // Agregar lotes (solo si no están ya procesados)
            lotesProducto.forEach(item => {
                if (item.fechaVencimiento && item.fechaVencimiento !== 'Sin fecha') {
                    const fechaVenc = new Date(item.fechaVencimiento);
                    const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                    
                    const loteKey = `${item.lote}_${item.fechaVencimiento}`;
                    if (!lotesProcesados.has(loteKey)) {
                        todosLosLotes.push({
                            lote: item.lote,
                            fecha: item.fechaVencimiento,
                            cantidad: item.cantidad,
                            diasRestantes: diasRestantes,
                            prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja',
                            tipo: 'lote'
                        });
                        lotesProcesados.add(loteKey);
                    }
                }
            });
            
            // Ordenar por prioridad y fecha
            todosLosLotes.sort((a, b) => {
                if (a.prioridad !== b.prioridad) {
                    const prioridades = { alta: 3, media: 2, baja: 1 };
                    return prioridades[b.prioridad] - prioridades[a.prioridad];
                }
                return a.diasRestantes - b.diasRestantes;
            });
            
            // Crear opciones para el selector
            let opcionesHTML = '';
            let cantidadTotalDisponible = 0;
            
            todosLosLotes.forEach((lote, index) => {
                const icono = lote.prioridad === 'alta' ? '🔴' : lote.prioridad === 'media' ? '🟡' : '🟢';
                const prioridad = lote.prioridad === 'alta' ? 'URGENTE' : lote.prioridad === 'media' ? 'PRONTO' : 'ATENCIÓN';
                cantidadTotalDisponible += lote.cantidad;
                
                opcionesHTML += `
                    <option value="${index}" data-cantidad="${lote.cantidad}" data-dias="${lote.diasRestantes}">
                        ${icono} Lote: ${lote.lote} | Cantidad: ${lote.cantidad} | Vence en ${lote.diasRestantes} días (${prioridad})
                    </option>
                `;
            });
            
            // Verificar si hay suficiente stock total
            if (cantidadTotalDisponible < cantidad) {
                Swal.fire({
                    title: '⚠️ Stock Insuficiente',
                    text: `Solo hay ${cantidadTotalDisponible} unidades disponibles en todos los lotes, pero necesitas ${cantidad} unidades.`,
                    icon: 'warning',
                    confirmButtonText: '✅ Entendido'
                });
                return;
            }
            
            // Crear el HTML del modal
            const modalHTML = `
                <div style="text-align: left; max-width: 700px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">📦 Seleccionar Lote para Salida</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Producto:</strong> ${item.producto}<br>
                        <strong>Cantidad a sacar:</strong> ${cantidad} unidades<br>
                        <strong>Sede:</strong> ${sede}<br>
                        <strong>Stock total disponible:</strong> ${cantidadTotalDisponible} unidades
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="lote-selector" style="display: block; margin-bottom: 8px; font-weight: bold;">
                            🏷️ Selecciona el lote del cual quieres sacar las unidades:
                        </label>
                        <select id="lote-selector" style="width: 100%; padding: 10px; border: 2px solid #3498db; border-radius: 6px; font-size: 14px;">
                            ${opcionesHTML}
                        </select>
                    </div>
                    
                    <div id="info-lote-seleccionado" style="background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; display: none;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">📋 Información del Lote Seleccionado</h4>
                        <div id="detalles-lote"></div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong>💡 Recomendación:</strong> Se recomienda usar primero los lotes que vencen más pronto (marcados con 🔴) para evitar desperdicios.
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #28a745; font-size: 12px;">
                        <strong>📊 Resumen de Lotes:</strong><br>
                        🔴 Urgentes (≤7 días): ${todosLosLotes.filter(l => l.prioridad === 'alta').length} lotes<br>
                        🟡 Pronto (8-15 días): ${todosLosLotes.filter(l => l.prioridad === 'media').length} lotes<br>
                        🟢 Atención (>15 días): ${todosLosLotes.filter(l => l.prioridad === 'baja').length} lotes
                    </div>
                </div>
            `;
            
            // Mostrar el modal
            Swal.fire({
                title: '🏷️ Seleccionar Lote',
                html: modalHTML,
                showCancelButton: true,
                confirmButtonText: '✅ CONFIRMAR SALIDA',
                cancelButtonText: '❌ CANCELAR',
                width: '800px',
                didOpen: () => {
                    // Agregar evento para mostrar información del lote seleccionado
                    const selector = document.getElementById('lote-selector');
                    const infoDiv = document.getElementById('info-lote-seleccionado');
                    const detallesDiv = document.getElementById('detalles-lote');
                    
                    selector.addEventListener('change', function() {
                        const loteSeleccionado = todosLosLotes[this.value];
                        if (loteSeleccionado) {
                            const icono = loteSeleccionado.prioridad === 'alta' ? '🔴' : loteSeleccionado.prioridad === 'media' ? '🟡' : '🟢';
                            const prioridad = loteSeleccionado.prioridad === 'alta' ? 'URGENTE' : loteSeleccionado.prioridad === 'media' ? 'PRONTO' : 'ATENCIÓN';
                            
                            detallesDiv.innerHTML = `
                                <strong>🏷️ Lote:</strong> ${loteSeleccionado.lote}<br>
                                <strong>📅 Fecha de vencimiento:</strong> ${loteSeleccionado.fecha}<br>
                                <strong>⏰ Vence en:</strong> ${loteSeleccionado.diasRestantes} días (${prioridad})<br>
                                <strong>📦 Cantidad disponible:</strong> ${loteSeleccionado.cantidad} unidades<br>
                                <strong>📤 Cantidad a sacar:</strong> ${Math.min(loteSeleccionado.cantidad, cantidad)} unidades
                            `;
                            infoDiv.style.display = 'block';
                        } else {
                            infoDiv.style.display = 'none';
                        }
                    });
                    
                    // Mostrar información del primer lote por defecto
                    if (todosLosLotes.length > 0) {
                        selector.value = '0';
                        selector.dispatchEvent(new Event('change'));
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const selector = document.getElementById('lote-selector');
                    const loteSeleccionado = todosLosLotes[selector.value];
                    
                    if (loteSeleccionado) {
                        // Procesar la salida con información del lote específico
                        procesarSalidaConLote(clave, cantidad, sede, descripcion, loteSeleccionado);
                    }
                }
            });
        }
        
        function mostrarConfirmacionConInfo(clave, cantidad, sede, descripcion) {
            const item = inventario[clave];
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            let mensaje = `**📦 CONFIRMAR SALIDA**\n\n`;
            mensaje += `**Producto:** ${item.producto}\n`;
            mensaje += `**Cantidad a sacar:** ${cantidad}\n`;
            mensaje += `**Sede:** ${sede}\n\n`;
            
            if (fechas.length > 0 || lotesProducto.length > 0) {
                mensaje += `**📋 INFORMACIÓN DE LOTES DISPONIBLES:**\n\n`;
                
                const hoy = new Date();
                const todosLosLotes = [];
                
                const lotesProcesados = new Set(); // Para evitar duplicados
                
                // Agregar fechas de vencimiento
                fechas.forEach(item => {
                    const fechaVenc = new Date(item.fecha);
                    const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                    
                    const loteKey = `${item.lote}_${item.fecha}`;
                    if (!lotesProcesados.has(loteKey)) {
                        todosLosLotes.push({
                            lote: item.lote,
                            fecha: item.fecha,
                            cantidad: item.cantidad,
                            diasRestantes: diasRestantes,
                            prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                        });
                        lotesProcesados.add(loteKey);
                    }
                });
                
                // Agregar lotes (solo si no están ya procesados)
                lotesProducto.forEach(item => {
                    if (item.fechaVencimiento && item.fechaVencimiento !== 'Sin fecha') {
                        const fechaVenc = new Date(item.fechaVencimiento);
                        const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                        
                        const loteKey = `${item.lote}_${item.fechaVencimiento}`;
                        if (!lotesProcesados.has(loteKey)) {
                            todosLosLotes.push({
                                lote: item.lote,
                                fecha: item.fechaVencimiento,
                                cantidad: item.cantidad,
                                diasRestantes: diasRestantes,
                                prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                            });
                            lotesProcesados.add(loteKey);
                        }
                    }
                });
                
                // Ordenar por prioridad y fecha
                todosLosLotes.sort((a, b) => {
                    if (a.prioridad !== b.prioridad) {
                        const prioridades = { alta: 3, media: 2, baja: 1 };
                        return prioridades[b.prioridad] - prioridades[a.prioridad];
                    }
                    return a.diasRestantes - b.diasRestantes;
                });
                
                todosLosLotes.forEach((lote, index) => {
                    const icono = lote.prioridad === 'alta' ? '🔴' : lote.prioridad === 'media' ? '🟡' : '🟢';
                    const prioridad = lote.prioridad === 'alta' ? 'URGENTE' : lote.prioridad === 'media' ? 'PRONTO' : 'ATENCIÓN';
                    
                    mensaje += `${icono} **Lote ${index + 1}:** ${lote.lote}\n`;
                    mensaje += `   📅 Fecha de vencimiento: ${lote.fecha}\n`;
                    mensaje += `   ⏰ Vence en: ${lote.diasRestantes} días (${prioridad})\n`;
                    mensaje += `   📦 Cantidad disponible: ${lote.cantidad}\n\n`;
                });
                
                mensaje += `**💡 RECOMENDACIÓN:**\n`;
                mensaje += `Se sacarán primero los lotes que vencen más pronto para evitar desperdicios.`;
            }
            
            Swal.fire({
                title: '✅ Confirmar Salida',
                html: mensaje.replace(/\n/g, '<br>'),
                icon: 'question',
                confirmButtonText: '✅ CONFIRMAR SALIDA',
                cancelButtonText: '❌ CANCELAR',
                showCancelButton: true,
                width: '600px'
            }).then((result) => {
                if (result.isConfirmed) {
                    procesarSalida(clave, cantidad, sede, descripcion);
                }
            });
        }
        
        function cargarHistorial() {
            const filtroTipo = document.getElementById('filtro-tipo-historial').value;
            const filtroSede = document.getElementById('filtro-sede-historial').value;
            const filtroFecha = document.getElementById('filtro-fecha-historial').value;
            const filtroProducto = document.getElementById('filtro-producto-historial').value.toLowerCase().trim();
            
            let historialFiltrado = historial;
            
            // Aplicar filtros
            if (filtroTipo) {
                historialFiltrado = historialFiltrado.filter(mov => mov.tipo === filtroTipo);
            }
            
            if (filtroSede) {
                historialFiltrado = historialFiltrado.filter(mov => mov.sede === filtroSede);
            }
            
            if (filtroFecha) {
                const hoy = new Date();
                const ayer = new Date(hoy);
                ayer.setDate(hoy.getDate() - 1);
                
                historialFiltrado = historialFiltrado.filter(mov => {
                    const fechaMov = new Date(mov.timestamp);
                    switch (filtroFecha) {
                        case 'hoy':
                            return fechaMov.toDateString() === hoy.toDateString();
                        case 'ayer':
                            return fechaMov.toDateString() === ayer.toDateString();
                        case 'semana':
                            const semanaAtras = new Date(hoy);
                            semanaAtras.setDate(hoy.getDate() - 7);
                            return fechaMov >= semanaAtras;
                        case 'mes':
                            const mesAtras = new Date(hoy);
                            mesAtras.setMonth(hoy.getMonth() - 1);
                            return fechaMov >= mesAtras;
                        default:
                            return true;
                    }
                });
            }
            
            // Filtro por producto
            if (filtroProducto) {
                historialFiltrado = historialFiltrado.filter(mov => 
                    mov.producto.toLowerCase().includes(filtroProducto)
                );
            }
            
            // Mostrar tabla
            const container = document.getElementById('tabla-historial-container');
            if (historialFiltrado.length === 0) {
                let mensaje = 'No hay movimientos para mostrar';
                if (filtroProducto || filtroTipo || filtroSede || filtroFecha) {
                    mensaje = 'No hay movimientos que coincidan con los filtros aplicados';
                }
                container.innerHTML = `<div class="mensaje-info">${mensaje}</div>`;
                return;
            }
            
            // Mostrar información de filtros aplicados
            let infoFiltros = '';
            const filtrosAplicados = [];
            if (filtroTipo) filtrosAplicados.push(`Tipo: ${filtroTipo}`);
            if (filtroSede) filtrosAplicados.push(`Sede: ${filtroSede}`);
            if (filtroFecha) filtrosAplicados.push(`Fecha: ${filtroFecha}`);
            if (filtroProducto) filtrosAplicados.push(`Producto: ${filtroProducto}`);
            
            if (filtrosAplicados.length > 0) {
                infoFiltros = `<div class="info-filtros">🔍 Filtros aplicados: ${filtrosAplicados.join(' | ')} | 📊 Mostrando ${historialFiltrado.length} movimientos</div>`;
            }
            
            let tabla = `
                <table class="tabla-stock">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Tipo</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Sede</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            historialFiltrado.slice(-50).forEach(mov => {
                const iconoTipo = mov.tipo === 'entrada' ? '📥' : 
                                 mov.tipo === 'salida' ? '📤' : '↩️';
                
                // Formatear fecha y hora
                let fechaHora = mov.fecha;
                if (mov.timestamp) {
                    const fecha = new Date(mov.timestamp);
                    fechaHora = fecha.toLocaleDateString('es-ES') + ' ' + fecha.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
                
                // Generar detalles según el tipo de movimiento
                let detalles = '';
                
                if (mov.tipo === 'salida') {
                    let detallesSalida = [];
                    
                    // Solo mostrar lote y destino (como solicitó el usuario)
                    if (mov.lote) {
                        detallesSalida.push(`📦 Lote: ${mov.lote}`);
                    }
                    
                    // Sede destino si existe
                    if (mov.sedeDestino) {
                        detallesSalida.push(`🎯 Destino: ${mov.sedeDestino}`);
                    }
                    
                    detalles = detallesSalida.join('<br>');
                } else if (mov.tipo === 'entrada') {
                    let detallesEntrada = [];
                    
                    // Solo mostrar lote para entradas
                    if (mov.lote) {
                        detallesEntrada.push(`📦 Lote: ${mov.lote}`);
                    }
                    
                    detalles = detallesEntrada.join('<br>');
                }
                
                tabla += `
                    <tr>
                        <td>${fechaHora}</td>
                        <td>${iconoTipo} ${mov.tipo.toUpperCase()}</td>
                        <td>${mov.producto}</td>
                        <td>${mov.cantidad}</td>
                        <td>${mov.sede}</td>
                        <td class="detalles-movimiento">${detalles}</td>
                    </tr>
                `;
            });
            
            tabla += '</tbody></table>';
            container.innerHTML = infoFiltros + tabla;
        }
        
        function limpiarFiltroProducto() {
            const input = document.getElementById('filtro-producto-historial');
            const sugerencias = document.getElementById('sugerencias-producto-historial');
            
            input.value = '';
            sugerencias.style.display = 'none';
            cargarHistorial(); // Recargar historial sin filtro
            
            console.log('Filtro de producto limpiado');
        }
        
        function filtrarPorProducto() {
            const input = document.getElementById('filtro-producto-historial');
            const sugerencias = document.getElementById('sugerencias-producto-historial');
            const valor = input.value.toLowerCase().trim();
            
            // Ocultar sugerencias si no hay texto
            if (!valor) {
                sugerencias.style.display = 'none';
                cargarHistorial(); // Recargar historial sin filtro
                return;
            }
            
            // Obtener productos únicos del historial
            const productosUnicos = [...new Set(historial.map(mov => mov.producto))];
            
            // Filtrar productos que coincidan
            const productosFiltrados = productosUnicos.filter(producto => 
                producto.toLowerCase().includes(valor)
            ).slice(0, 10); // Limitar a 10 sugerencias
            
            // Mostrar sugerencias
            if (productosFiltrados.length > 0) {
                sugerencias.innerHTML = '';
                productosFiltrados.forEach(producto => {
                    const div = document.createElement('div');
                    div.className = 'sugerencia-item';
                    div.textContent = producto;
                    div.onclick = () => {
                        input.value = producto;
                        sugerencias.style.display = 'none';
                        cargarHistorial(); // Recargar historial con el filtro
                    };
                    sugerencias.appendChild(div);
                });
                sugerencias.style.display = 'block';
            } else {
                sugerencias.style.display = 'none';
            }
            
            // Recargar historial con el filtro actual
            cargarHistorial();
        }
        
        function buscarLoteEnSedes() {
            const loteBuscar = document.getElementById('lote-buscar').value.trim();
            const productoFiltro = document.getElementById('producto-lote-buscar').value.toLowerCase().trim();
            const resultadoDiv = document.getElementById('resultado-busqueda-lotes');
            const infoDiv = document.getElementById('info-busqueda-lotes');
            const tablaDiv = document.getElementById('tabla-lotes-sedes');
            
            if (!loteBuscar) {
                mostrarMensaje('❌ Por favor ingresa un número de lote para buscar', 'error');
                return;
            }
            
            // Buscar el lote en todas las sedes
            const resultados = [];
            
            Object.keys(inventario).forEach(clave => {
                const item = inventario[clave];
                const lotesProducto = lotes[clave] || [];
                
                // Filtrar por producto si se especifica
                if (productoFiltro && !item.producto.toLowerCase().includes(productoFiltro)) {
                    return;
                }
                
                // Buscar el lote en este producto
                lotesProducto.forEach(lote => {
                    if (lote.lote.toLowerCase().includes(loteBuscar.toLowerCase())) {
                        resultados.push({
                            sede: item.sede,
                            producto: item.producto,
                            cantidad: lote.cantidad,
                            lote: lote.lote,
                            fechaVencimiento: lote.fecha,
                            diasRestantes: lote.diasRestantes
                        });
                    }
                });
            });
            
            // Mostrar resultados
            if (resultados.length > 0) {
                // Agrupar por sede
                const resultadosPorSede = {};
                resultados.forEach(resultado => {
                    const key = `${resultado.sede}_${resultado.producto}_${resultado.lote}`;
                    if (!resultadosPorSede[key]) {
                        resultadosPorSede[key] = {
                            sede: resultado.sede,
                            producto: resultado.producto,
                            lote: resultado.lote,
                            cantidad: 0,
                            fechaVencimiento: resultado.fechaVencimiento,
                            diasRestantes: resultado.diasRestantes
                        };
                    }
                    resultadosPorSede[key].cantidad += resultado.cantidad;
                });
                
                // Generar HTML
                let html = '';
                Object.values(resultadosPorSede).forEach(resultado => {
                    const iconoPrioridad = resultado.diasRestantes <= 7 ? '🔴' : 
                                          resultado.diasRestantes <= 30 ? '🟡' : '🟢';
                    
                    html += `
                        <div class="lote-sede-item">
                            <div class="lote-sede-header">
                                <div class="lote-sede-sede">🏢 ${resultado.sede}</div>
                                <div class="lote-sede-cantidad">📦 ${resultado.cantidad} unidades</div>
                            </div>
                            <div class="lote-sede-detalles">
                                <div class="lote-sede-detalle">
                                    <span class="icono">📦</span>
                                    <span><strong>Lote:</strong> ${resultado.lote}</span>
                                </div>
                                <div class="lote-sede-detalle">
                                    <span class="icono">📅</span>
                                    <span><strong>Vence:</strong> ${resultado.fechaVencimiento}</span>
                                </div>
                                <div class="lote-sede-detalle">
                                    <span class="icono">${iconoPrioridad}</span>
                                    <span><strong>Días restantes:</strong> ${resultado.diasRestantes}</span>
                                </div>
                                <div class="lote-sede-detalle">
                                    <span class="icono">🏷️</span>
                                    <span><strong>Producto:</strong> ${resultado.producto}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                infoDiv.innerHTML = `🔍 Lote "${loteBuscar}" encontrado en ${Object.keys(resultadosPorSede).length} ubicación(es)`;
                tablaDiv.innerHTML = html;
                resultadoDiv.style.display = 'block';
                
            } else {
                infoDiv.innerHTML = `❌ No se encontró el lote "${loteBuscar}" en ninguna sede`;
                tablaDiv.innerHTML = '<div class="mensaje-info">No hay productos con este lote en el inventario</div>';
                resultadoDiv.style.display = 'block';
            }
        }
        
        function limpiarBusquedaLote() {
            document.getElementById('lote-buscar').value = '';
            document.getElementById('producto-lote-buscar').value = '';
            document.getElementById('resultado-busqueda-lotes').style.display = 'none';
            document.getElementById('sugerencias-lote-buscar').style.display = 'none';
        }
        
        function mostrarTodosLosLotes() {
            const resultadoDiv = document.getElementById('resultado-busqueda-lotes');
            const infoDiv = document.getElementById('info-busqueda-lotes');
            const tablaDiv = document.getElementById('tabla-lotes-sedes');
            
            // Obtener todos los lotes del inventario
            const todosLosLotes = [];
            
            Object.keys(inventario).forEach(clave => {
                const item = inventario[clave];
                const lotesProducto = lotes[clave] || [];
                
                lotesProducto.forEach(lote => {
                    todosLosLotes.push({
                        sede: item.sede,
                        producto: item.producto,
                        lote: lote.lote,
                        cantidad: lote.cantidad,
                        fechaVencimiento: lote.fecha,
                        diasRestantes: lote.diasRestantes
                    });
                });
            });
            
            if (todosLosLotes.length > 0) {
                // Agrupar por lote
                const lotesAgrupados = {};
                todosLosLotes.forEach(lote => {
                    const key = `${lote.lote}_${lote.producto}`;
                    if (!lotesAgrupados[key]) {
                        lotesAgrupados[key] = {
                            lote: lote.lote,
                            producto: lote.producto,
                            sedes: [],
                            cantidadTotal: 0,
                            fechaVencimiento: lote.fechaVencimiento,
                            diasRestantes: lote.diasRestantes
                        };
                    }
                    lotesAgrupados[key].sedes.push({
                        sede: lote.sede,
                        cantidad: lote.cantidad
                    });
                    lotesAgrupados[key].cantidadTotal += lote.cantidad;
                });
                
                // Generar HTML
                let html = '';
                Object.values(lotesAgrupados).forEach(lote => {
                    const iconoPrioridad = lote.diasRestantes <= 7 ? '🔴' : 
                                          lote.diasRestantes <= 30 ? '🟡' : '🟢';
                    
                    html += `
                        <div class="lote-sede-item">
                            <div class="lote-sede-header">
                                <div class="lote-sede-sede">📦 Lote: ${lote.lote}</div>
                                <div class="lote-sede-cantidad">📊 ${lote.cantidadTotal} unidades total</div>
                            </div>
                            <div class="lote-sede-detalles">
                                <div class="lote-sede-detalle">
                                    <span class="icono">🏷️</span>
                                    <span><strong>Producto:</strong> ${lote.producto}</span>
                                </div>
                                <div class="lote-sede-detalle">
                                    <span class="icono">📅</span>
                                    <span><strong>Vence:</strong> ${lote.fechaVencimiento}</span>
                                </div>
                                <div class="lote-sede-detalle">
                                    <span class="icono">${iconoPrioridad}</span>
                                    <span><strong>Días restantes:</strong> ${lote.diasRestantes}</span>
                                </div>
                                <div class="lote-sede-detalle">
                                    <span class="icono">🏢</span>
                                    <span><strong>Sedes:</strong> ${lote.sedes.length}</span>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <strong>📍 Distribución por sedes:</strong><br>
                                ${lote.sedes.map(sede => `• ${sede.sede}: ${sede.cantidad} unidades`).join('<br>')}
                            </div>
                        </div>
                    `;
                });
                
                infoDiv.innerHTML = `📋 Mostrando todos los ${Object.keys(lotesAgrupados).length} lotes en el inventario`;
                tablaDiv.innerHTML = html;
                resultadoDiv.style.display = 'block';
                
            } else {
                infoDiv.innerHTML = '❌ No hay lotes registrados en el inventario';
                tablaDiv.innerHTML = '<div class="mensaje-info">No hay productos con lotes en el inventario</div>';
                resultadoDiv.style.display = 'block';
            }
        }
        
        function exportarLotesExcel() {
            const loteBuscar = document.getElementById('lote-buscar').value.trim();
            const productoFiltro = document.getElementById('producto-lote-buscar').value.toLowerCase().trim();
            
            // Obtener datos para exportar
            let datos = [];
            
            if (loteBuscar) {
                // Exportar búsqueda específica
                Object.keys(inventario).forEach(clave => {
                    const item = inventario[clave];
                    const lotesProducto = lotes[clave] || [];
                    
                    if (productoFiltro && !item.producto.toLowerCase().includes(productoFiltro)) {
                        return;
                    }
                    
                    lotesProducto.forEach(lote => {
                        if (lote.lote.toLowerCase().includes(loteBuscar.toLowerCase())) {
                            datos.push({
                                'Producto': item.producto,
                                'Cantidad': lote.cantidad,
                                'Fecha': new Date().toISOString().split('T')[0], // Fecha actual
                                'Lote': lote.lote,
                                'Fecha de Vencimiento': lote.fecha || 'N/A',
                                'Sede': item.sede,
                                'Días Restantes': lote.diasRestantes || 'N/A'
                            });
                        }
                    });
                });
            } else {
                // Exportar todos los lotes
                Object.keys(inventario).forEach(clave => {
                    const item = inventario[clave];
                    const lotesProducto = lotes[clave] || [];
                    
                    lotesProducto.forEach(lote => {
                        datos.push({
                            'Producto': item.producto,
                            'Cantidad': lote.cantidad,
                            'Fecha': new Date().toISOString().split('T')[0], // Fecha actual
                            'Lote': lote.lote,
                            'Fecha de Vencimiento': lote.fecha || 'N/A',
                            'Sede': item.sede,
                            'Días Restantes': lote.diasRestantes || 'N/A'
                        });
                    });
                });
            }
            
            if (datos.length === 0) {
                mostrarMensaje('❌ No hay datos para exportar', 'error');
                return;
            }
            
            // Crear workbook y worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            
            // Ajustar ancho de columnas
            const colWidths = [
                { wch: 30 }, // Producto
                { wch: 10 }, // Cantidad
                { wch: 12 }, // Fecha
                { wch: 15 }, // Lote
                { wch: 15 }, // Fecha de Vencimiento
                { wch: 25 }, // Sede
                { wch: 15 }  // Días Restantes
            ];
            ws['!cols'] = colWidths;
            
            // Agregar worksheet al workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Lotes por Sedes');
            
            // Generar nombre del archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = loteBuscar ? 
                `Lotes_${loteBuscar}_${fecha}.xlsx` : 
                `Todos_Lotes_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarMensaje('✅ Archivo Excel exportado correctamente', 'exito');
        }
        
        function cargarStock() {
            const filtroProducto = document.getElementById('filtro-producto-stock').value.toLowerCase().trim();
            const filtroSede = document.getElementById('filtro-sede-stock').value;
            const filtroPrioridad = document.getElementById('filtro-prioridad-stock').value;
            const container = document.getElementById('tabla-stock-container');
            const infoDiv = document.getElementById('info-stock');
            
            // Filtrar inventario
            let stockFiltrado = [];
            
            Object.keys(inventario).forEach(clave => {
                const item = inventario[clave];
                
                // Aplicar filtros
                if (filtroProducto && !item.producto.toLowerCase().includes(filtroProducto)) {
                    return;
                }
                
                if (filtroSede && item.sede !== filtroSede) {
                    return;
                }
                
                // Verificar prioridad si hay lotes
                const lotesProducto = lotes[clave] || [];
                if (filtroPrioridad && lotesProducto.length > 0) {
                    const tienePrioridad = lotesProducto.some(lote => {
                        switch (filtroPrioridad) {
                            case 'urgente':
                                return lote.diasRestantes <= 7;
                            case 'pronto':
                                return lote.diasRestantes > 7 && lote.diasRestantes <= 30;
                            case 'atencion':
                                return lote.diasRestantes > 30;
                            case 'sin-vencimiento':
                                return lote.diasRestantes === undefined || lote.diasRestantes === null;
                            default:
                                return true;
                        }
                    });
                    
                    if (!tienePrioridad) {
                        return;
                    }
                }
                
                stockFiltrado.push({
                    clave: clave,
                    item: item,
                    lotes: lotesProducto
                });
            });
            
            // Mostrar información de filtros
            if (filtroProducto || filtroSede || filtroPrioridad) {
                const filtrosAplicados = [];
                if (filtroProducto) filtrosAplicados.push(`Producto: "${filtroProducto}"`);
                if (filtroSede) filtrosAplicados.push(`Sede: ${filtroSede}`);
                if (filtroPrioridad) filtrosAplicados.push(`Prioridad: ${filtroPrioridad}`);
                
                infoDiv.innerHTML = `🔍 Filtros aplicados: ${filtrosAplicados.join(' | ')} | 📊 Mostrando ${stockFiltrado.length} productos`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
            
            // Mostrar stock
            if (stockFiltrado.length === 0) {
                container.innerHTML = '<div class="mensaje-info">No hay productos que coincidan con los filtros aplicados</div>';
                return;
            }
            
            let html = '';
            stockFiltrado.forEach(stock => {
                const item = stock.item;
                const lotesProducto = stock.lotes;
                
                html += `
                    <div class="stock-item">
                        <div class="stock-header">
                            <div>
                                <div class="stock-producto">${item.producto}</div>
                                <div class="stock-sede">🏢 ${item.sede}</div>
                            </div>
                            <div class="stock-cantidad">📦 ${item.cantidad} unidades</div>
                        </div>
                `;
                
                if (lotesProducto.length > 0) {
                    html += `
                        <div class="stock-lotes">
                            <div class="stock-lotes-titulo">
                                📋 LOTES DISPONIBLES (${lotesProducto.length})
                            </div>
                            <div class="lote-item" style="grid-template-columns: 1fr 1fr 1fr auto; font-weight: bold; background: #e9ecef;">
                                <div>📦 Lote</div>
                                <div style="text-align: center;">📊 Cantidad</div>
                                <div style="text-align: center;">📅 Vence</div>
                                <div style="text-align: center;">⏰ Prioridad</div>
                            </div>
                    `;
                    
                    lotesProducto.forEach(lote => {
                        let prioridadClass = 'prioridad-sin-vencimiento';
                        let prioridadText = 'Sin vencimiento';
                        
                        if (lote.diasRestantes !== undefined && lote.diasRestantes !== null) {
                            if (lote.diasRestantes <= 7) {
                                prioridadClass = 'prioridad-urgente';
                                prioridadText = `🔴 ${lote.diasRestantes} días`;
                            } else if (lote.diasRestantes <= 30) {
                                prioridadClass = 'prioridad-pronto';
                                prioridadText = `🟡 ${lote.diasRestantes} días`;
                            } else {
                                prioridadClass = 'prioridad-atencion';
                                prioridadText = `🟢 ${lote.diasRestantes} días`;
                            }
                        }
                        
                        html += `
                            <div class="lote-item">
                                <div class="lote-numero">${lote.lote}</div>
                                <div class="lote-cantidad">${lote.cantidad}</div>
                                <div class="lote-vencimiento">${lote.fecha || 'N/A'}</div>
                                <div class="lote-prioridad ${prioridadClass}">${prioridadText}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += `
                        <div class="stock-sin-lotes">
                            📝 Este producto no tiene información de lotes registrada
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function filtrarStock() {
            const input = document.getElementById('filtro-producto-stock');
            const sugerencias = document.getElementById('sugerencias-producto-stock');
            const valor = input.value.toLowerCase().trim();
            
            // Ocultar sugerencias si no hay texto
            if (!valor) {
                sugerencias.style.display = 'none';
                cargarStock(); // Recargar stock sin filtro
                return;
            }
            
            // Obtener productos únicos del inventario
            const productosUnicos = [...new Set(Object.values(inventario).map(item => item.producto))];
            
            // Filtrar productos que coincidan
            const productosFiltrados = productosUnicos.filter(producto => 
                producto.toLowerCase().includes(valor)
            ).slice(0, 10); // Limitar a 10 sugerencias
            
            // Mostrar sugerencias
            if (productosFiltrados.length > 0) {
                sugerencias.innerHTML = '';
                productosFiltrados.forEach(producto => {
                    const div = document.createElement('div');
                    div.className = 'sugerencia-item';
                    div.textContent = producto;
                    div.onclick = () => {
                        input.value = producto;
                        sugerencias.style.display = 'none';
                        cargarStock(); // Recargar stock con el filtro
                    };
                    sugerencias.appendChild(div);
                });
                sugerencias.style.display = 'block';
            } else {
                sugerencias.style.display = 'none';
            }
            
            // Recargar stock con el filtro actual
            cargarStock();
        }
        
        function limpiarFiltroStock() {
            document.getElementById('filtro-producto-stock').value = '';
            document.getElementById('filtro-sede-stock').value = '';
            document.getElementById('filtro-prioridad-stock').value = '';
            document.getElementById('sugerencias-producto-stock').style.display = 'none';
            cargarStock(); // Recargar stock sin filtros
        }
        
        function exportarStockExcel() {
            const filtroProducto = document.getElementById('filtro-producto-stock').value.toLowerCase().trim();
            const filtroSede = document.getElementById('filtro-sede-stock').value;
            const filtroPrioridad = document.getElementById('filtro-prioridad-stock').value;
            
            // Obtener datos para exportar
            let datos = [];
            
            Object.keys(inventario).forEach(clave => {
                const item = inventario[clave];
                const lotesProducto = lotes[clave] || [];
                
                // Aplicar filtros
                if (filtroProducto && !item.producto.toLowerCase().includes(filtroProducto)) {
                    return;
                }
                
                if (filtroSede && item.sede !== filtroSede) {
                    return;
                }
                
                if (filtroPrioridad && lotesProducto.length > 0) {
                    const tienePrioridad = lotesProducto.some(lote => {
                        switch (filtroPrioridad) {
                            case 'urgente':
                                return lote.diasRestantes <= 7;
                            case 'pronto':
                                return lote.diasRestantes > 7 && lote.diasRestantes <= 30;
                            case 'atencion':
                                return lote.diasRestantes > 30;
                            case 'sin-vencimiento':
                                return lote.diasRestantes === undefined || lote.diasRestantes === null;
                            default:
                                return true;
                        }
                    });
                    
                    if (!tienePrioridad) {
                        return;
                    }
                }
                
                if (lotesProducto.length > 0) {
                    // Exportar cada lote por separado
                    lotesProducto.forEach(lote => {
                        let prioridad = 'Sin vencimiento';
                        if (lote.diasRestantes !== undefined && lote.diasRestantes !== null) {
                            if (lote.diasRestantes <= 7) {
                                prioridad = `Urgente (${lote.diasRestantes} días)`;
                            } else if (lote.diasRestantes <= 30) {
                                prioridad = `Pronto (${lote.diasRestantes} días)`;
                            } else {
                                prioridad = `Atención (${lote.diasRestantes} días)`;
                            }
                        }
                        
                        datos.push({
                            'Producto': item.producto,
                            'Cantidad': lote.cantidad,
                            'Fecha': new Date().toISOString().split('T')[0], // Fecha actual
                            'Lote': lote.lote,
                            'Fecha de Vencimiento': lote.fecha || 'N/A',
                            'Sede': item.sede,
                            'Prioridad': prioridad
                        });
                    });
                } else {
                    // Producto sin lotes
                    datos.push({
                        'Producto': item.producto,
                        'Cantidad': item.cantidad,
                        'Fecha': new Date().toISOString().split('T')[0], // Fecha actual
                        'Lote': 'N/A',
                        'Fecha de Vencimiento': 'N/A',
                        'Sede': item.sede,
                        'Prioridad': 'Sin lotes'
                    });
                }
            });
            
            if (datos.length === 0) {
                mostrarMensaje('❌ No hay datos para exportar', 'error');
                return;
            }
            
            // Crear workbook y worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datos);
            
            // Ajustar ancho de columnas
            const colWidths = [
                { wch: 30 }, // Producto
                { wch: 25 }, // Sede
                { wch: 15 }, // Lote
                { wch: 10 }, // Cantidad
                { wch: 15 }, // Fecha Vencimiento
                { wch: 15 }, // Días Restantes
                { wch: 20 }  // Prioridad
            ];
            ws['!cols'] = colWidths;
            
            // Agregar worksheet al workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Stock Actual');
            
            // Generar nombre del archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `Stock_Actual_${fecha}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarMensaje('✅ Archivo Excel exportado correctamente', 'exito');
        }
        
        function mostrarResumenStock() {
            const totalProductos = Object.keys(inventario).length;
            const totalUnidades = Object.values(inventario).reduce((sum, item) => sum + item.cantidad, 0);
            
            let productosConLotes = 0;
            let productosSinLotes = 0;
            let lotesUrgentes = 0;
            let lotesProntos = 0;
            let lotesAtencion = 0;
            
            Object.keys(inventario).forEach(clave => {
                const lotesProducto = lotes[clave] || [];
                if (lotesProducto.length > 0) {
                    productosConLotes++;
                    lotesProducto.forEach(lote => {
                        if (lote.diasRestantes !== undefined && lote.diasRestantes !== null) {
                            if (lote.diasRestantes <= 7) {
                                lotesUrgentes++;
                            } else if (lote.diasRestantes <= 30) {
                                lotesProntos++;
                            } else {
                                lotesAtencion++;
                            }
                        }
                    });
                } else {
                    productosSinLotes++;
                }
            });
            
            const mensaje = `
                <div style="text-align: left; line-height: 1.6;">
                    <h3>📊 RESUMEN DEL INVENTARIO</h3>
                    <p><strong>📦 Total de productos:</strong> ${totalProductos}</p>
                    <p><strong>📊 Total de unidades:</strong> ${totalUnidades}</p>
                    <p><strong>📋 Productos con lotes:</strong> ${productosConLotes}</p>
                    <p><strong>📝 Productos sin lotes:</strong> ${productosSinLotes}</p>
                    <br>
                    <h4>⏰ LOTES POR PRIORIDAD:</h4>
                    <p><strong>🔴 Urgentes (≤ 7 días):</strong> ${lotesUrgentes}</p>
                    <p><strong>🟡 Prontos (8-30 días):</strong> ${lotesProntos}</p>
                    <p><strong>🟢 Atención (> 30 días):</strong> ${lotesAtencion}</p>
                </div>
            `;
            
            Swal.fire({
                title: '📊 Resumen del Inventario',
                html: mensaje,
                icon: 'info',
                confirmButtonText: '✅ ENTENDIDO',
                width: '500px'
            });
        }
        
        function crearDatosPruebaReporte() {
            Swal.fire({
                title: '🧪 Crear Datos de Prueba',
                text: '¿Quieres crear datos de prueba para poder generar reportes? Esto agregará movimientos de ejemplo.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '✅ SÍ, CREAR',
                cancelButtonText: '❌ CANCELAR'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Crear datos de prueba para reportes
                    const hoy = new Date();
                    const ayer = new Date(hoy);
                    ayer.setDate(hoy.getDate() - 1);
                    const anteayer = new Date(hoy);
                    anteayer.setDate(hoy.getDate() - 2);
                    
                    // Limpiar historial existente
                    historial = [];
                    
                    // Datos de prueba para hoy
                    historial.push({
                        fecha: hoy.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Arroz premium 1000 Gramos',
                        cantidad: 20,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE Alejandro Vélez Barrientos',
                        descripcion: 'Envío semanal',
                        lote: 'LOTE-001',
                        timestamp: hoy.getTime()
                    });
                    
                    historial.push({
                        fecha: hoy.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Leche en polvo 900 a 1000 grs',
                        cantidad: 15,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE El Salado',
                        descripcion: 'Envío para comedor',
                        lote: 'LOTE-003',
                        timestamp: hoy.getTime()
                    });
                    
                    historial.push({
                        fecha: hoy.toISOString().split('T')[0],
                        tipo: 'entrada',
                        producto: 'Tomate 1000 grs',
                        cantidad: 25,
                        sede: 'IE Alejandro Vélez Barrientos',
                        descripcion: 'Compra local',
                        lote: 'LOTE-URG-001',
                        timestamp: hoy.getTime()
                    });
                    
                    // Datos de prueba para ayer
                    historial.push({
                        fecha: ayer.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Arroz premium 1000 Gramos',
                        cantidad: 10,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE Comercial de Envigado',
                        descripcion: 'Envío diario',
                        lote: 'LOTE-002',
                        timestamp: ayer.getTime()
                    });
                    
                    historial.push({
                        fecha: ayer.toISOString().split('T')[0],
                        tipo: 'entrada',
                        producto: 'Leche en polvo 900 a 1000 grs',
                        cantidad: 30,
                        sede: 'BODEGA CENTRAL',
                        descripcion: 'Recepción de proveedor',
                        lote: 'LOTE-003',
                        timestamp: ayer.getTime()
                    });
                    
                    // Datos de prueba para anteayer
                    historial.push({
                        fecha: anteayer.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Arroz premium 1000 Gramos',
                        cantidad: 15,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE Darío de Bedout',
                        descripcion: 'Envío programado',
                        lote: 'LOTE-001',
                        timestamp: anteayer.getTime()
                    });
                    
                    historial.push({
                        fecha: anteayer.toISOString().split('T')[0],
                        tipo: 'entrada',
                        producto: 'Leche en polvo 900 a 1000 grs',
                        cantidad: 25,
                        sede: 'BODEGA CENTRAL',
                        descripcion: 'Compra mayorista',
                        lote: 'LOTE-004',
                        timestamp: anteayer.getTime()
                    });
                    
                    // Guardar datos
                    guardarDatos();
                    
                    Swal.fire({
                        title: '✅ Datos de Prueba Creados',
                        html: `
                            <div style="text-align: left; line-height: 1.6;">
                                <p><strong>📊 Se han creado datos de prueba para:</strong></p>
                                <p>• <strong>Hoy:</strong> ${hoy.toISOString().split('T')[0]} - 3 movimientos</p>
                                <p>• <strong>Ayer:</strong> ${ayer.toISOString().split('T')[0]} - 2 movimientos</p>
                                <p>• <strong>Anteayer:</strong> ${anteayer.toISOString().split('T')[0]} - 2 movimientos</p>
                                <br>
                                <p><strong>💡 Ahora puedes:</strong></p>
                                <p>1. Seleccionar una de estas fechas</p>
                                <p>2. Elegir una institución</p>
                                <p>3. Hacer clic en "GENERAR REPORTE"</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: '✅ ENTENDIDO'
                    });
                }
            });
        }
        
        function probarReporteMensual() {
            console.log('🔧 Función de prueba ejecutada');
            console.log('📊 Historial actual:', historial);
            console.log('📅 Campo mes-reporte:', document.getElementById('mes-reporte'));
            console.log('📅 Valor del campo:', document.getElementById('mes-reporte').value);
            
            // Intentar generar reporte
            generarReporteMensual();
        }
        
        function cargarProductosParaSalida() {
            const select = document.getElementById('producto-salida');
            select.innerHTML = '<option value="">Selecciona un producto del stock</option>';
            
            let productosDisponibles = 0;
            
            Object.keys(inventario).forEach(clave => {
                const item = inventario[clave];
                if (item.cantidad > 0) {
                    const option = document.createElement('option');
                    option.value = clave;
                    option.textContent = `${item.producto} (${item.cantidad} disponibles) - ${item.sede}`;
                    select.appendChild(option);
                    productosDisponibles++;
                }
            });
            
            if (productosDisponibles === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "❌ No hay productos disponibles en stock";
                option.disabled = true;
                select.appendChild(option);
            }
            
            // Agregar event listener para actualizar sede automáticamente y mostrar info de lotes
            select.addEventListener('change', function() {
                const productoSeleccionado = this.value;
                if (productoSeleccionado) {
                    const item = inventario[productoSeleccionado];
                    if (item) {
                        document.getElementById('sede-salida').value = item.sede;
                        
                        // Mostrar información rápida de lotes si existe
                        mostrarInfoRapidaLotes(productoSeleccionado);
                    }
                }
            });
        }
        
        function verDetallesLotes(clave) {
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            const item = inventario[clave];
            
            if (!item) {
                mostrarMensaje('Error: No se encontró el producto en el inventario', 'error');
                return;
            }
            
            let mensaje = `**📦 DETALLES DE LOTES**\n\n`;
            mensaje += `**Producto:** ${item.producto}\n`;
            mensaje += `**Sede:** ${item.sede}\n`;
            mensaje += `**Stock total:** ${item.cantidad}\n\n`;
            
            if (fechas.length === 0 && lotesProducto.length === 0) {
                mensaje += `❌ No hay información de lotes o fechas de vencimiento registrada.\n\n`;
                mensaje += `💡 **Recomendación:** Para ver los lotes disponibles, asegúrate de que al registrar las entradas del producto se hayan incluido las fechas de vencimiento y números de lote.`;
            } else {
                const hoy = new Date();
                const todosLosLotes = [];
                
                const lotesProcesados = new Set(); // Para evitar duplicados
                
                // Agregar fechas de vencimiento
                fechas.forEach(item => {
                    const fechaVenc = new Date(item.fecha);
                    const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                    
                    const loteKey = `${item.lote}_${item.fecha}`;
                    if (!lotesProcesados.has(loteKey)) {
                        todosLosLotes.push({
                            lote: item.lote,
                            fecha: item.fecha,
                            cantidad: item.cantidad,
                            diasRestantes: diasRestantes,
                            prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja',
                            tipo: 'fecha'
                        });
                        lotesProcesados.add(loteKey);
                    }
                });
                
                // Agregar lotes (solo si no están ya procesados)
                lotesProducto.forEach(item => {
                    if (item.fechaVencimiento && item.fechaVencimiento !== 'Sin fecha') {
                        const fechaVenc = new Date(item.fechaVencimiento);
                        const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                        
                        const loteKey = `${item.lote}_${item.fechaVencimiento}`;
                        if (!lotesProcesados.has(loteKey)) {
                            todosLosLotes.push({
                                lote: item.lote,
                                fecha: item.fechaVencimiento,
                                cantidad: item.cantidad,
                                diasRestantes: diasRestantes,
                                prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja',
                                tipo: 'lote'
                            });
                            lotesProcesados.add(loteKey);
                        }
                    }
                });
                
                // Ordenar por prioridad y fecha (los que vencen primero aparecen primero)
                todosLosLotes.sort((a, b) => {
                    if (a.prioridad !== b.prioridad) {
                        const prioridades = { alta: 3, media: 2, baja: 1 };
                        return prioridades[b.prioridad] - prioridades[a.prioridad];
                    }
                    return a.diasRestantes - b.diasRestantes;
                });
                
                mensaje += `**📋 LOTES DISPONIBLES:**\n\n`;
                todosLosLotes.forEach((lote, index) => {
                    const icono = lote.prioridad === 'alta' ? '🔴' : lote.prioridad === 'media' ? '🟡' : '🟢';
                    const prioridad = lote.prioridad === 'alta' ? 'URGENTE' : lote.prioridad === 'media' ? 'PRONTO' : 'ATENCIÓN';
                    const recomendacion = lote.prioridad === 'alta' ? '⚠️ USAR PRIMERO' : lote.prioridad === 'media' ? '⚡ USAR PRONTO' : '✅ DISPONIBLE';
                    
                    mensaje += `${icono} **Lote ${index + 1}:** ${lote.lote}\n`;
                    mensaje += `   📅 Fecha de vencimiento: ${lote.fecha}\n`;
                    mensaje += `   ⏰ Vence en: ${lote.diasRestantes} días (${prioridad})\n`;
                    mensaje += `   📦 Cantidad disponible: ${lote.cantidad}\n`;
                    mensaje += `   💡 ${recomendacion}\n\n`;
                });
                
                // Agregar recomendación general
                const loteMasCercano = todosLosLotes[0];
                if (loteMasCercano) {
                    mensaje += `**🎯 RECOMENDACIÓN:**\n`;
                    mensaje += `Usa primero el **${loteMasCercano.lote}** que vence en ${loteMasCercano.diasRestantes} días.\n\n`;
                }
            }
            
            // Usar SweetAlert2 para mostrar los detalles
            Swal.fire({
                title: '📦 Detalles de Lotes',
                html: mensaje.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'),
                icon: 'info',
                confirmButtonText: '✅ Entendido',
                width: '700px',
                customClass: {
                    popup: 'swal-wide'
                }
            });
        }
        
        function mostrarInfoRapidaLotes(clave) {
            const fechas = fechasVencimiento[clave] || [];
            const lotesProducto = lotes[clave] || [];
            
            if (fechas.length === 0 && lotesProducto.length === 0) {
                return; // No mostrar nada si no hay lotes
            }
            
            const hoy = new Date();
            const todosLosLotes = [];
            
            const lotesProcesados = new Set(); // Para evitar duplicados
            
            // Procesar fechas de vencimiento
            fechas.forEach(item => {
                const fechaVenc = new Date(item.fecha);
                const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                
                const loteKey = `${item.lote}_${item.fecha}`;
                if (!lotesProcesados.has(loteKey)) {
                    todosLosLotes.push({
                        lote: item.lote,
                        diasRestantes: diasRestantes,
                        prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                    });
                    lotesProcesados.add(loteKey);
                }
            });
            
            // Procesar lotes (solo si no están ya procesados)
            lotesProducto.forEach(item => {
                if (item.fechaVencimiento && item.fechaVencimiento !== 'Sin fecha') {
                    const fechaVenc = new Date(item.fechaVencimiento);
                    const diasRestantes = Math.ceil((fechaVenc - hoy) / (1000 * 60 * 60 * 24));
                    
                    const loteKey = `${item.lote}_${item.fechaVencimiento}`;
                    if (!lotesProcesados.has(loteKey)) {
                        todosLosLotes.push({
                            lote: item.lote,
                            diasRestantes: diasRestantes,
                            prioridad: diasRestantes <= 7 ? 'alta' : diasRestantes <= 15 ? 'media' : 'baja'
                        });
                        lotesProcesados.add(loteKey);
                    }
                }
            });
            
            // Ordenar por prioridad
            todosLosLotes.sort((a, b) => {
                if (a.prioridad !== b.prioridad) {
                    const prioridades = { alta: 3, media: 2, baja: 1 };
                    return prioridades[b.prioridad] - prioridades[a.prioridad];
                }
                return a.diasRestantes - b.diasRestantes;
            });
            
            // Mostrar información rápida
            const loteMasCercano = todosLosLotes[0];
            if (loteMasCercano) {
                const icono = loteMasCercano.prioridad === 'alta' ? '🔴' : loteMasCercano.prioridad === 'media' ? '🟡' : '🟢';
                const mensaje = `${icono} Lote más cercano a vencer: ${loteMasCercano.lote} (${loteMasCercano.diasRestantes} días)`;
                
                // Mostrar como toast o notificación pequeña
                mostrarMensaje(mensaje, 'info');
            }
        }
        
        function verLotesDisponibles() {
            const productoSeleccionado = document.getElementById('producto-salida').value;
            
            if (!productoSeleccionado || productoSeleccionado === '') {
                Swal.fire({
                    title: '⚠️ Producto no seleccionado',
                    text: 'Por favor, selecciona un producto del inventario para ver sus lotes disponibles.',
                    icon: 'warning',
                    confirmButtonText: '✅ Entendido'
                });
                return;
            }
            
            // Mostrar loading mientras se procesa
            Swal.fire({
                title: '🔍 Buscando lotes...',
                text: 'Consultando información de vencimiento...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Simular un pequeño delay para mejor UX
            setTimeout(() => {
                verDetallesLotes(productoSeleccionado);
            }, 500);
        }
        

        
        // FUNCIONES DE MENSAJES
        function mostrarMensaje(mensaje, tipo) {
            const div = document.createElement('div');
            div.className = `mensaje-${tipo}`;
            div.textContent = mensaje;
            div.style.position = 'fixed';
            div.style.top = '20px';
            div.style.left = '50%';
            div.style.transform = 'translateX(-50%)';
            div.style.zIndex = '9999';
            div.style.padding = '15px 25px';
            div.style.borderRadius = '10px';
            div.style.fontWeight = '600';
            div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            div.style.animation = 'slideInDown 0.3s ease-out';
            
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.animation = 'slideOutUp 0.3s ease-in';
                setTimeout(() => {
                    if (div.parentNode) {
                        div.remove();
                    }
                }, 300);
            }, 4000);
        }
        
        // FUNCIONES DE DATOS
        function guardarDatos() {
            const datos = {
                inventario,
                historial,
                contadores,
                fechasVencimiento,
                lotes,
                ultimaActualizacion: new Date(),
                sedeActual
            };
            
            localStorage.setItem('paeDigitalData', JSON.stringify(datos));
            
            // Sincronizar con Firebase
            guardarEnFirebase(datos);
        }
        
        function cargarDatos() {
            const datosGuardados = localStorage.getItem('paeDigitalData');
            if (datosGuardados) {
                const datos = JSON.parse(datosGuardados);
                inventario = datos.inventario || {};
                historial = datos.historial || [];
                contadores = datos.contadores || { entradas: 0, salidas: 0, devoluciones: 0 };
                fechasVencimiento = datos.fechasVencimiento || {};
                lotes = datos.lotes || {};
                sedeActual = datos.sedeActual || 'BODEGA CENTRAL';
            }
        }
        
        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            
            // Agregar datos de prueba si el inventario está vacío
            if (Object.keys(inventario).length === 0) {
                console.log('Inventario vacío, agregando datos de prueba...');
                inventario['Arroz premium 1000 Gramos_BODEGA CENTRAL'] = {
                    producto: 'Arroz premium 1000 Gramos',
                    cantidad: 50,
                    sede: 'BODEGA CENTRAL'
                };
                inventario['Leche en polvo 900 a 1000 grs_BODEGA CENTRAL'] = {
                    producto: 'Leche en polvo 900 a 1000 grs',
                    cantidad: 30,
                    sede: 'BODEGA CENTRAL'
                };
                inventario['Tomate 1000 grs_IE Alejandro Vélez Barrientos'] = {
                    producto: 'Tomate 1000 grs',
                    cantidad: 25,
                    sede: 'IE Alejandro Vélez Barrientos'
                };
                
                // Agregar fechas de vencimiento de prueba con fechas futuras
                const hoy = new Date();
                const fecha1 = new Date(hoy);
                fecha1.setDate(hoy.getDate() + 5); // Vence en 5 días
                const fecha2 = new Date(hoy);
                fecha2.setDate(hoy.getDate() + 15); // Vence en 15 días
                const fecha3 = new Date(hoy);
                fecha3.setDate(hoy.getDate() + 25); // Vence en 25 días
                
                fechasVencimiento['Arroz premium 1000 Gramos_BODEGA CENTRAL'] = [
                    { lote: 'LOTE-001', fecha: fecha1.toISOString().split('T')[0], cantidad: 30 },
                    { lote: 'LOTE-002', fecha: fecha2.toISOString().split('T')[0], cantidad: 20 }
                ];
                fechasVencimiento['Leche en polvo 900 a 1000 grs_BODEGA CENTRAL'] = [
                    { lote: 'LOTE-003', fecha: fecha3.toISOString().split('T')[0], cantidad: 30 }
                ];
                
                // Agregar más datos de prueba con diferentes fechas
                const fechaUrgente = new Date(hoy);
                fechaUrgente.setDate(hoy.getDate() + 2); // Vence en 2 días (URGENTE)
                
                const fechaMedia = new Date(hoy);
                fechaMedia.setDate(hoy.getDate() + 10); // Vence en 10 días (MEDIA)
                
                fechasVencimiento['Tomate 1000 grs_IE Alejandro Vélez Barrientos'] = [
                    { lote: 'LOTE-URG-001', fecha: fechaUrgente.toISOString().split('T')[0], cantidad: 15 },
                    { lote: 'LOTE-MED-001', fecha: fechaMedia.toISOString().split('T')[0], cantidad: 10 }
                ];
                
                guardarDatos();
                console.log('Datos de prueba agregados');
                
                // Agregar datos de historial de prueba si está vacío
                if (historial.length === 0) {
                    console.log('Historial vacío, agregando datos de prueba...');
                    
                    const hoy = new Date();
                    const ayer = new Date(hoy);
                    ayer.setDate(hoy.getDate() - 1);
                    
                    // Datos de prueba para hoy
                    historial.push({
                        fecha: hoy.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Arroz premium 1000 Gramos',
                        cantidad: 20,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE Alejandro Vélez Barrientos',
                        descripcion: 'Envío semanal',
                        lote: 'LOTE-001',
                        timestamp: hoy.getTime()
                    });
                    
                    historial.push({
                        fecha: hoy.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Leche en polvo 900 a 1000 grs',
                        cantidad: 15,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE El Salado',
                        descripcion: 'Envío para comedor',
                        lote: 'LOTE-003',
                        timestamp: hoy.getTime()
                    });
                    
                    historial.push({
                        fecha: hoy.toISOString().split('T')[0],
                        tipo: 'entrada',
                        producto: 'Tomate 1000 grs',
                        cantidad: 25,
                        sede: 'IE Alejandro Vélez Barrientos',
                        descripcion: 'Compra local',
                        lote: 'LOTE-URG-001',
                        timestamp: hoy.getTime()
                    });
                    
                    // Datos de prueba para ayer
                    historial.push({
                        fecha: ayer.toISOString().split('T')[0],
                        tipo: 'salida',
                        producto: 'Arroz premium 1000 Gramos',
                        cantidad: 10,
                        sede: 'BODEGA CENTRAL',
                        sedeDestino: 'IE Comercial de Envigado',
                        descripcion: 'Envío diario',
                        lote: 'LOTE-002',
                        timestamp: ayer.getTime()
                    });
                    
                    historial.push({
                        fecha: ayer.toISOString().split('T')[0],
                        tipo: 'entrada',
                        producto: 'Leche en polvo 900 a 1000 grs',
                        cantidad: 30,
                        sede: 'BODEGA CENTRAL',
                        descripcion: 'Recepción de proveedor',
                        lote: 'LOTE-003',
                        timestamp: ayer.getTime()
                    });
                    
                    guardarDatos();
                    console.log('Datos de historial de prueba agregados');
                }
            }
            
            // Inicializar autocompletado
            inicializarAutocompletado('producto-entrada', 'sugerencias-entrada');
            inicializarAutocompletado('producto-devolucion', 'sugerencias-devolucion');
            
            // Cargar productos para salida
            cargarProductosParaSalida();
            
            // Configurar filtros
            document.getElementById('filtro-sede-stock').addEventListener('change', cargarStock);
            document.getElementById('filtro-tipo-stock').addEventListener('change', cargarStock);
            document.getElementById('filtro-tipo-historial').addEventListener('change', cargarHistorial);
            document.getElementById('filtro-sede-historial').addEventListener('change', cargarHistorial);
            document.getElementById('filtro-fecha-historial').addEventListener('change', cargarHistorial);
            
            // Configurar checkboxes
            document.getElementById('fecha-no-aplica-entrada').addEventListener('change', function() {
                const fechaInput = document.getElementById('fecha-vencimiento-entrada');
                fechaInput.disabled = this.checked;
                if (this.checked) fechaInput.value = '';
            });
            
            document.getElementById('lote-no-aplica-entrada').addEventListener('change', function() {
                const loteInput = document.getElementById('lote-entrada');
                loteInput.disabled = this.checked;
                if (this.checked) loteInput.value = '';
            });
            
            // Inicializar mes del reporte con el mes actual
            const mesActual = new Date().toISOString().split('T')[0].substring(0, 7);
            document.getElementById('mes-reporte').value = mesActual;
            console.log('📅 Mes inicializado:', mesActual);
            
            // Inicializar selector de institución con BODEGA CENTRAL por defecto
            document.getElementById('institucion-reporte').value = 'BODEGA CENTRAL';
            
            // Evento para cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(event) {
                const campoBusqueda = document.getElementById('filtro-producto-historial');
                const sugerencias = document.getElementById('sugerencias-producto-historial');
                
                if (!campoBusqueda.contains(event.target) && !sugerencias.contains(event.target)) {
                    sugerencias.style.display = 'none';
                }
            });
            
            // Verificar estado inicial del selector de destino para salidas
            setTimeout(() => {
                const sedeSalida = document.getElementById('sede-salida');
                if (sedeSalida.value === 'BODEGA CENTRAL') {
                    console.log('BODEGA CENTRAL ya seleccionada al cargar, ejecutando mostrarOcultarDestino...');
                    mostrarOcultarDestino();
                }
            }, 100);
        });
    </script>
</body>
</html>
