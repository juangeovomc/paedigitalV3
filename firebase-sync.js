// üî• SISTEMA PAE DIGITAL - SINCRONIZACI√ìN SIMPLE CON FIREBASE
// Este archivo maneja la conexi√≥n con Firebase de forma simple y confiable

// Estado global de Firebase
let firebaseStatus = {
    inicializado: false,
    conectado: false,
    ultimaSincronizacion: null
};

// üîç VERIFICAR SI FIREBASE EST√Å FUNCIONANDO
async function verificarFirebase() {
    try {
        console.log('üîç Verificando Firebase...');
        
        // 1. Verificar que Firebase est√© cargado
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase no est√° cargado');
        }
        
        // 2. Verificar que est√© inicializado
        if (firebase.apps.length === 0) {
            throw new Error('Firebase no est√° inicializado');
        }
        
        // 3. Verificar que Firestore est√© disponible
        if (!firebase.firestore) {
            throw new Error('Firestore no est√° disponible');
        }
        
        // 4. Hacer una prueba real de conexi√≥n
        const db = firebase.firestore();
        const testDoc = db.collection('test').doc('conexion');
        
        // Escribir un documento de prueba
        await testDoc.set({
            timestamp: new Date(),
            mensaje: 'Prueba de conexi√≥n'
        });
        
        // Leer el documento de prueba
        const doc = await testDoc.get();
        
        // Eliminar el documento de prueba
        await testDoc.delete();
        
        // Si llegamos aqu√≠, todo est√° funcionando
        firebaseStatus.inicializado = true;
        firebaseStatus.conectado = true;
        firebaseStatus.ultimaSincronizacion = new Date();
        
        console.log('‚úÖ Firebase conectado correctamente');
        actualizarIndicadorConexion(true);
        
        return {
            exito: true,
            mensaje: 'Firebase conectado correctamente'
        };
        
    } catch (error) {
        console.error('‚ùå Error verificando Firebase:', error);
        firebaseStatus.conectado = false;
        actualizarIndicadorConexion(false);
        
        return {
            exito: false,
            mensaje: `Error: ${error.message}`
        };
    }
}

// üíæ GUARDAR DATOS EN FIREBASE
async function guardarEnFirebase(datos) {
    try {
        // Verificar Firebase primero
        const verificacion = await verificarFirebase();
        if (!verificacion.exito) {
            console.log('‚ö†Ô∏è No se puede sincronizar - Firebase no disponible');
            return false;
        }
        
        console.log('üíæ Guardando datos en Firebase...');
        
        const db = firebase.firestore();
        const batch = db.batch();
        
        // Guardar inventario
        const inventarioRef = db.collection('inventario').doc('datos');
        batch.set(inventarioRef, {
            inventario: datos.inventario,
            contadores: datos.contadores,
            fechasVencimiento: datos.fechasVencimiento,
            lotes: datos.lotes,
            ultimaActualizacion: new Date(),
            sedeActual: datos.sedeActual
        });
        
        // Guardar historial (solo los √∫ltimos 100 movimientos para evitar problemas)
        const historialLimitado = datos.historial.slice(-100);
        
        // Eliminar historial anterior
        const historialRef = db.collection('historial');
        const historialDocs = await historialRef.get();
        historialDocs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        // Agregar historial nuevo
        historialLimitado.forEach((movimiento, index) => {
            const docRef = historialRef.doc(`mov_${movimiento.id}_${index}`);
            batch.set(docRef, movimiento);
        });
        
        // Ejecutar todas las operaciones
        await batch.commit();
        
        firebaseStatus.ultimaSincronizacion = new Date();
        console.log('‚úÖ Datos guardados en Firebase exitosamente');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error guardando en Firebase:', error);
        return false;
    }
}

// üì• CARGAR DATOS DESDE FIREBASE
async function cargarDesdeFirebase() {
    try {
        // Verificar Firebase primero
        const verificacion = await verificarFirebase();
        if (!verificacion.exito) {
            console.log('‚ö†Ô∏è No se puede cargar - Firebase no disponible');
            return false;
        }
        
        console.log('üì• Cargando datos desde Firebase...');
        
        const db = firebase.firestore();
        
        // Cargar inventario
        const inventarioDoc = await db.collection('inventario').doc('datos').get();
        
        if (inventarioDoc.exists) {
            const datos = inventarioDoc.data();
            
            // Actualizar variables globales
            window.inventario = datos.inventario || {};
            window.contadores = datos.contadores || { entradas: 0, salidas: 0, devoluciones: 0 };
            window.fechasVencimiento = datos.fechasVencimiento || {};
            window.lotes = datos.lotes || {};
            window.sedeActual = datos.sedeActual || 'BODEGA CENTRAL';
            
            console.log('‚úÖ Inventario cargado desde Firebase');
        }
        
        // Cargar historial
        const historialSnapshot = await db.collection('historial').get();
        const historialCargado = [];
        
        historialSnapshot.forEach(doc => {
            historialCargado.push(doc.data());
        });
        
        // Ordenar por timestamp
        historialCargado.sort((a, b) => a.timestamp - b.timestamp);
        window.historial = historialCargado;
        
        console.log('‚úÖ Historial cargado desde Firebase');
        
        firebaseStatus.ultimaSincronizacion = new Date();
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error cargando desde Firebase:', error);
        return false;
    }
}

// üîÑ SINCRONIZACI√ìN MANUAL
async function sincronizarManual() {
    try {
        console.log('üîÑ Iniciando sincronizaci√≥n manual...');
        
        // Verificar conexi√≥n
        const verificacion = await verificarFirebase();
        if (!verificacion.exito) {
            mostrarMensaje('‚ùå No se puede sincronizar: ' + verificacion.mensaje, 'error');
            return false;
        }
        
        // Cargar datos desde Firebase
        const cargado = await cargarDesdeFirebase();
        if (cargado) {
            mostrarMensaje('‚úÖ Datos sincronizados exitosamente', 'exito');
            return true;
        } else {
            mostrarMensaje('‚ùå Error al cargar datos', 'error');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n manual:', error);
        mostrarMensaje('‚ùå Error de sincronizaci√≥n: ' + error.message, 'error');
        return false;
    }
}

// üîç DIAGNOSTICAR PROBLEMAS
function diagnosticarProblemasSincronizacion() {
    const diagnostico = {
        firebaseCargado: typeof firebase !== 'undefined',
        firebaseInicializado: firebaseStatus.inicializado,
        firebaseConectado: firebaseStatus.conectado,
        ultimaSincronizacion: firebaseStatus.ultimaSincronizacion,
        conexionInternet: navigator.onLine
    };
    
    console.log('üîç Diagn√≥stico de Firebase:', diagnostico);
    
    let mensaje = 'üîç DIAGN√ìSTICO DE FIREBASE:\n\n';
    
    if (diagnostico.firebaseCargado) {
        mensaje += '‚úÖ Firebase SDK cargado\n';
    } else {
        mensaje += '‚ùå Firebase SDK no cargado\n';
    }
    
    if (diagnostico.firebaseInicializado) {
        mensaje += '‚úÖ Firebase inicializado\n';
    } else {
        mensaje += '‚ùå Firebase no inicializado\n';
    }
    
    if (diagnostico.firebaseConectado) {
        mensaje += '‚úÖ Firebase conectado\n';
    } else {
        mensaje += '‚ùå Firebase no conectado\n';
    }
    
    if (diagnostico.conexionInternet) {
        mensaje += '‚úÖ Conexi√≥n a internet\n';
    } else {
        mensaje += '‚ùå Sin conexi√≥n a internet\n';
    }
    
    if (diagnostico.ultimaSincronizacion) {
        mensaje += `‚úÖ √öltima sincronizaci√≥n: ${diagnostico.ultimaSincronizacion.toLocaleString()}\n`;
    } else {
        mensaje += '‚ùå Nunca sincronizado\n';
    }
    
    alert(mensaje);
}

// üì± ACTUALIZAR INDICADOR DE CONEXI√ìN
function actualizarIndicadorConexion(conectado) {
    const indicador = document.getElementById('indicador-conexion');
    if (indicador) {
        if (conectado) {
            indicador.textContent = '‚úÖ Conectado';
            indicador.className = 'indicador-conexion conectado';
        } else {
            indicador.textContent = '‚ùå Desconectado';
            indicador.className = 'indicador-conexion desconectado';
        }
    }
}

// üíæ GUARDAR DATOS LOCALMENTE
function guardarDatosLocal(datos) {
    try {
        localStorage.setItem('paeDigitalData', JSON.stringify(datos));
        return true;
    } catch (error) {
        console.error('Error guardando datos locales:', error);
        return false;
    }
}

// üì• CARGAR DATOS LOCALMENTE
function cargarDatosLocal() {
    try {
        const datos = localStorage.getItem('paeDigitalData');
        if (datos) {
            return JSON.parse(datos);
        }
        return null;
    } catch (error) {
        console.error('Error cargando datos locales:', error);
        return null;
    }
}

// üîÑ CARGAR DATOS (LOCAL + FIREBASE)
async function cargarDatos() {
    // Primero cargar desde local
    const datosLocales = cargarDatosLocal();
    if (datosLocales) {
        window.inventario = datosLocales.inventario || {};
        window.historial = datosLocales.historial || [];
        window.contadores = datosLocales.contadores || { entradas: 0, salidas: 0, devoluciones: 0 };
        window.fechasVencimiento = datosLocales.fechasVencimiento || {};
        window.lotes = datosLocales.lotes || {};
        window.sedeActual = datosLocales.sedeActual || 'BODEGA CENTRAL';
    }
    
    // Luego intentar sincronizar con Firebase
    try {
        await cargarDesdeFirebase();
    } catch (error) {
        console.log('‚ö†Ô∏è No se pudo cargar desde Firebase, usando datos locales');
    }
}

// üíæ GUARDAR DATOS (LOCAL + FIREBASE)
async function guardarDatos() {
    const datos = {
        inventario: window.inventario || {},
        historial: window.historial || [],
        contadores: window.contadores || { entradas: 0, salidas: 0, devoluciones: 0 },
        fechasVencimiento: window.fechasVencimiento || {},
        lotes: window.lotes || {},
        ultimaActualizacion: new Date(),
        sedeActual: window.sedeActual || 'BODEGA CENTRAL'
    };
    
    // Guardar localmente
    guardarDatosLocal(datos);
    
    // Intentar sincronizar con Firebase
    try {
        await guardarEnFirebase(datos);
    } catch (error) {
        console.log('‚ö†Ô∏è No se pudo sincronizar con Firebase, datos guardados localmente');
    }
}

// üöÄ INICIALIZAR CUANDO SE CARGA LA P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando sistema PAE Digital...');
    
    // Verificar Firebase al cargar
    verificarFirebase();
    
    // Configurar eventos de conexi√≥n
    window.addEventListener('online', function() {
        console.log('üåê Conexi√≥n a internet restaurada');
        verificarFirebase();
    });
    
    window.addEventListener('offline', function() {
        console.log('‚ùå Conexi√≥n a internet perdida');
        actualizarIndicadorConexion(false);
    });
});

// üìù FUNCI√ìN PARA MOSTRAR MENSAJES
function mostrarMensaje(mensaje, tipo) {
    // Crear elemento de mensaje
    const div = document.createElement('div');
    div.className = `mensaje-${tipo}`;
    div.textContent = mensaje;
    div.style.position = 'fixed';
    div.style.top = '20px';
    div.style.left = '50%';
    div.style.transform = 'translateX(-50%)';
    div.style.zIndex = '10000';
    div.style.padding = '15px 25px';
    div.style.borderRadius = '10px';
    div.style.fontWeight = '600';
    div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    
    // Colores seg√∫n tipo
    if (tipo === 'exito') {
        div.style.background = '#d4edda';
        div.style.color = '#155724';
        div.style.border = '1px solid #c3e6cb';
    } else if (tipo === 'error') {
        div.style.background = '#f8d7da';
        div.style.color = '#721c24';
        div.style.border = '1px solid #f5c6cb';
    } else {
        div.style.background = '#d1ecf1';
        div.style.color = '#0c5460';
        div.style.border = '1px solid #bee5eb';
    }
    
    document.body.appendChild(div);
    
    // Eliminar despu√©s de 5 segundos
    setTimeout(() => {
        if (div.parentNode) {
            div.parentNode.removeChild(div);
        }
    }, 5000);
}

console.log('üî• Sistema PAE Digital - Firebase Sync cargado'); 