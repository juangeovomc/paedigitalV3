<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerificaciÃ³n de Funcionalidades - PAE Digital</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .funcionalidad-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .funcionalidad-card.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .funcionalidad-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .funcionalidad-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .funcionalidad-card.info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        
        .funcionalidad-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .funcionalidad-description {
            color: #666;
            margin-bottom: 15px;
        }
        
        .funcionalidad-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }
        
        .status-success {
            background: #28a745;
            color: white;
        }
        
        .status-error {
            background: #dc3545;
            color: white;
        }
        
        .status-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .status-info {
            background: #17a2b8;
            color: white;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ VerificaciÃ³n de Funcionalidades - PAE Digital</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š Estado General del Sistema</h3>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="status-general" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ”„ Verificando funcionalidades...</div>
                <div class="funcionalidad-description">Inicializando verificaciÃ³n del sistema PAE Digital</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”¥ Funcionalidades de Firebase</h3>
            <button class="button" onclick="verificarTodasLasFuncionalidades()">ğŸš€ Verificar Todo</button>
            <button class="button" onclick="probarSincronizacion()">ğŸ”„ Probar SincronizaciÃ³n</button>
            <button class="button" onclick="probarInventario()">ğŸ“¦ Probar Inventario</button>
            <button class="button" onclick="probarHistorial()">ğŸ“‹ Probar Historial</button>
            
            <div id="funcionalidad-firebase" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ”¥ Firebase</div>
                <div class="funcionalidad-description">SincronizaciÃ³n en la nube y almacenamiento de datos</div>
                <div id="status-firebase" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="funcionalidad-sincronizacion" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ”„ SincronizaciÃ³n</div>
                <div class="funcionalidad-description">Guardado y carga de datos entre local y Firebase</div>
                <div id="status-sincronizacion" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="log-firebase" class="log-container"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“¦ Funcionalidades de Inventario</h3>
            <button class="button" onclick="probarGestionInventario()">ğŸ“¦ Probar GestiÃ³n</button>
            <button class="button" onclick="probarMovimientos()">ğŸ”„ Probar Movimientos</button>
            <button class="button" onclick="probarLotes()">ğŸ·ï¸ Probar Lotes</button>
            
            <div id="funcionalidad-inventario" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ“¦ GestiÃ³n de Inventario</div>
                <div class="funcionalidad-description">Agregar, editar y eliminar productos del inventario</div>
                <div id="status-inventario" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="funcionalidad-movimientos" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ”„ Movimientos</div>
                <div class="funcionalidad-description">Entradas, salidas y devoluciones de productos</div>
                <div id="status-movimientos" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="funcionalidad-lotes" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ·ï¸ GestiÃ³n de Lotes</div>
                <div class="funcionalidad-description">Control de lotes y fechas de vencimiento</div>
                <div id="status-lotes" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="log-inventario" class="log-container"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š Funcionalidades de Reportes</h3>
            <button class="button" onclick="probarReportes()">ğŸ“Š Probar Reportes</button>
            <button class="button" onclick="probarExportacion()">ğŸ“¤ Probar ExportaciÃ³n</button>
            <button class="button" onclick="probarFiltros()">ğŸ” Probar Filtros</button>
            
            <div id="funcionalidad-reportes" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ“Š GeneraciÃ³n de Reportes</div>
                <div class="funcionalidad-description">Reportes diarios por instituciÃ³n</div>
                <div id="status-reportes" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="funcionalidad-exportacion" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ“¤ ExportaciÃ³n a Excel</div>
                <div class="funcionalidad-description">Exportar reportes en formato Excel</div>
                <div id="status-exportacion" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="funcionalidad-filtros" class="funcionalidad-card">
                <div class="funcionalidad-title">ğŸ” Filtros por InstituciÃ³n</div>
                <div class="funcionalidad-description">Filtrado de reportes por sede especÃ­fica</div>
                <div id="status-filtros" class="funcionalidad-status status-info">Pendiente de verificaciÃ³n</div>
            </div>
            
            <div id="log-reportes" class="log-container"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ EstadÃ­sticas del Sistema</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div id="stat-productos" class="stat-number">0</div>
                    <div class="stat-label">Productos en Inventario</div>
                </div>
                <div class="stat-card">
                    <div id="stat-movimientos" class="stat-number">0</div>
                    <div class="stat-label">Movimientos Totales</div>
                </div>
                <div class="stat-card">
                    <div id="stat-lotes" class="stat-number">0</div>
                    <div class="stat-label">Lotes Activos</div>
                </div>
                <div class="stat-card">
                    <div id="stat-funcionalidades" class="stat-number">0%</div>
                    <div class="stat-label">Funcionalidades Operativas</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ Reporte Final</h3>
            <button class="button" onclick="generarReporteFinal()">ğŸ“Š Generar Reporte</button>
            <button class="button" onclick="exportarReporteFinal()">ğŸ’¾ Exportar Reporte</button>
            
            <div id="reporte-final" class="funcionalidad-card info">
                <div class="funcionalidad-title">ğŸ“‹ Reporte de Funcionalidades</div>
                <div id="reporte-contenido" class="funcionalidad-description">
                    Haz clic en "Generar Reporte" para ver el estado completo de todas las funcionalidades.
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-sync.js"></script>

    <script>
        // Variables globales para el diagnÃ³stico
        let resultadosFuncionalidades = {
            firebase: { operativo: false, detalles: '' },
            sincronizacion: { operativo: false, detalles: '' },
            inventario: { operativo: false, detalles: '' },
            movimientos: { operativo: false, detalles: '' },
            lotes: { operativo: false, detalles: '' },
            reportes: { operativo: false, detalles: '' },
            exportacion: { operativo: false, detalles: '' },
            filtros: { operativo: false, detalles: '' }
        };

        // Variables globales simuladas del sistema PAE
        let inventario = {};
        let historial = [];
        let contadores = { entradas: 0, salidas: 0, devoluciones: 0 };
        let fechasVencimiento = {};
        let lotes = {};
        let sedeActual = 'BODEGA CENTRAL';

        // FunciÃ³n para agregar logs
        function agregarLog(container, mensaje, tipo = 'info') {
            const logContainer = document.getElementById(container);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${mensaje}\n`;
            
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
        }

        // FunciÃ³n para actualizar progreso
        function actualizarProgreso(porcentaje) {
            document.getElementById('progress-fill').style.width = porcentaje + '%';
        }

        // FunciÃ³n para actualizar estado de funcionalidad
        function actualizarEstadoFuncionalidad(id, operativo, detalles) {
            const card = document.getElementById(id);
            const statusElement = document.getElementById(`status-${id.split('-')[1]}`);
            
            resultadosFuncionalidades[id.split('-')[1]] = { operativo, detalles };
            
            if (operativo) {
                card.className = 'funcionalidad-card success';
                statusElement.className = 'funcionalidad-status status-success';
                statusElement.textContent = 'âœ… Operativo';
            } else {
                card.className = 'funcionalidad-card error';
                statusElement.className = 'funcionalidad-status status-error';
                statusElement.textContent = 'âŒ No Operativo';
            }
        }

        // Verificar Firebase
        async function verificarFirebase() {
            agregarLog('log-firebase', 'ğŸ”¥ Verificando Firebase...');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no estÃ¡ cargado');
                }
                
                if (firebase.apps.length === 0) {
                    throw new Error('Firebase no estÃ¡ inicializado');
                }
                
                const db = firebase.firestore();
                const testDoc = db.collection('test').doc('verificacion');
                
                await testDoc.set({
                    timestamp: new Date(),
                    mensaje: 'VerificaciÃ³n de funcionalidad'
                });
                
                const doc = await testDoc.get();
                await testDoc.delete();
                
                actualizarEstadoFuncionalidad('funcionalidad-firebase', true, 'Firebase conectado y funcionando correctamente');
                agregarLog('log-firebase', 'âœ… Firebase operativo');
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-firebase', false, 'Error: ' + error.message);
                agregarLog('log-firebase', 'âŒ Error en Firebase: ' + error.message);
            }
        }

        // Probar sincronizaciÃ³n
        async function probarSincronizacion() {
            agregarLog('log-firebase', 'ğŸ”„ Probando sincronizaciÃ³n...');
            
            try {
                // Simular datos de prueba
                const datosTest = {
                    inventario: { 'producto-test': { cantidad: 10, descripcion: 'Producto de prueba' } },
                    historial: [{ id: 'test-1', tipo: 'entrada', producto: 'producto-test', cantidad: 10, fecha: new Date() }],
                    contadores: { entradas: 1, salidas: 0, devoluciones: 0 },
                    fechasVencimiento: {},
                    lotes: {},
                    sedeActual: 'BODEGA CENTRAL'
                };
                
                // Probar guardado
                const guardado = await guardarEnFirebase(datosTest);
                if (guardado) {
                    agregarLog('log-firebase', 'âœ… Datos guardados en Firebase');
                } else {
                    throw new Error('No se pudieron guardar los datos');
                }
                
                // Probar carga
                const cargado = await cargarDesdeFirebase();
                if (cargado) {
                    agregarLog('log-firebase', 'âœ… Datos cargados desde Firebase');
                } else {
                    throw new Error('No se pudieron cargar los datos');
                }
                
                actualizarEstadoFuncionalidad('funcionalidad-sincronizacion', true, 'SincronizaciÃ³n funcionando correctamente');
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-sincronizacion', false, 'Error: ' + error.message);
                agregarLog('log-firebase', 'âŒ Error en sincronizaciÃ³n: ' + error.message);
            }
        }

        // Probar inventario
        function probarInventario() {
            agregarLog('log-inventario', 'ğŸ“¦ Probando gestiÃ³n de inventario...');
            
            try {
                // Simular operaciones de inventario
                inventario['producto-test'] = {
                    cantidad: 100,
                    descripcion: 'Producto de prueba',
                    categoria: 'Test',
                    unidad: 'unidades'
                };
                
                // Verificar que se puede agregar
                if (inventario['producto-test']) {
                    agregarLog('log-inventario', 'âœ… Producto agregado al inventario');
                }
                
                // Simular ediciÃ³n
                inventario['producto-test'].cantidad = 150;
                if (inventario['producto-test'].cantidad === 150) {
                    agregarLog('log-inventario', 'âœ… Producto editado correctamente');
                }
                
                // Simular eliminaciÃ³n
                delete inventario['producto-test'];
                if (!inventario['producto-test']) {
                    agregarLog('log-inventario', 'âœ… Producto eliminado correctamente');
                }
                
                actualizarEstadoFuncionalidad('funcionalidad-inventario', true, 'GestiÃ³n de inventario funcionando');
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-inventario', false, 'Error: ' + error.message);
                agregarLog('log-inventario', 'âŒ Error en inventario: ' + error.message);
            }
        }

        // Probar movimientos
        function probarMovimientos() {
            agregarLog('log-inventario', 'ğŸ”„ Probando movimientos...');
            
            try {
                // Simular movimiento de entrada
                const entrada = {
                    id: 'mov-test-1',
                    tipo: 'entrada',
                    producto: 'producto-test',
                    cantidad: 50,
                    sede: 'BODEGA CENTRAL',
                    fecha: new Date(),
                    descripcion: 'Entrada de prueba'
                };
                
                historial.push(entrada);
                contadores.entradas++;
                
                // Simular movimiento de salida
                const salida = {
                    id: 'mov-test-2',
                    tipo: 'salida',
                    producto: 'producto-test',
                    cantidad: 20,
                    sede: 'BODEGA CENTRAL',
                    sedeDestino: 'IE Test',
                    fecha: new Date(),
                    descripcion: 'Salida de prueba'
                };
                
                historial.push(salida);
                contadores.salidas++;
                
                if (historial.length === 2 && contadores.entradas === 1 && contadores.salidas === 1) {
                    agregarLog('log-inventario', 'âœ… Movimientos registrados correctamente');
                    actualizarEstadoFuncionalidad('funcionalidad-movimientos', true, 'Movimientos funcionando');
                } else {
                    throw new Error('Error en el registro de movimientos');
                }
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-movimientos', false, 'Error: ' + error.message);
                agregarLog('log-inventario', 'âŒ Error en movimientos: ' + error.message);
            }
        }

        // Probar lotes
        function probarLotes() {
            agregarLog('log-inventario', 'ğŸ·ï¸ Probando gestiÃ³n de lotes...');
            
            try {
                // Simular lote
                const lote = {
                    numero: 'LOTE-2024-001',
                    producto: 'producto-test',
                    cantidad: 100,
                    fechaVencimiento: new Date(2025, 11, 31),
                    fechaCreacion: new Date()
                };
                
                lotes['LOTE-2024-001'] = lote;
                fechasVencimiento['producto-test'] = new Date(2025, 11, 31);
                
                if (lotes['LOTE-2024-001'] && fechasVencimiento['producto-test']) {
                    agregarLog('log-inventario', 'âœ… Lote creado correctamente');
                    actualizarEstadoFuncionalidad('funcionalidad-lotes', true, 'GestiÃ³n de lotes funcionando');
                } else {
                    throw new Error('Error en la creaciÃ³n del lote');
                }
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-lotes', false, 'Error: ' + error.message);
                agregarLog('log-inventario', 'âŒ Error en lotes: ' + error.message);
            }
        }

        // Probar reportes
        function probarReportes() {
            agregarLog('log-reportes', 'ğŸ“Š Probando generaciÃ³n de reportes...');
            
            try {
                // Simular datos para reporte
                const movimientosTest = [
                    { tipo: 'entrada', producto: 'Producto 1', cantidad: 50, fecha: new Date(), sede: 'BODEGA CENTRAL' },
                    { tipo: 'salida', producto: 'Producto 2', cantidad: 30, fecha: new Date(), sede: 'BODEGA CENTRAL', sedeDestino: 'IE Test' }
                ];
                
                // Simular funciÃ³n de reporte
                const generarReporte = (movimientos, fecha, institucion) => {
                    if (movimientos && fecha && institucion) {
                        return {
                            fecha: fecha,
                            institucion: institucion,
                            totalMovimientos: movimientos.length,
                            movimientos: movimientos
                        };
                    }
                    throw new Error('Datos incompletos para el reporte');
                };
                
                const reporte = generarReporte(movimientosTest, '2024-01-15', 'BODEGA CENTRAL');
                
                if (reporte && reporte.totalMovimientos === 2) {
                    agregarLog('log-reportes', 'âœ… Reporte generado correctamente');
                    actualizarEstadoFuncionalidad('funcionalidad-reportes', true, 'GeneraciÃ³n de reportes funcionando');
                } else {
                    throw new Error('Error en la generaciÃ³n del reporte');
                }
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-reportes', false, 'Error: ' + error.message);
                agregarLog('log-reportes', 'âŒ Error en reportes: ' + error.message);
            }
        }

        // Probar exportaciÃ³n
        function probarExportacion() {
            agregarLog('log-reportes', 'ğŸ“¤ Probando exportaciÃ³n a Excel...');
            
            try {
                // Verificar si SheetJS estÃ¡ disponible
                if (typeof XLSX === 'undefined') {
                    throw new Error('SheetJS no estÃ¡ disponible');
                }
                
                // Simular datos para exportar
                const datosExcel = [
                    ['REPORTE DIARIO', 'BODEGA CENTRAL', '', '', '', ''],
                    ['Fecha:', '15 de enero de 2024', '', '', '', ''],
                    [],
                    ['Producto', 'Cantidad', 'DescripciÃ³n', 'Lote', 'Tipo de Movimiento', 'Estado RecepciÃ³n'],
                    ['Producto 1', 50, 'DescripciÃ³n 1', 'LOTE-001', 'entrada', 'âœ… LlegÃ³'],
                    ['Producto 2', 30, 'DescripciÃ³n 2', 'LOTE-002', 'salida', 'No marcado']
                ];
                
                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(datosExcel);
                XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
                
                agregarLog('log-reportes', 'âœ… Workbook creado correctamente');
                actualizarEstadoFuncionalidad('funcionalidad-exportacion', true, 'ExportaciÃ³n a Excel funcionando');
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-exportacion', false, 'Error: ' + error.message);
                agregarLog('log-reportes', 'âŒ Error en exportaciÃ³n: ' + error.message);
            }
        }

        // Probar filtros
        function probarFiltros() {
            agregarLog('log-reportes', 'ğŸ” Probando filtros por instituciÃ³n...');
            
            try {
                // Simular datos con diferentes instituciones
                const movimientosTest = [
                    { tipo: 'salida', producto: 'Producto 1', cantidad: 50, fecha: new Date(), sede: 'BODEGA CENTRAL', sedeDestino: 'IE San Vicente' },
                    { tipo: 'entrada', producto: 'Producto 2', cantidad: 30, fecha: new Date(), sede: 'IE San Vicente' },
                    { tipo: 'salida', producto: 'Producto 3', cantidad: 20, fecha: new Date(), sede: 'BODEGA CENTRAL', sedeDestino: 'IE Comercial' }
                ];
                
                // Probar filtro por instituciÃ³n especÃ­fica
                const filtrarPorInstitucion = (movimientos, institucion) => {
                    if (institucion === 'BODEGA CENTRAL') {
                        return movimientos.filter(m => m.tipo === 'salida' && m.sede === 'BODEGA CENTRAL');
                    } else {
                        return movimientos.filter(m => m.sede === institucion || m.sedeDestino === institucion);
                    }
                };
                
                const movimientosBodega = filtrarPorInstitucion(movimientosTest, 'BODEGA CENTRAL');
                const movimientosSanVicente = filtrarPorInstitucion(movimientosTest, 'IE San Vicente');
                
                if (movimientosBodega.length === 2 && movimientosSanVicente.length === 2) {
                    agregarLog('log-reportes', 'âœ… Filtros funcionando correctamente');
                    actualizarEstadoFuncionalidad('funcionalidad-filtros', true, 'Filtros por instituciÃ³n funcionando');
                } else {
                    throw new Error('Error en el filtrado de datos');
                }
                
            } catch (error) {
                actualizarEstadoFuncionalidad('funcionalidad-filtros', false, 'Error: ' + error.message);
                agregarLog('log-reportes', 'âŒ Error en filtros: ' + error.message);
            }
        }

        // Verificar todas las funcionalidades
        async function verificarTodasLasFuncionalidades() {
            agregarLog('log-firebase', 'ğŸš€ Iniciando verificaciÃ³n completa de funcionalidades...');
            actualizarProgreso(0);
            
            await verificarFirebase();
            actualizarProgreso(12);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await probarSincronizacion();
            actualizarProgreso(25);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            probarInventario();
            actualizarProgreso(37);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            probarMovimientos();
            actualizarProgreso(50);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            probarLotes();
            actualizarProgreso(62);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            probarReportes();
            actualizarProgreso(75);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            probarExportacion();
            actualizarProgreso(87);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            probarFiltros();
            actualizarProgreso(100);
            
            actualizarEstadisticas();
            agregarLog('log-firebase', 'âœ… VerificaciÃ³n completa finalizada');
        }

        // Actualizar estadÃ­sticas
        function actualizarEstadisticas() {
            const totalFuncionalidades = Object.keys(resultadosFuncionalidades).length;
            const funcionalidadesOperativas = Object.values(resultadosFuncionalidades).filter(f => f.operativo).length;
            const porcentajeOperativo = Math.round((funcionalidadesOperativas / totalFuncionalidades) * 100);
            
            document.getElementById('stat-productos').textContent = Object.keys(inventario).length;
            document.getElementById('stat-movimientos').textContent = historial.length;
            document.getElementById('stat-lotes').textContent = Object.keys(lotes).length;
            document.getElementById('stat-funcionalidades').textContent = porcentajeOperativo + '%';
        }

        // Generar reporte final
        function generarReporteFinal() {
            const reporte = `
REPORTE DE FUNCIONALIDADES - SISTEMA PAE DIGITAL
===============================================

Fecha: ${new Date().toLocaleString()}

ğŸ”¥ FIREBASE:
- Estado: ${resultadosFuncionalidades.firebase.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.firebase.detalles}

ğŸ”„ SINCRONIZACIÃ“N:
- Estado: ${resultadosFuncionalidades.sincronizacion.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.sincronizacion.detalles}

ğŸ“¦ INVENTARIO:
- Estado: ${resultadosFuncionalidades.inventario.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.inventario.detalles}

ğŸ”„ MOVIMIENTOS:
- Estado: ${resultadosFuncionalidades.movimientos.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.movimientos.detalles}

ğŸ·ï¸ LOTES:
- Estado: ${resultadosFuncionalidades.lotes.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.lotes.detalles}

ğŸ“Š REPORTES:
- Estado: ${resultadosFuncionalidades.reportes.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.reportes.detalles}

ğŸ“¤ EXPORTACIÃ“N:
- Estado: ${resultadosFuncionalidades.exportacion.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.exportacion.detalles}

ğŸ” FILTROS:
- Estado: ${resultadosFuncionalidades.filtros.operativo ? 'âœ… Operativo' : 'âŒ No Operativo'}
- Detalles: ${resultadosFuncionalidades.filtros.detalles}

ğŸ“ˆ ESTADÃSTICAS:
- Productos en inventario: ${Object.keys(inventario).length}
- Movimientos totales: ${historial.length}
- Lotes activos: ${Object.keys(lotes).length}
- Funcionalidades operativas: ${Object.values(resultadosFuncionalidades).filter(f => f.operativo).length}/${Object.keys(resultadosFuncionalidades).length}

${generarResumenFinal()}
            `;
            
            document.getElementById('reporte-contenido').textContent = reporte;
        }

        // Generar resumen final
        function generarResumenFinal() {
            const totalFuncionalidades = Object.keys(resultadosFuncionalidades).length;
            const funcionalidadesOperativas = Object.values(resultadosFuncionalidades).filter(f => f.operativo).length;
            const porcentajeOperativo = Math.round((funcionalidadesOperativas / totalFuncionalidades) * 100);
            
            if (porcentajeOperativo >= 80) {
                return 'ğŸŸ¢ SISTEMA COMPLETAMENTE OPERATIVO - Todas las funcionalidades principales estÃ¡n funcionando correctamente.';
            } else if (porcentajeOperativo >= 60) {
                return 'ğŸŸ¡ SISTEMA PARCIALMENTE OPERATIVO - Algunas funcionalidades tienen problemas menores.';
            } else {
                return 'ğŸ”´ SISTEMA CON PROBLEMAS CRÃTICOS - Se requieren correcciones importantes.';
            }
        }

        // Exportar reporte final
        function exportarReporteFinal() {
            const reporte = document.getElementById('reporte-contenido').textContent;
            const blob = new Blob([reporte], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte-funcionalidades-pae-digital-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            agregarLog('log-reportes', 'ğŸ’¾ Reporte exportado correctamente');
        }

        // Inicializar cuando se carga la pÃ¡gina
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                verificarTodasLasFuncionalidades();
            }, 1000);
        });
    </script>
</body>
</html>
