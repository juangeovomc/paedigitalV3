<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Firebase - PAE Digital</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #ddd;
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .status-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .status-card.info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        
        .status-title {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .status-message {
            color: #666;
            margin-bottom: 10px;
        }
        
        .status-details {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Firebase - PAE Digital</h1>
        
        <div class="test-section">
            <h3>üìä Estado General del Sistema</h3>
            <div id="status-general" class="status-card">
                <div class="status-title">üîÑ Verificando...</div>
                <div class="status-message">Inicializando diagn√≥stico...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üî• Pruebas de Firebase</h3>
            <button class="button" onclick="ejecutarPruebasFirebase()">üöÄ Ejecutar Pruebas Completas</button>
            <button class="button" onclick="verificarConexion()">üîå Verificar Conexi√≥n</button>
            <button class="button" onclick="probarEscritura()">‚úçÔ∏è Probar Escritura</button>
            <button class="button" onclick="probarLectura()">üìñ Probar Lectura</button>
            
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            
            <div id="log-firebase" class="log-container"></div>
        </div>
        
        <div class="test-section">
            <h3>üíæ Pruebas de Almacenamiento Local</h3>
            <button class="button" onclick="probarLocalStorage()">üíæ Probar LocalStorage</button>
            <button class="button" onclick="limpiarLocalStorage()">üóëÔ∏è Limpiar LocalStorage</button>
            
            <div id="log-local" class="log-container"></div>
        </div>
        
        <div class="test-section">
            <h3>üåê Pruebas de Conectividad</h3>
            <button class="button" onclick="verificarInternet()">üåê Verificar Internet</button>
            <button class="button" onclick="probarAPIs()">üîó Probar APIs</button>
            
            <div id="log-network" class="log-container"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã Reporte Completo</h3>
            <button class="button" onclick="generarReporteCompleto()">üìä Generar Reporte</button>
            <button class="button" onclick="exportarDiagnostico()">üíæ Exportar Diagn√≥stico</button>
            
            <div id="reporte-completo" class="status-card info">
                <div class="status-title">üìã Reporte de Diagn√≥stico</div>
                <div id="reporte-contenido" class="status-details">
                    Haz clic en "Generar Reporte" para ver el diagn√≥stico completo del sistema.
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-sync.js"></script>

    <script>
        // Variables globales para el diagn√≥stico
        let diagnosticoCompleto = {
            timestamp: new Date(),
            firebase: {},
            localStorage: {},
            network: {},
            sistema: {}
        };

        // Funci√≥n para agregar logs
        function agregarLog(container, mensaje, tipo = 'info') {
            const logContainer = document.getElementById(container);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${mensaje}\n`;
            
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
        }

        // Funci√≥n para actualizar progreso
        function actualizarProgreso(porcentaje) {
            document.getElementById('progress-fill').style.width = porcentaje + '%';
        }

        // Funci√≥n para actualizar estado general
        function actualizarEstadoGeneral(titulo, mensaje, tipo = 'info') {
            const statusCard = document.getElementById('status-general');
            statusCard.className = `status-card ${tipo}`;
            statusCard.innerHTML = `
                <div class="status-title">${titulo}</div>
                <div class="status-message">${mensaje}</div>
            `;
        }

        // Verificar estado inicial
        async function verificarEstadoInicial() {
            agregarLog('log-firebase', 'üîç Iniciando verificaci√≥n del sistema...');
            
            // Verificar Firebase
            if (typeof firebase !== 'undefined') {
                diagnosticoCompleto.firebase.sdkCargado = true;
                agregarLog('log-firebase', '‚úÖ Firebase SDK cargado correctamente');
            } else {
                diagnosticoCompleto.firebase.sdkCargado = false;
                agregarLog('log-firebase', '‚ùå Firebase SDK no est√° cargado');
            }

            // Verificar LocalStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                diagnosticoCompleto.localStorage.disponible = true;
                agregarLog('log-local', '‚úÖ LocalStorage disponible');
            } catch (error) {
                diagnosticoCompleto.localStorage.disponible = false;
                agregarLog('log-local', '‚ùå LocalStorage no disponible: ' + error.message);
            }

            // Verificar conexi√≥n a internet
            diagnosticoCompleto.network.online = navigator.onLine;
            agregarLog('log-network', navigator.onLine ? '‚úÖ Conexi√≥n a internet disponible' : '‚ùå Sin conexi√≥n a internet');

            actualizarEstadoGeneral('‚úÖ Diagn√≥stico Inicializado', 'Sistema listo para pruebas');
        }

        // Verificar conexi√≥n de Firebase
        async function verificarConexion() {
            agregarLog('log-firebase', 'üîå Verificando conexi√≥n a Firebase...');
            
            try {
                const resultado = await verificarFirebase();
                diagnosticoCompleto.firebase.conectado = resultado.exito;
                
                if (resultado.exito) {
                    agregarLog('log-firebase', '‚úÖ Firebase conectado correctamente');
                    actualizarProgreso(25);
                } else {
                    agregarLog('log-firebase', '‚ùå Error de conexi√≥n: ' + resultado.mensaje);
                }
            } catch (error) {
                diagnosticoCompleto.firebase.conectado = false;
                agregarLog('log-firebase', '‚ùå Error verificando Firebase: ' + error.message);
            }
        }

        // Probar escritura en Firebase
        async function probarEscritura() {
            agregarLog('log-firebase', '‚úçÔ∏è Probando escritura en Firebase...');
            
            try {
                const db = firebase.firestore();
                const testDoc = db.collection('diagnostico').doc('test-escritura');
                
                const datosTest = {
                    timestamp: new Date(),
                    mensaje: 'Prueba de escritura desde diagn√≥stico',
                    valor: Math.random()
                };
                
                await testDoc.set(datosTest);
                agregarLog('log-firebase', '‚úÖ Escritura exitosa en Firebase');
                diagnosticoCompleto.firebase.escritura = true;
                actualizarProgreso(50);
                
                // Limpiar documento de prueba
                await testDoc.delete();
                agregarLog('log-firebase', 'üßπ Documento de prueba eliminado');
                
            } catch (error) {
                agregarLog('log-firebase', '‚ùå Error en escritura: ' + error.message);
                diagnosticoCompleto.firebase.escritura = false;
            }
        }

        // Probar lectura desde Firebase
        async function probarLectura() {
            agregarLog('log-firebase', 'üìñ Probando lectura desde Firebase...');
            
            try {
                const db = firebase.firestore();
                const testDoc = db.collection('diagnostico').doc('test-lectura');
                
                // Crear documento de prueba
                await testDoc.set({
                    timestamp: new Date(),
                    mensaje: 'Documento de prueba para lectura'
                });
                
                // Leer documento
                const doc = await testDoc.get();
                
                if (doc.exists) {
                    agregarLog('log-firebase', '‚úÖ Lectura exitosa desde Firebase');
                    diagnosticoCompleto.firebase.lectura = true;
                    actualizarProgreso(75);
                } else {
                    agregarLog('log-firebase', '‚ùå Documento no encontrado');
                    diagnosticoCompleto.firebase.lectura = false;
                }
                
                // Limpiar
                await testDoc.delete();
                
            } catch (error) {
                agregarLog('log-firebase', '‚ùå Error en lectura: ' + error.message);
                diagnosticoCompleto.firebase.lectura = false;
            }
        }

        // Ejecutar todas las pruebas de Firebase
        async function ejecutarPruebasFirebase() {
            agregarLog('log-firebase', 'üöÄ Iniciando pruebas completas de Firebase...');
            actualizarProgreso(0);
            
            await verificarConexion();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await probarEscritura();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await probarLectura();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            actualizarProgreso(100);
            agregarLog('log-firebase', '‚úÖ Pruebas de Firebase completadas');
        }

        // Probar LocalStorage
        function probarLocalStorage() {
            agregarLog('log-local', 'üíæ Probando LocalStorage...');
            
            try {
                const datosTest = {
                    timestamp: new Date(),
                    mensaje: 'Prueba de LocalStorage',
                    numeros: [1, 2, 3, 4, 5]
                };
                
                localStorage.setItem('diagnostico-test', JSON.stringify(datosTest));
                agregarLog('log-local', '‚úÖ Datos escritos en LocalStorage');
                
                const datosLeidos = JSON.parse(localStorage.getItem('diagnostico-test'));
                agregarLog('log-local', '‚úÖ Datos le√≠dos desde LocalStorage');
                
                localStorage.removeItem('diagnostico-test');
                agregarLog('log-local', 'üßπ Datos de prueba eliminados');
                
                diagnosticoCompleto.localStorage.funcional = true;
                
            } catch (error) {
                agregarLog('log-local', '‚ùå Error en LocalStorage: ' + error.message);
                diagnosticoCompleto.localStorage.funcional = false;
            }
        }

        // Limpiar LocalStorage
        function limpiarLocalStorage() {
            agregarLog('log-local', 'üóëÔ∏è Limpiando LocalStorage...');
            
            try {
                const keys = Object.keys(localStorage);
                let eliminados = 0;
                
                keys.forEach(key => {
                    if (key.startsWith('diagnostico-') || key.startsWith('test-')) {
                        localStorage.removeItem(key);
                        eliminados++;
                    }
                });
                
                agregarLog('log-local', `‚úÖ ${eliminados} elementos de prueba eliminados`);
                
            } catch (error) {
                agregarLog('log-local', '‚ùå Error limpiando LocalStorage: ' + error.message);
            }
        }

        // Verificar conexi√≥n a internet
        function verificarInternet() {
            agregarLog('log-network', 'üåê Verificando conectividad...');
            
            const online = navigator.onLine;
            diagnosticoCompleto.network.online = online;
            
            if (online) {
                agregarLog('log-network', '‚úÖ Conexi√≥n a internet disponible');
            } else {
                agregarLog('log-network', '‚ùå Sin conexi√≥n a internet');
            }
            
            // Probar conexi√≥n a servicios externos
            fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' })
                .then(() => {
                    agregarLog('log-network', '‚úÖ Conexi√≥n a servicios externos funcionando');
                    diagnosticoCompleto.network.externos = true;
                })
                .catch(() => {
                    agregarLog('log-network', '‚ö†Ô∏è Problemas con servicios externos');
                    diagnosticoCompleto.network.externos = false;
                });
        }

        // Probar APIs
        function probarAPIs() {
            agregarLog('log-network', 'üîó Probando APIs...');
            
            // Probar Firebase
            if (typeof firebase !== 'undefined') {
                agregarLog('log-network', '‚úÖ API de Firebase disponible');
                diagnosticoCompleto.network.firebaseAPI = true;
            } else {
                agregarLog('log-network', '‚ùå API de Firebase no disponible');
                diagnosticoCompleto.network.firebaseAPI = false;
            }
            
            // Probar SweetAlert2
            if (typeof Swal !== 'undefined') {
                agregarLog('log-network', '‚úÖ API de SweetAlert2 disponible');
                diagnosticoCompleto.network.sweetAlertAPI = true;
            } else {
                agregarLog('log-network', '‚ùå API de SweetAlert2 no disponible');
                diagnosticoCompleto.network.sweetAlertAPI = false;
            }
            
            // Probar SheetJS
            if (typeof XLSX !== 'undefined') {
                agregarLog('log-network', '‚úÖ API de SheetJS disponible');
                diagnosticoCompleto.network.sheetJSAPI = true;
            } else {
                agregarLog('log-network', '‚ùå API de SheetJS no disponible');
                diagnosticoCompleto.network.sheetJSAPI = false;
            }
        }

        // Generar reporte completo
        function generarReporteCompleto() {
            agregarLog('log-firebase', 'üìä Generando reporte completo...');
            
            diagnosticoCompleto.timestamp = new Date();
            
            const reporte = `
DIAGN√ìSTICO COMPLETO DEL SISTEMA PAE DIGITAL
============================================

Fecha y hora: ${diagnosticoCompleto.timestamp.toLocaleString()}

üî• FIREBASE:
- SDK Cargado: ${diagnosticoCompleto.firebase.sdkCargado ? '‚úÖ S√≠' : '‚ùå No'}
- Conectado: ${diagnosticoCompleto.firebase.conectado ? '‚úÖ S√≠' : '‚ùå No'}
- Escritura: ${diagnosticoCompleto.firebase.escritura ? '‚úÖ Funciona' : '‚ùå Fall√≥'}
- Lectura: ${diagnosticoCompleto.firebase.lectura ? '‚úÖ Funciona' : '‚ùå Fall√≥'}

üíæ LOCALSTORAGE:
- Disponible: ${diagnosticoCompleto.localStorage.disponible ? '‚úÖ S√≠' : '‚ùå No'}
- Funcional: ${diagnosticoCompleto.localStorage.funcional ? '‚úÖ S√≠' : '‚ùå No'}

üåê RED:
- Conexi√≥n Internet: ${diagnosticoCompleto.network.online ? '‚úÖ S√≠' : '‚ùå No'}
- Servicios Externos: ${diagnosticoCompleto.network.externos ? '‚úÖ Funcionan' : '‚ùå Fallan'}
- API Firebase: ${diagnosticoCompleto.network.firebaseAPI ? '‚úÖ Disponible' : '‚ùå No disponible'}
- API SweetAlert2: ${diagnosticoCompleto.network.sweetAlertAPI ? '‚úÖ Disponible' : '‚ùå No disponible'}
- API SheetJS: ${diagnosticoCompleto.network.sheetJSAPI ? '‚úÖ Disponible' : '‚ùå No disponible'}

üìã RESUMEN:
${generarResumenDiagnostico()}
            `;
            
            document.getElementById('reporte-contenido').textContent = reporte;
            agregarLog('log-firebase', '‚úÖ Reporte generado correctamente');
        }

        // Generar resumen del diagn√≥stico
        function generarResumenDiagnostico() {
            const totalPruebas = 8;
            let pruebasExitosas = 0;
            
            if (diagnosticoCompleto.firebase.sdkCargado) pruebasExitosas++;
            if (diagnosticoCompleto.firebase.conectado) pruebasExitosas++;
            if (diagnosticoCompleto.localStorage.disponible) pruebasExitosas++;
            if (diagnosticoCompleto.localStorage.funcional) pruebasExitosas++;
            if (diagnosticoCompleto.network.online) pruebasExitosas++;
            if (diagnosticoCompleto.network.firebaseAPI) pruebasExitosas++;
            if (diagnosticoCompleto.network.sweetAlertAPI) pruebasExitosas++;
            if (diagnosticoCompleto.network.sheetJSAPI) pruebasExitosas++;
            
            const porcentaje = Math.round((pruebasExitosas / totalPruebas) * 100);
            
            return `
Estado general: ${porcentaje}% (${pruebasExitosas}/${totalPruebas} pruebas exitosas)

${porcentaje >= 80 ? 'üü¢ SISTEMA FUNCIONANDO CORRECTAMENTE' : 
  porcentaje >= 60 ? 'üü° SISTEMA CON PROBLEMAS MENORES' : 
  'üî¥ SISTEMA CON PROBLEMAS CR√çTICOS'}
            `;
        }

        // Exportar diagn√≥stico
        function exportarDiagnostico() {
            const reporte = document.getElementById('reporte-contenido').textContent;
            const blob = new Blob([reporte], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostico-pae-digital-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            agregarLog('log-firebase', 'üíæ Diagn√≥stico exportado correctamente');
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(verificarEstadoInicial, 1000);
        });
    </script>
</body>
</html>
